<!doctype html>
<notebook theme="air">
  <title>IndieWeb Login For Firebase</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# IndieWeb Login For Firebase

    #### Or how I used an IndieAuth Server as a Custom Token Provider


    IndieAuth is a better way to do login, as the identities are under user control and portable across silos.

    In this notebook is demonstrated how the tokens issued by [@endpointservices/auth](https://observablehq.com/@endpointservices/auth) can be used as custom tokens for the FirebaseSDK. Note this is a property of that Server and not IndieAuth in general, but it does highlight IndieAuth tokens and Firebase Custom tokens can coexist in the same token.

    ~~~js
        import {weblogin, user} from '@endpointservices/weblogin-for-firebase'
    ~~~

    `
  </script>
  <script id="110" type="application/vnd.observable.javascript">
    md` ## Setup Oauth 2.0 client

    IndieAuth is an Oauth 2.0 endpoint, so we need to setup an Oauth 2.0 client first`
  </script>
  <script id="67" type="application/vnd.observable.javascript">
    AUTHORIZE_URL = "https://webcode.run/observablehq.com/@endpointservices/auth;authorization_endpoint"
  </script>
  <script id="71" type="application/vnd.observable.javascript">
    TOKEN_URL = "https://webcode.run/observablehq.com/@endpointservices/auth;token_endpoint"
  </script>
  <script id="65" type="application/vnd.observable.javascript">
    CLIENT_ID = html`<a href>`.href.split("?")[0]
  </script>
  <script id="81" type="application/vnd.observable.javascript">
    SCOPE = 'observablehq.com'
  </script>
  <script id="78" type="application/vnd.observable.javascript">
    TOKEN_PARAMS = args => ({
      client_id: args.CLIENT_ID,
      redirect_uri: args.REDIRECT_URI,
      code: args.code,
      state: args.state
    })
  </script>
  <script id="63" type="application/vnd.observable.javascript" pinned="">
    import { authorize_link, state } with {
      CLIENT_ID,
      CLIENT_ID as REDIRECT_URI,
      AUTHORIZE_URL,
      TOKEN_URL,
      TOKEN_PARAMS
    } from '@tomlarkworthy/oauth'
  </script>
  <script id="115" type="application/vnd.observable.javascript">
    md`## Create a login form

    Note state etc are driven by Oauth 2.0 client
    `
  </script>
  <script id="28" type="application/vnd.observable.javascript">
    weblogin = { 
      exchange // Ensure state machine runs
      // Protection against click jacking
      const url = htl.html`<a href>`.href;
      if (
        !url.startsWith("https://observablehq.com") &&
        !url.startsWith("https://next.observablehq.com")
      ) {
        throw new Error("Login form is not allowed to be embedded");
      }
      const ui = htl.html`<div>
        <span style="float: left;padding-right: 10px;">
          <a href="https://observablehq.com/collection/@endpointservices/services">
          ${logo("70px")}
          </a>
        </span>
        <h3> <a href="https://indieweb.org/Why_web_sign-in"> Web Sign-in</a> </h3>
        ${userWithNull ? htl.html`
        <div>
          You are signed in as <a href="${userWithNull.uid}">${userWithNull.uid}</a>
        </div>
        <div>
          <button onclick=${() => {
            state.access_token = undefined; // Prevents immediately signing in by token exchange logic
            firebase.auth().signOut();
          }
          }>
            signout
          </button>
        </div>
          ` : htl.html`
        <form action="${authorize_link}" method="get">
          <label for="url">Identity URL:</label>
          <input id="url" type="text" name="me" placeholder="https://example.com/me" />
          <p><button type="submit">Sign In</button></p>
          <input type="hidden" name="client_id" value="${CLIENT_ID}" />
          <input type="hidden" name="redirect_uri" value="${CLIENT_ID}" />
          <input type="hidden" name="state" value="${state.state}" />
          <input type="hidden" name="scope" value="${SCOPE}" />
        </form>
        <small><details>
          <summary>Help</summary>
          <p>Weblogin uses <a href="https://indieweb.org/IndieAuth">IndieAuth</a>/<a href="https://indieweb.org/RelMeAuth">Relmeauth</a> to log you in using data scraped from your homepage URL. 
          <p>To get setup as fast as possible checkout the <a href="https://observablehq.com/@endpointservices/login-wizard">Weblogin wizard</a>.
        </details></small>
        `
        }
      </div>`;
      ui.value = userWithNull || invalidation
      return ui;
    }
  </script>
  <script id="190" type="application/vnd.observable.javascript">
    md`## Listen to Firebase auth state changes`
  </script>
  <script id="233" type="application/vnd.observable.javascript" pinned="">
    userWithNull = Generators.queue(next => {
      firebase.auth().onAuthStateChanged(auth => {
        console.log("Auth state changed", auth)
        next(auth)
      })
    })
  </script>
  <script id="244" type="application/vnd.observable.javascript" pinned="">
    user = {
      return userWithNull ? userWithNull : invalidation
    }
  </script>
  <script id="119" type="application/vnd.observable.javascript">
    md`## Exchange indie auth token for Firebase session

    *When* we have an access token for a different uid, *exchange for firebase identity*

    We need to rely on Firebase auth's own caching of token info where possible, as it has its own refresh token etc. with a much longer expiry than IndieAuth tokens. 

    `
  </script>
  <script id="263" type="application/vnd.observable.javascript">
    state
  </script>
  <script id="172" type="application/vnd.observable.javascript" pinned="">
    decoded = state && state.access_token ? JSON.parse(atob(state.access_token.split('.')[1])): undefined
  </script>
  <script id="148" type="application/vnd.observable.javascript" pinned="">
    exchange = {
      if (state && state.access_token && (
          decoded.uid !== userWithNull?.uid || hasNewClaims(decoded.claims, currentClaims)
        )) {
        console.log("Using access_token for Firebase signin")
        firebase.auth().signInWithCustomToken(state.access_token)
      }
    }
  </script>
  <script id="301" type="application/vnd.observable.javascript" pinned="">
    function hasNewClaims(newClaims, oldClaims) {
      return Object.keys(newClaims || {}).some(newClaim => {
        if (!oldClaims[newClaim]) return true
        if (!deepEqual(newClaims[newClaim], oldClaims[newClaim])) return true
      })
    }
  </script>
  <script id="307" type="application/vnd.observable.javascript" pinned="">
    // https://stackoverflow.com/a/38416465/862295 Thanks Frank Tan!
    function deepEqual(a,b)
    {
      if( (typeof a == 'object' && a != null) &&
          (typeof b == 'object' && b != null) ) {
         var count = [0,0];
         for( var key in a) count[0]++;
         for( var key in b) count[1]++;
         if ( count[0]-count[1] != 0) {return false;}
         for( var key in a) {
           if (!(key in b) || !deepEqual(a[key],b[key])) {return false;}
         }
         for( var key in b) {
           if (!(key in a) || !deepEqual(b[key],a[key])) {return false;}
         }
         return true;
      } else {
         return a === b;
      }
    }
  </script>
  <script id="294" type="application/vnd.observable.javascript" pinned="">
    currentClaims = userWithNull ? JSON.parse(atob((await userWithNull.getIdToken()).split(".")[1]))
          : {}
  </script>
  <script id="288" type="application/vnd.observable.javascript" pinned="">
    user
  </script>
  <script id="13" type="application/vnd.observable.javascript">
    import { firebase } with { firebaseConfig } from '@tomlarkworthy/firebase'
  </script>
  <script id="16" type="application/vnd.observable.javascript">
    firebaseConfig = ({
      apiKey: "AIzaSyBquSsEgQnG_rHyasUA95xHN5INnvnh3gc",
      authDomain: "endpointserviceusers.firebaseapp.com",
      projectId: "endpointserviceusers",
      appId: "1:283622646315:web:baa488124636283783006e"
    }) 
  </script>
  <script id="388" type="application/vnd.observable.javascript">
    import {logo} from '@endpointservices/logo'
  </script>
  <script id="447" type="application/vnd.observable.javascript">
    import { footer } from "@endpointservices/footer-with-backups"
  </script>
  <script id="451" type="application/vnd.observable.javascript">
    footer
  </script>
</notebook>
