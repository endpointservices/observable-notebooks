<!doctype html>
<notebook theme="air">
  <title>Schedule Regular Tasks with Cron</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# Schedule Regular Tasks with Cron

    ![](${await FileAttachment("Cron.png").url()})

    Cron will call a URL regularly. To create a regular task call _createCron_.

    `
  </script>
  <script id="335" type="application/vnd.observable.javascript">
    signature(createCron)
  </script>
  <script id="26" type="application/vnd.observable.javascript">
    async function createCron({
      name = "default", // Unique name needed per cron per notebook
      enabled = true, // Fastest way to disable a cron is to set enabled = false
      schedule = "0 0 1 * *", // UNIX cron format (https://man7.org/linux/man-pages/man5/crontab.5.html)
      location = "europe-west1",
      timezone = "UTC",
      url, // E.g. 'https://example.com'
      method = "POST",
      body = ""
    } = {}) {
      const proposedConfig = {
        name,
        enabled,
        schedule,
        timezone,
        location,
        url,
        method,
        body
      };
      let error = undefined;
      let updating = false;

      // We create a HTTP endpoint to serve our desired configuration.
      const cron_config = deploy(
        "public cron config " + name,
        (req, res) => res.json(proposedConfig),
        { modifiers: ["terminal"] }
      );

      let render = async () => {
        const currentConfig = (
          await firebase
            .firestore()
            .doc(configPath(subdomain(), notebook(), name))
            .get()
        ).data();
        return html`
          ${error ? html`<p style="color:red">${error}</p>` : null}
          ${Table(
            [
              { "": "current", ...currentConfig },
              { "": "desired", ...proposedConfig }
            ],
            {
              width: "auto",
              columns: [
                "",
                "name",
                "enabled",
                "schedule",
                "timezone",
                "url",
                "method",
                "body",
                "location"
              ]
            }
          )}
          ${
            updating
              ? html`<button class="update-btn" disabled> updating...</button>`
              : html`<button class="update-btn" onclick=${() =>
                  updateClick()}>Update</button>`
          }
        `;
      };

      let ui = await render();
      let updateClick = async () => {
        updating = true;
        ui = reconcile(ui, await render());
        try {
          error = await update(proposedConfig);
        } catch (err) {
          error = err.message;
        }
        updating = false;
        ui = reconcile(ui, await render());
      };

      return ui;
    }
  </script>
  <script id="344" type="application/vnd.observable.javascript">
    md`
    This will return a UI which will tell you the current state of the named cron job, and a button to update the latest version. Cron is configured like infrastructure-as-code, you need to *publish* the notebook containing configuration before you can _update_.
    `
  </script>
  <script id="62" type="application/vnd.observable.javascript" pinned="">
    example = createCron({
      schedule: '5 2 * * *', // Daily, at 2a.m.
      url: "https://observablehq.com/@endpointservices/cron"
    })
  </script>
  <script id="350" type="application/vnd.observable.javascript">
    md`

    The strange way schedules are expressed is an oddity due to historical reasons. There are plenty of resources on the web to help you figure out the correct expression, for example [crontab.guru](https://crontab.guru/examples.html). Don't feel bad, I look them up all the time too! The good thing is that they can model stuff like _"do something every hour but only during office hours"_ which is very useful to alert you of faults but not in the middle of the night.

    The API that actually creates the Job can be found in [https://observablehq.com/@endpointservices/cron-backend](https://observablehq.com/@endpointservices/cron-backend)
    `
  </script>
  <script id="151" type="application/vnd.observable.javascript">
    configPath = (subdomain, notebook, name) =>
      `services/cron/subdomains/${subdomain}/notebooks/${notebook}/crons/${name}`

  </script>
  <script id="358" type="application/vnd.observable.javascript">
    md`### Update calls [@endpointservices/cron-backend](https://observablehq.com/@endpointservices/cron-backend)`
  </script>
  <script id="112" type="application/vnd.observable.javascript">
    async function update(config) {
      const response = await fetch(
        "https://webcode.run/observablehq.com/@endpointservices/cron-backend;update_cron",
        {
          method: "PUT",
          body: JSON.stringify({
            notebook: notebook(),
            subdomain: subdomain(),
            expected: config
          })
        }
      );
      if (response.status != 200) {
        return await response.text();
      }
    }
  </script>
  <script id="36" type="application/vnd.observable.javascript">
    import {firebase, subdomain, notebook} from '@endpointservices/utils'
  </script>
  <script id="320" type="application/vnd.observable.javascript">
    import {deploy} from '@endpointservices/serverless-cells'
  </script>
  <script id="89" type="application/vnd.observable.javascript">
    import {html} from '@observablehq/htl'
  </script>
  <script id="188" type="application/vnd.observable.javascript">
    import {reconcile} from '@tomlarkworthy/reconcile-nanomorph'
  </script>
  <script id="212" type="application/vnd.observable.javascript">
    import {Table} from "@observablehq/inputs"
  </script>
  <script id="236" type="application/vnd.observable.javascript">
    import {_} from '@mbostock/hello-lodash-fp'
  </script>
  <script id="331" type="application/vnd.observable.javascript">
    import {signature} from '@mootari/signature'
  </script>
  <script id="404" type="application/vnd.observable.javascript">
    import { footer } from "@endpointservices/footer-with-backups"
  </script>
  <script id="408" type="application/vnd.observable.javascript">
    footer
  </script>
</notebook>
