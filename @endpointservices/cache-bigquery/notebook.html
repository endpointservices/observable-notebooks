<!doctype html>
<notebook theme="air">
  <title>How to cache BigQuery results in a public Notebook with Firebase Storage or a Cloud Bucket</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# How to cache BigQuery results in a public Notebook with Firebase Storage or a Cloud Bucket

    <img width="600" src="${await FileAttachment("BQCache.png").url()}"> </img>

    BigQuery is powerful, but expensive if misused, so you never want to grant BigQuery API access to the public. For dataviz, a cache of BigQuery data is preferred. But in the ObservableHQ world, we want to be transparent about how we prepared our cache. Ideally we would like to show our BigQuery commands, but not allow them to be run. 

    In this notebook I explore a workflow for allowing data to be refreshed right in the browser, from BigQuery, securely, if the correct password is presented. So viewers can see the production commands, but not execute them. It also makes it trivial for the Notebook maintainer to update caches, as it can all be done within the Observable environment. Furthermore, while viewers can read the cache, they are prevented from writing to it.

    ## Background

    A Google service account can both

    1. Read from BigQuery
    2. Log into Firebase clientside and use clientside services like Firebase Storage

    Firebase Storage can be configured to _allow public read access_ and grant _write access to a single user_ (e.g. our service account).

    Service accounts should be kept secret, but we can use encryption to hide one in a [public notebook behind a password](https://observablehq.com/@endpointservices/notebook-secret).

    Putting all of this together, we can hide a service account in a notebook, and password protect the ability to use it to update the cache.

    `
  </script>
  <script id="14" type="application/vnd.observable.javascript">
    md`## Create a service account

    - *Create a service account* in the GCP console [here](https://console.cloud.google.com/iam-admin/serviceaccounts).
    - Grant the service account the _BigQuery User_ role.
    - Create a JSON key which will download a file like _"larkworthy-dfb11-1e804d36fdda.json"_
    `
  </script>
  <script id="26" type="application/vnd.observable.javascript">
    md`## Encrypt service account credentials

    - Open the contents of the key file
    - Copy the content of the "secret" portion of the [encyption notebook](https://observablehq.com/@endpointservices/notebook-secret) and set a [strong password](https://passwordsgenerator.net/)
    - Copy the encypted payload out and save in your target notebook.

    Here is what mine look like:-
    `
  </script>
  <script id="32" type="application/vnd.observable.javascript" pinned="">
    encrypted_service_account_credentials = ({
      name: "AES-GCM",
      salt: "x4gEPgJOp9brBg==",
      iv: "Hwoo2XyMFSJT5FLq",
      ciphertext:
        "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"
    })
  </script>
  <script id="47" type="application/vnd.observable.javascript">
    md`## Import a UI to decrypt the service account`
  </script>
  <script id="52" type="application/vnd.observable.javascript">
    import { decrypt } from '@endpointservices/notebook-secret'
  </script>
  <script id="54" type="application/vnd.observable.javascript" pinned="">
    viewof service_account_credentials = decrypt(
      encrypted_service_account_credentials
    )
  </script>
  <script id="57" type="application/vnd.observable.javascript">
    md`Check it works by reading out its result. This will only resolve it you enter a valid password.`
  </script>
  <script id="58" type="application/vnd.observable.javascript" pinned="">
    service_account_credentials
  </script>
  <script id="64" type="application/vnd.observable.javascript">
    md`## Create a Google API client targeting BigQuery and login with service account

    - Use the [Google API client](https://observablehq.com/@tomlarkworthy/gapi) notebook and a copy of your creds to figure out how to instantiate a GAPI client in its Playground
    - You will need to generate an API key at https://console.cloud.google.com/apis/credentials
    - You can instantiate a GAPI client direct from unencrypted service account credentials using the "service_account_key" parameter
    - Lookup the discovery doc. For BigQuery this is "https://bigquery.googleapis.com/discovery/v1/apis/bigquery/v2/rest"
    - Do keep an eye on the devtools console and network output tab, it can help diagnose setup issues

    With the API key, the unencrypted service account, and a discovery doc URL, you should be able to use the Playground UI feature to instantiate a client and check it works clientside without disclosing your service account. 

    My working one looked like 

    ![](${await FileAttachment("image.png").url()})

    `
  </script>
  <script id="85" type="application/vnd.observable.javascript">
    md`Once it works in that notebook we can bring it over to our target notebook`
  </script>
  <script id="82" type="application/vnd.observable.javascript" pinned="">
    gapi_config = ({
      apiKey: "AIzaSyC-Uh-7CtBwhlZrXvAr1gmnUaZzixeVG84",
      discoveryDocs: [
        "https://bigquery.googleapis.com/discovery/v1/apis/bigquery/v2/rest"
      ],
      service_account_key: JSON.parse(service_account_credentials)
    })
  </script>
  <script id="88" type="application/vnd.observable.javascript">
    import { createGapi } from '@tomlarkworthy/gapi'
  </script>
  <script id="89" type="application/vnd.observable.javascript" pinned="">
    bqClient = await createGapi(gapi_config)
  </script>
  <script id="98" type="application/vnd.observable.javascript">
    md`Now we have a working client with autocomplete (press TAB). We can use the [REST API](https://cloud.google.com/bigquery/docs/reference/rest/) documentation to figure out how to execute a query.

    Simplest for BigQuery is creating a synchronous query job https://cloud.google.com/bigquery/docs/reference/rest/v2/jobs/query
    `
  </script>
  <script id="104" type="application/vnd.observable.javascript" pinned="">
    bqResponse = bqClient.bigquery.jobs.query({
      projectId: "larkworthy-dfb11",
      resource: {
        // See https://cloud.google.com/bigquery/docs/reference/rest/v2/jobs/query#QueryRequest
        query:
          "SELECT title FROM [bigquery-public-data:hacker_news.stories] WHERE title != 'Placeholder' LIMIT 20",
        useLegacySql: true
      }
    })
  </script>
  <script id="134" type="application/vnd.observable.javascript">
    md`## Tidy results`
  </script>
  <script id="116" type="application/vnd.observable.javascript">
    import { Table } from '@observablehq/inputs'
  </script>
  <script id="137" type="application/vnd.observable.javascript" pinned="">
    data = bqResponse.result.rows.map(col => col.f[0])
  </script>
  <script id="120" type="application/vnd.observable.javascript" pinned="">
    Table(data)
  </script>
  <script id="142" type="application/vnd.observable.javascript">
    md`So its the "data" blog we wish to cache. We can also use a service account as an identity to log into Firebase`
  </script>
  <script id="146" type="application/vnd.observable.javascript">
    md`## Log into Firebase clientside using a Service Account`
  </script>
  <script id="155" type="application/vnd.observable.javascript">
    md`Add Firebase to your Cloud project, then grab its web config from a URL like https://console.firebase.google.com/u/0/project/larkworthy-dfb11/settings/general/web`
  </script>
  <script id="149" type="application/vnd.observable.javascript" pinned="">
    firebaseConfig = ({
      // I don't configure everything, we jsut want Auth and storage for this notebook
      apiKey: "AIzaSyBN4bxw6d0cM0CGPNzRrkRlBqwFQnPLdN4",
      authDomain: "larkworthy-dfb11.firebaseapp.com",
      projectId: "larkworthy-dfb11",
      appId: "1:786910701676:web:8d7dd002acf3b78c74d049",
      storageBucket: "larkworthy-dfb11.appspot.com"
    })
  </script>
  <script id="168" type="application/vnd.observable.javascript">
    md`Instantiate Firebase SDK with custom config AND Firebase admin for service account login`
  </script>
  <script id="153" type="application/vnd.observable.javascript" pinned="">
    import { firebase } with { firebaseConfig } from '@tomlarkworthy/firebase'
  </script>
  <script id="172" type="application/vnd.observable.javascript" pinned="">
    import {
      getAccessTokenFromServiceAccount,
      signinWithAccessToken
    } from '@tomlarkworthy/firebase-admin'
  </script>
  <script id="190" type="application/vnd.observable.javascript">
    md`Now we can login using a service account identity. This is using a service account like a regular user on the internet. So in order to give them special privileges in Firebase Security Rules, we need to discover their uid.`
  </script>
  <script id="181" type="application/vnd.observable.javascript" pinned="">
    service_account_user = {
      const token = await getAccessTokenFromServiceAccount(
        service_account_credentials
      );
      await signinWithAccessToken(firebase, token);
      return firebase.auth().currentUser;
    }
  </script>
  <script id="195" type="application/vnd.observable.javascript">
    md`Print their uid for use with rules`
  </script>
  <script id="192" type="application/vnd.observable.javascript" pinned="">
    service_account_user.uid
  </script>
  <script id="198" type="application/vnd.observable.javascript">
    md`## Give the service account user write permission to Firebase Storage

    Setup rules for the storage bucket at a URL like https://console.firebase.google.com/u/0/project/larkworthy-dfb11/storage/larkworthy-dfb11.appspot.com/rules

    I want public read access, but only the service account can make writes. So using the _uid_ from the step before, my rules look like

    ![](${await FileAttachment("image@2.png").url()})
    `
  </script>
  <script id="207" type="application/vnd.observable.javascript">
    md`## Write BigQuery results to Firebase Storage

    The cool thing with Observable dataflow is the following code will execute automatically when the correct password is entered! 
    `
  </script>
  <script id="214" type="application/vnd.observable.javascript" pinned="">
    {
      service_account_user; // Make sure this cell depends on the service_account_user logging in

      // See https://medium.com/@dorathedev/uploading-json-objects-as-json-files-to-firebase-storage-without-having-or-creating-a-json-file-38ad323af3c4
      // convert your object into a JSON-string
      const string = JSON.stringify(data);
      // create a Blob from the JSON-string
      const blob = new Blob([string], { type: "application/json" });

      // create a reference to the storage
      var ref = firebase.storage().ref("/examples/cache-bigquery/data.json");
      // upload you blob into the storage
      return ref.put(blob);
    }
  </script>
  <script id="290" type="application/vnd.observable.javascript">
    md`## Alernatively: Write BigQuery directly to Google Cloud Storage Bucket

    We are able to mint *access_tokens* from a Service Account, so we can go directly to a bucket too. This avoids a Firebase dependancy.

    We need the *access_token* in a vanilla HTTP PUT request, and the service account needs write permissions to the bucket.  (Storage Object Creator role to write once, or Legacy Bucket Owner to update)

    ![](${await FileAttachment("image@3.png").url()})
    `
  </script>
  <script id="305" type="application/vnd.observable.javascript" pinned="">
    // Use the "authenticated url" as the REST API
    uploadToBucket = {
      return (await fetch(`https://www.googleapis.com/upload/storage/v1/b/larkworthy-dfb11.appspot.com/o?name=examples/cache-bigquery/dataalt.json`, {
        headers: {
          'Authorization': `Bearer ${await getAccessTokenFromServiceAccount(service_account_credentials)}`
        },
        method: "POST",
        body: JSON.stringify(data)
      })).text() 

    }
  </script>
  <script id="317" type="application/vnd.observable.javascript" pinned="">
    import {fetchp} from '@tomlarkworthy/fetchp'
  </script>
  <script id="222" type="application/vnd.observable.javascript">
    md`## Read the cache

    By default CORS is not enabled for the Firebase bucket. 

    - Enable CORS for the bucket (see [docs](https://firebase.google.com/docs/storage/web/download-files#cors_configuration))
      - It's a bit annoying having to install _gsutils_ locally. You can also use [Cloud Shell](gsutil cors set cors.json gs://larkworthy-dfb11.appspot.com) which will do the authentication with _gsutils_ right in the browser and tidy up after itself.
    `
  </script>
  <script id="225" type="application/vnd.observable.javascript" pinned="">
    cached_data_ref = firebase
      .storage()
      .ref()
      .child("/examples/cache-bigquery/data.json")
  </script>
  <script id="231" type="application/vnd.observable.javascript" pinned="">
    cached_data = (await fetch(await cached_data_ref.getDownloadURL())).json()
  </script>
  <script id="252" type="application/vnd.observable.javascript">
    md`Note we can display this data even without authenticating with Firebase!!! You could of course put the reading of Firebase data in a different notebook too`
  </script>
  <script id="255" type="application/vnd.observable.javascript" pinned="">
    Table(cached_data)
  </script>
  <script id="351" type="application/vnd.observable.javascript">
    import { footer } from "@endpointservices/footer-with-backups"
  </script>
  <script id="355" type="application/vnd.observable.javascript">
    footer
  </script>
</notebook>
