<!doctype html>
<notebook theme="air">
  <title>urlQueryFieldView: Non-invasive URL field persistence</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# urlQueryFieldView: Non-invasive URL field persistence`
  </script>
  <script id="14" type="application/vnd.observable.javascript">
    md`Lets make it simple to bind a URL query field to a UI control (e.g. [@observablehq/inputs](/@observablehq/inputs))

    We exploit back-writability and input binding to avoid having to mess with existing UI control code.

    _urlQueryFieldView(field)_ creates a URL decoded view of the field in the URL query string. Because it's a view it can be [_synchronized_](https://observablehq.com/@observablehq/synchronized-inputs) to any control we want to provide persistence for.

    If you want all users to share a networked value, consider [shareview](https://observablehq.com/@tomlarkworthy/shareview).

    This works with an view that follows [design guidelines for views](https://observablehq.com/@tomlarkworthy/ui-linter?collection=@tomlarkworthy/ui). A similar notebook that uses local storageis the [localStorageView](https://observablehq.com/@tomlarkworthy/local-storage-view).

    ~~~js
        import {urlQueryFieldView} from '@tomlarkworthy/url-query-field-view'
    ~~~

    `
  </script>
  <script id="37" type="application/vnd.observable.javascript">
    urlQueryFieldView = (
      field,
      {
        defaultValue = undefined,
        decode = (field) => field,
        write = false,
        hash = undefined,
        bindTo = undefined
      } = {}
    ) => {
      if (typeof decode !== "function")
        throw new Error("decode must be a function");

      const id = DOM.uid().id;

      const readField = () => {
        const v =
          new URLSearchParams(
            /*allow overriding */ window.rEPseDFzXFSPYkNz || location.search
          ).get(field) || undefined;
        return v ? decode(v) : defaultValue;
      };

      let cache = readField();

      const ui = htl.html`<div class="observablehq--inspect" style="display:flex">
        <code>urlQueryFieldView(<span class="observablehq--string">"${field}"</span>): </code><span id="${id}">${inspect(
        cache
      )}</span>
      </div>`;
      const holder = ui.querySelector(`#${id}`);

      const view = Object.defineProperty(ui, "value", {
        get: () => {
          return cache;
        },
        set: (value) => {
          const search = new URLSearchParams(location.search);
          search.set(field, value);
          cache = value;
          if (write) {
            if (!hash.startsWith("#")) hash = "#" + hash;
            html`<a href="?${
              search.toString() + (hash || location.hash)
            }">`.click();
          }
        },
        enumerable: true
      });

      if (bindTo) {
        Inputs.bind(bindTo, view);
      }

      return view;
    }
  </script>
  <script id="136" type="application/vnd.observable.javascript">
    md`## Examples`
  </script>
  <script id="326" type="text/markdown">
    We can bind to a UI component inline with instanciating it with

    `Inputs.bind(<CONTROL>, urlQueryFieldView(<FIELD>))`
  </script>
  <script id="18" type="application/vnd.observable.javascript" pinned="">
    viewof c1 = Inputs.bind(Inputs.text({ label: "c1" }), urlQueryFieldView("c1"))
  </script>
  <script id="477" type="application/vnd.observable.javascript" pinned="">
    c1
  </script>
  <script id="337" type="text/markdown">
    Or we can bind in an adjacent cells with

    `Inputs.bind(viewof <CELL>, urlQueryFieldView(<FIELD>));`
  </script>
  <script id="339" type="application/vnd.observable.javascript">
    viewof c2 = Inputs.text({ label: "c2" })
  </script>
  <script id="343" type="application/vnd.observable.javascript" pinned="">
    c2sideBind = {
      Inputs.bind(viewof c2, urlQueryFieldView("c2"));
    }
  </script>
  <script id="357" type="text/markdown">
    ### Links

    To demonstrate it works just follow this links which updated the URL


    set [c1=foo](?c1=foo#c1)

    set [c2=nice](?c2=nice#c2)


    set [c1=bar&c2=nice](?c1=bar&c2=nice#c1)

  </script>
  <script id="139" type="text/markdown">
    Tada! note the UI controls update based on the URL, if you know the name of the cells you can also set the URL hash to get the page to navigate after the load too
  </script>
  <script id="220" type="text/markdown">
    ### Custom decode

    The second argument is the *options*, which includes "decode". Here you can apply a function to the value so you can decode to types other than strings. Note all params have `decodeURIComponent` applied first


    try clicking [json=[{t:0, c: red}]](?json=${encodeURIComponent(JSON.stringify({t:0, c: "red"}))}#json)
  </script>
  <script id="244" type="application/vnd.observable.javascript" pinned="">
    viewof json = urlQueryFieldView("json", { decode: JSON.parse })
  </script>
  <script id="379" type="application/vnd.observable.javascript" pinned="">
    json
  </script>
  <script id="185" type="text/markdown">
    ## Back-writing

    The view supports backwriting, which will cause a navigation event. As this is intrusive and not often required, it is turned off by default. To enable it, set the option `write` to `true`. This will do a top level navigation via link automation, so it will only works if the user initiates the action. It keeps unrelated fields and the URL hash unchanged.

    By adding a `hash` parameter you can also control the URL hash
  </script>
  <script id="183" type="application/vnd.observable.javascript" pinned="">
    viewof c3 = Inputs.bind(
      Inputs.text({
        label: "c3",
        submit: true,
        placeholder: "try something"
      }),
      urlQueryFieldView("c3", { write: true, hash: "c3" })
    )
  </script>
  <script id="51" type="application/vnd.observable.javascript">
    import { inspect } from "@observablehq/inspector"
  </script>
  <script id="214" type="application/vnd.observable.javascript">
    import { footer } from "@endpointservices/endpoint-services-footer"
  </script>
  <script id="216" type="application/vnd.observable.javascript">
    footer
  </script>
</notebook>
