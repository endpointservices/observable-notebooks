<!doctype html>
<notebook theme="air">
  <title>Chat application with Firebase on Observable (Twitch)</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# Chat application with Firebase on Observable (Twitch)

    This is the notebook I used when doing an Observable Twitch stream! None of this will work unless you signin at the bottom because we added security :) However, I had added the option to signin in anonymously so you don't need to give up your email address.

    <iframe width="560" height="315" src="https://www.youtube.com/embed/Fo3JTKp3CFU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

    `
  </script>
  <script id="3" type="application/vnd.observable.javascript" pinned="">
    import { firebase, listen, viewof user } with {
      firebaseConfig
    } from '@tomlarkworthy/firebase'
  </script>
  <script id="7" type="application/vnd.observable.javascript" pinned="">
    // Copy and paste the config object from the Firebase project settings for a web application
    firebaseConfig = ({
      apiKey: "AIzaSyBN4bxw6d0cM0CGPNzRrkRlBqwFQnPLdN4",
      authDomain: "larkworthy-dfb11.firebaseapp.com",
      databaseURL:
        "https://larkworthy-dfb11-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "larkworthy-dfb11",
      storageBucket: "larkworthy-dfb11.appspot.com",
      messagingSenderId: "786910701676",
      appId: "1:786910701676:web:8d7dd002acf3b78c74d049",
      uiConfig: {
        // https://github.com/firebase/firebaseui-web#configuration
        signInOptions: ["google.com", "anonymous"]
        // tosUrl: '<your-tos-url>', // Terms of service url.
        // privacyPolicyUrl: '<your-privacy-policy-url>', // Privacy policy url.
      }
    })
  </script>
  <script id="185" type="application/vnd.observable.javascript" pinned="">
    md`Its useful to assign SDK services to variable so autocomplete works`
  </script>
  <script id="11" type="application/vnd.observable.javascript" pinned="">
    firestore = firebase.firestore()
  </script>
  <script id="25" type="application/vnd.observable.javascript" pinned="">
    firestore
  </script>
  <script id="188" type="application/vnd.observable.javascript">
    md`## Basics`
  </script>
  <script id="203" type="application/vnd.observable.javascript">
    md`Write some data`
  </script>
  <script id="199" type="application/vnd.observable.javascript" pinned="">
    firestore.doc("messages/5h126rZvETtk4U010ueQ").set({
      by: user.uid,
      msg: "Hello"
    })
  </script>
  <script id="196" type="application/vnd.observable.javascript">
    md`Read a snapshot in time:`
  </script>
  <script id="192" type="application/vnd.observable.javascript" pinned="">
    (await firestore.doc("messages/5h126rZvETtk4U010ueQ").get()).data()
  </script>
  <script id="206" type="application/vnd.observable.javascript">
    md`Read a collection at a snapshot in time`
  </script>
  <script id="207" type="application/vnd.observable.javascript" pinned="">
    (await firestore.collection("messages").get()).docs.map(d => d.data())
  </script>
  <script id="213" type="application/vnd.observable.javascript">
    md`Read a doc AND update in realtime. Use list to bind a location to a cell, and have all the nice dataflow features of dependant recomputing nicely.`
  </script>
  <script id="217" type="application/vnd.observable.javascript" pinned="">
    listen(firestore.collection("messages").limit(2))
  </script>
  <script id="48" type="application/vnd.observable.javascript">
    md`## Lets Build a chat app`
  </script>
  <script id="51" type="application/vnd.observable.javascript">
    import { html } from '@observablehq/htl'
  </script>
  <script id="78" type="application/vnd.observable.javascript" pinned="">
    import { reconcile } from '@tomlarkworthy/reconcile-nanomorph'
  </script>
  <script id="56" type="application/vnd.observable.javascript" pinned="">
    messages = listen(
      firestore
        .collection("messages")
        .orderBy("t")
        .limitToLast(20)
    )
  </script>
  <script id="225" type="application/vnd.observable.javascript">
    md`When we add Firebase storage we need to convert the filepaths do download URLs which is a little awkward as they are promises`
  </script>
  <script id="151" type="application/vnd.observable.javascript" pinned="">
    messagesWithURL = promiseRecursive(
      messages.map(row => ({
        ...row,
        ...(row.path && { url: storage.ref(row.path).getDownloadURL() })
      }))
    )
  </script>
  <script id="157" type="application/vnd.observable.javascript" pinned="">
    // Thanks you trincot!
    // https://stackoverflow.com/a/44072329/862295
    // A wonderful peice of code contralises all promises in a nexted object to the root.
    function promiseRecursive(obj) {
      const getPromises = obj =>
        Object.keys(obj).reduce(
          (acc, key) =>
            Object(obj[key]) !== obj[key]
              ? acc
              : acc.concat(
                  typeof obj[key].then === "function"
                    ? [[obj, key]]
                    : getPromises(obj[key])
                ),
          []
        );
      const all = getPromises(obj);
      return Promise.all(all.map(([obj, key]) => obj[key])).then(
        responses => (
          all.forEach(([obj, key], i) => (obj[key] = responses[i])), obj
        )
      );
    }
  </script>
  <script id="54" type="application/vnd.observable.javascript" pinned="">
    ui = {
      return reconcile(
        this,
        html`<table>
          ${messagesWithURL.map(row =>
            row.url
              ? html`<tr><td width="100px">${row.by}</td><td><img width="400px" src=${row.url}></img></td></tr>`
              : html`<tr><td width="100px">${row.by}</td><td>${row.msg}</td></tr>`
          )}
        </table>
        <input onkeypress=${evt => {
          mutable msgEvt = evt;
        }}><br>

        <input type="file" onchange=${evt => {
          mutable fileEvt = evt;
        }}>

    `
      );
    }
  </script>
  <script id="62" type="application/vnd.observable.javascript" pinned="">
    mutable msgEvt = undefined
  </script>
  <script id="67" type="application/vnd.observable.javascript" pinned="">
    msgEvt.key
  </script>
  <script id="69" type="application/vnd.observable.javascript" pinned="">
    proccessMessage = {
      if (msgEvt.key == "Enter") {
        firestore.collection("messages").add({
          by: user.uid,
          msg: msgEvt.target.value,
          t: firebase.firebase_.firestore.FieldValue.serverTimestamp()
        });
      }
    }
  </script>
  <script id="73" type="application/vnd.observable.javascript" pinned="">
    msgEvt.target.value
  </script>
  <script id="121" type="application/vnd.observable.javascript" pinned="">
    mutable fileEvt = undefined
  </script>
  <script id="126" type="application/vnd.observable.javascript" pinned="">
    storage = firebase.storage()
  </script>
  <script id="128" type="application/vnd.observable.javascript" pinned="">
    sRef = storage.ref(`/examples/chat/${randomId()}`)
  </script>
  <script id="137" type="application/vnd.observable.javascript" pinned="">
    processFiles = {
      const file = fileEvt.target.files[0];
      const sRef = storage.ref(`/examples/chat/${randomId()}`);
      const result = await sRef.put(file);
      const path = result.ref.fullPath;
      firestore.collection("messages").add({
        by: user.uid,
        path: path,
        t: firebase.firebase_.firestore.FieldValue.serverTimestamp()
      });
    }
  </script>
  <script id="131" type="application/vnd.observable.javascript">
    import { randomId } from '@tomlarkworthy/randomid'
  </script>
  <script id="91" type="application/vnd.observable.javascript">
    md`## Security`
  </script>
  <script id="105" type="application/vnd.observable.javascript" pinned="">
    viewof user
  </script>
  <script id="109" type="application/vnd.observable.javascript" pinned="">
    user.uid
  </script>
  <script id="246" type="application/vnd.observable.javascript">
    import { footer } from "@tomlarkworthy/footer"
  </script>
  <script id="248" type="application/vnd.observable.javascript">
    footer
  </script>
</notebook>
