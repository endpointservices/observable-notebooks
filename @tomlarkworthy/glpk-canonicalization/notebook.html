<!doctype html>
<notebook theme="air">
  <title>Canonicalization with Math.js</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# Canonicalization with Math.js

    I want to get expressions like ${tex`(x_2 - x_1) * 4 \gt x_1 + 1`}, into _a) into a specialized canonical form for linear programming:-

    ${tex`-5 x_1 + 4 x_2 \geq 1`}

    in general

    ${tex`c_1x_1 + ... + c_nx_n \geq c_0`}

    Math.js has the power, but does not ship with enough rewrite rules by default. So this notebook is about adding the require rules to create a canonicalization routine.

    There is a fuzzer to help stress test these routines https://observablehq.com/@tomlarkworthy/expression-fuzzer
    `
  </script>
  <script id="5" type="application/vnd.observable.javascript">
    math = require('mathjs@9.4.4')
  </script>
  <script id="76" type="application/vnd.observable.javascript">
    md`### Simplify Rule Syntax: Custom simplification rules
    - ‘n’ - matches any Node
    - ‘c’ - matches any ConstantNode
    - ‘v’ - matches any Node that is not a ConstantNode
    `
  </script>
  <script id="1712" type="application/vnd.observable.javascript" pinned="">
    DEBUG = html`<a href="#">`.href.split("?")[0].split("#")[0] ===
      "https://observablehq.com/@tomlarkworthy/glpk-canonicalization"
  </script>
  <script id="232" type="application/vnd.observable.javascript">
    md`## Preparation: identify operator and replace with <`
  </script>
  <script id="239" type="application/vnd.observable.javascript">
    toLeq = ast => {
      const op = { op: ast.op, fn: ast.fn };
      ast.op = '<';
      ast.fn = 'smaller';
      return {
        op,
        ast
      };
    }
  </script>
  <script id="957" type="application/vnd.observable.javascript">
    fromLeq = (ast, op) => {
      ast.op = op.op;
      ast.fn = op.fn;
      return ast;
    }
  </script>
  <script id="352" type="application/vnd.observable.javascript">
    md`### Ordering`
  </script>
  <script id="355" type="application/vnd.observable.javascript" pinned="">
    ordering = [
      { l: 'c+v', r: 'v+c', context: { add: { commutative: false } } },
      { l: 'v*c', r: 'c*v', context: { multiply: { commutative: false } } }
    ]
  </script>
  <script id="357" type="application/vnd.observable.javascript">
    check(ordering, 'x + 1', 'x + 1')
  </script>
  <script id="360" type="application/vnd.observable.javascript">
    check(ordering, '1 + x', 'x + 1')
  </script>
  <script id="322" type="application/vnd.observable.javascript">
    md`### Expand brackets`
  </script>
  <script id="325" type="application/vnd.observable.javascript" pinned="">
    expandBrackets = [
      { l: "0 * n", r: "0" },
      { l: "-(-n)", r: "n" },
      { l: "-(c*n)", r: "-c * n" },
      { l: "-(n1 + n2)", r: "-n1 - n2" },
      { l: "-(n1 - n2)", r: "-n1 + n2" },
      { l: "n - (n1 + n2)", r: "n - n1 - n2" },
      { l: "n - (n1 - n2)", r: "n - n1 + n2" },
      { l: "c * (n1 + n2)", r: "c * n1 + c * n2" },
      { l: "c * (n1 - n2)", r: "c * n1 - c * n2" },
      { l: "-c * (n1 + n2)", r: "-c * n1 - c * n2" },
      { l: "-c * (-n1 - n2)", r: "c * n1 + c * n2" },
      { l: "-c * (n1 - n2)", r: "-c * n1 + c * n2" }
    ]
  </script>
  <script id="2329" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, "-6 * (2 - x) < 0", "-6 * 2 + 6 * x < 0")
  </script>
  <script id="2320" type="application/vnd.observable.javascript" pinned="">
    check(
      expandBrackets,
      "-2 * (-16 - 4 * x) - 2 * y < 16",
      "2 * 16 + 2 * 4 * x - 2 * y < 16"
    )
  </script>
  <script id="2162" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, "-2 * (x + 1)", "-2 * x - 2 * 1")
  </script>
  <script id="478" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '1 - (x2 - 5) ', '1 - x2 + 5')
  </script>
  <script id="544" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, 'x1 - (x2 - 5) ', 'x1 - x2 + 5')
  </script>
  <script id="415" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '4 - (x1 + x2 + 5)', '4 - x1 - x2 - 5')
  </script>
  <script id="441" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '1 - (x2 + 5) ', '1 - x2 - 5')
  </script>
  <script id="429" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '- (x1 + x2)', '-x1 - x2')
  </script>
  <script id="437" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '- (x1 - x2)', '-x1 + x2')
  </script>
  <script id="266" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '-(x + 1)', '-x - 1')
  </script>
  <script id="336" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '-(1 + x)', '-1 - x')
  </script>
  <script id="338" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '-(1 - x)', '-1 + x')
  </script>
  <script id="342" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '-(-1 - x)', '1 + x')
  </script>
  <script id="349" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '-(-1 + x)', '1 - x')
  </script>
  <script id="404" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '-(-1)', '1')
  </script>
  <script id="426" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '-(-x)', 'x')
  </script>
  <script id="887" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '0 * (x + 1)', '0')
  </script>
  <script id="921" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '4 * (x + 1)', '4 * x + 4 * 1')
  </script>
  <script id="927" type="application/vnd.observable.javascript" pinned="">
    check(expandBrackets, '4 * (x - 1)', '4 * x - 4 * 1')
  </script>
  <script id="965" type="application/vnd.observable.javascript">
    check(expandBrackets, '-(x1 + x2)', '-x1 - x2')
  </script>
  <script id="2174" type="application/vnd.observable.javascript">
    md`### Multiple out constants`
  </script>
  <script id="2177" type="application/vnd.observable.javascript" pinned="">
    multiplyOut = [math.simplify.simplifyCore]
  </script>
  <script id="2185" type="application/vnd.observable.javascript" pinned="">
    check(multiplyOut, "2 * 1", "2")
  </script>
  <script id="572" type="application/vnd.observable.javascript">
    md`### ⚠️ Constants to RHS
    `
  </script>
  <script id="2362" type="application/vnd.observable.javascript">
    viewof useConstantsToRHSFn = Inputs.toggle({
      label: "Use new implementation?",
      value: true
    })
  </script>
  <script id="2360" type="application/vnd.observable.javascript">
    constantsToRHS = useConstantsToRHSFn
      ? [constantsToRHSFn]
      : [...constantsToRHSOld]
  </script>
  <script id="575" type="application/vnd.observable.javascript">
    constantsToRHSOld = [
      { l: "c1 + n1 < n2", r: "n1 < n2 - c1" },
      { l: "n1 - c1 + n3 < n2", r: "n1 + n3 < n2 + c1" }, // Hmmm, bit complex
      { l: "n1 - c1 - n3 < n2", r: "n1 - n3 < n2 + c1" }, // Hmmm, bit complex
      { l: "n1 + c1 - n3 < n2", r: "n1 - n3 < n2 - c1" }, // Hmmm, bit complex
      { l: "c1 - n1 < n2", r: "- n1 < n2 - c1" },
      { l: "-c1 - n1 + n3 < n2", r: "- n1 + n3 < n2 + c1" }, // Hmm, bit complex
      { l: "-c1 - n1 - n3 < n2", r: "- n1 - n3 < n2 + c1" }, // Hmm, bit complex
      { l: "- c1 - n1 < n2", r: "- n1 < n2 + c1" },
      { l: "- c1 + n1 < n2", r: "n1 < n2 + c1" },
      { l: "n1 - c1 < n2", r: "n1 < n2 + c1" },
      { l: "c < n", r: "-n < -c" },
      { l: "c < 0", r: "0 < -c" },
      { l: "c <-0", r: "0 < -c" },
      { l: "-c < -0", r: "0 < c" },
      { l: "-c <  0", r: "0 < c" }
    ]
  </script>
  <script id="2369" type="application/vnd.observable.javascript" pinned="">
    constantsToRHSFn = {
      const isOperatorNode = math.isOperatorNode;
      const isConstantNode = math.isConstantNode;
      const isNegativeConstantNode = (node) =>
        isOperatorNode(node) &&
        node.fn == "unaryMinus" &&
        isConstantNode(node.args[0]);
      const isSymbolNode = math.isSymbolNode;
      const isParenthesisNode = math.isParenthesisNode;
      const isZero = math.isZero;
      const OperatorNode = math.OperatorNode;
      const ConstantNode = math.ConstantNode;
      const ParenthesisNode = math.ParenthesisNode;
      const SymbolNode = math.SymbolNode;

      let prunedLHS = (node, pruned) => {
        const pruneNode = (node) =>
          isConstantNode(node) ? node : new ConstantNode(-node.args[0].value);

        if (isConstantNode(node) || isNegativeConstantNode(node)) {
          if (node.value !== 0) {
            pruned.push(pruneNode(node));
          }
          return new ConstantNode(0);
        } else if (isParenthesisNode(node)) {
          return node;
        } else if (isOperatorNode(node) && node.isBinary()) {
          if (node.fn == "add") {
            if (
              isConstantNode(node.args[0]) ||
              isNegativeConstantNode(node.args[0])
            ) {
              pruned.push(pruneNode(node.args[0]));
              return prunedLHS(node.args[1], pruned);
            } else if (
              isConstantNode(node.args[1]) ||
              isNegativeConstantNode(node.args[1])
            ) {
              pruned.push(pruneNode(node.args[1]));
              return prunedLHS(node.args[0], pruned);
            }
            return new OperatorNode(node.op, node.fn, [
              prunedLHS(node.args[0], pruned),
              prunedLHS(node.args[1], pruned)
            ]);
          } else if (node.fn == "subtract") {
            if (
              isConstantNode(node.args[0]) ||
              isNegativeConstantNode(node.args[0])
            ) {
              pruned.push(pruneNode(node.args[0]));
              return new OperatorNode("-", "unaryMinus", [
                prunedLHS(node.args[1], pruned)
              ]);
            } else if (
              isConstantNode(node.args[1]) ||
              isNegativeConstantNode(node.args[1])
            ) {
              pruned.push(new ConstantNode(-pruneNode(node.args[1]).value));
              return prunedLHS(node.args[0], pruned);
            }
            return new OperatorNode(node.op, node.fn, [
              prunedLHS(node.args[0], pruned),
              prunedLHS(node.args[1], pruned)
            ]);
          }

          return node;
        } else if (isOperatorNode(node) && node.isUnary()) {
          return new OperatorNode(node.op, node.fn, [node.args[0]]);
        } else if (isSymbolNode(node)) {
          return node;
        }
        debugger;
        throw new Error(`Should not happen: ${node}`);
      };
      let appendRHS = (node, pruned) => {
        pruned.forEach((term) => {
          if (term.value > 0) {
            node = new OperatorNode("-", "subtract", [node, term]);
          } else {
            node = new OperatorNode("+", "add", [
              node,
              new ConstantNode(-term.value)
            ]);
          }
        });
        return node;
      };

      let splitConditional = (node) => {
        if (isOperatorNode(node) && node.op === "<") {
          const terms = [];
          const a0 = prunedLHS(node.args[0], terms);
          const a1 = appendRHS(node.args[1], terms);
          return new OperatorNode(node.op, node.fn, [a0, a1]);
        } else {
          debugger;
          throw new Error(`Only works with < as top node ${node.fn}`);
        }
      };
      return splitConditional;
    }
  </script>
  <script id="2431" type="application/vnd.observable.javascript" pinned="">
    check(constantsToRHS, "1 < 0", "0 < 0 - 1")
  </script>
  <script id="2472" type="application/vnd.observable.javascript" pinned="">
    check(constantsToRHS, "-1 < 0", "0 < 0 + 1")
  </script>
  <script id="2350" type="application/vnd.observable.javascript" pinned="">
    check(
      constantsToRHS,
      "-2 * y - 2 - 2 * x - y < 0",
      "-2 * y - 2 * x - y < 0 + 2"
    )
  </script>
  <script id="2300" type="application/vnd.observable.javascript" pinned="">
    check(constantsToRHS, "-2 - x + y < 0", "-x + y < 0 + 2")
  </script>
  <script id="2312" type="application/vnd.observable.javascript" pinned="">
    check(constantsToRHS, "-2 - x - y < 0", "-x - y < 0 + 2")
  </script>
  <script id="2195" type="application/vnd.observable.javascript" pinned="">
    check(constantsToRHS, "-(2 * x) + 2 - y < 0", "-(2 * x) - y < 0 - 2")
  </script>
  <script id="1978" type="application/vnd.observable.javascript" pinned="">
    check(constantsToRHS, "0 < 1", "0 < 1")
  </script>
  <script id="1825" type="application/vnd.observable.javascript">
    check(constantsToRHS, "x - 1 +  y < 0", "x + y < 0 + 1")
  </script>
  <script id="577" type="application/vnd.observable.javascript">
    check(constantsToRHS, '4 + x1 < x2', 'x1 < x2 - 4')
  </script>
  <script id="587" type="application/vnd.observable.javascript">
    check(constantsToRHS, '4 - x1 < x2', '-x1 < x2 - 4')
  </script>
  <script id="603" type="application/vnd.observable.javascript">
    check(constantsToRHS, '-4 - x1 < x2', '-x1 < x2 + 4')
  </script>
  <script id="606" type="application/vnd.observable.javascript">
    check(constantsToRHS, '-4 + x1 < x2', 'x1 < x2 + 4')
  </script>
  <script id="614" type="application/vnd.observable.javascript">
    check(constantsToRHS, 'x1 + 4 < x2', 'x1 < x2 - 4')
  </script>
  <script id="617" type="application/vnd.observable.javascript">
    check(constantsToRHS, 'x1 - 4 < x2', 'x1 < x2 + 4')
  </script>
  <script id="625" type="application/vnd.observable.javascript">
    check(constantsToRHS, '-x1 + 4 < x2', '-x1 < x2 - 4')
  </script>
  <script id="1160" type="application/vnd.observable.javascript">
    check(constantsToRHS, "5 - x1 < 0", '-x1 < 0 - 5')
  </script>
  <script id="640" type="application/vnd.observable.javascript">
    md`### Variables to LHS`
  </script>
  <script id="642" type="application/vnd.observable.javascript" pinned="">
    complexityToLHS = [
      { l: 'n1 < n2 + v', r: '-v + n1 < n2' },
      { l: 'n1 < n2 - v', r: 'v + n1 < n2' },
      { l: '-n1 < v - n2', r: '-v - n1 < -n2' },
      { l: 'n1 < v - n2', r: '-v + n1 < -n2' }
      //{ l: 'v1 < v2', r: 'v1 - v2 < 0' }
    ]
  </script>
  <script id="835" type="application/vnd.observable.javascript">
    check(complexityToLHS, 'x < 1 + 1 + 1', '-(1 + 1) + x < 1')
  </script>
  <script id="727" type="application/vnd.observable.javascript">
    check(complexityToLHS, "x1 < x2 - 5", '-x2 + x1 < -5')
  </script>
  <script id="646" type="application/vnd.observable.javascript">
    check(complexityToLHS, '1 < 2 - x', 'x + 1 < 2')
  </script>
  <script id="649" type="application/vnd.observable.javascript" pinned="">
    check(complexityToLHS, '1 < 2 + x', '-x + 1 < 2')
  </script>
  <script id="655" type="application/vnd.observable.javascript" pinned="">
    check(complexityToLHS, '1 < -2 + x', '-x + 1 < -2')
  </script>
  <script id="657" type="application/vnd.observable.javascript" pinned="">
    check(complexityToLHS, '1 < -2 - x', 'x + 1 < -2')
  </script>
  <script id="659" type="application/vnd.observable.javascript" pinned="">
    check(complexityToLHS, '-1 < -2 - x', 'x + -1 < -2')
  </script>
  <script id="683" type="application/vnd.observable.javascript" pinned="">
    check(complexityToLHS, '-1 < x - 2', '-x - 1 < -2')
  </script>
  <script id="694" type="application/vnd.observable.javascript" pinned="">
    check(complexityToLHS, '-1 < -x - 2', '-(-x) - 1 < -2')
  </script>
  <script id="712" type="application/vnd.observable.javascript" pinned="">
    check(complexityToLHS, '-1 < -x + 2', '-(-x) + -1 < 2')
  </script>
  <script id="1227" type="application/vnd.observable.javascript" pinned="">
    check(complexityToLHS, '-4 * y < 0', '-4 * y < 0')
  </script>
  <script id="1071" type="application/vnd.observable.javascript">
    md`### Add zero to RHS

    Its quite dangerous introducing terms as it often causes loop, so we do this once other optimizations are exhausted.
    `
  </script>
  <script id="1075" type="application/vnd.observable.javascript">
    addZeroToRHS = (exp) => {
      exp = typeof exp === "string" ? math.parse(exp) : exp;

      if (
        exp.op === "<" &&
        (exp.args[1].isSymbolNode ||
          (exp.args[1].fn == "unaryMinus" && exp.args[1].args[0].isSymbolNode) ||
          (exp.args[1].op == "*" &&
            exp.args[1].args[0].isConstantNode &&
            exp.args[1].args[1].isSymbolNode) ||
          (exp.args[1].op == "*" &&
            exp.args[1].args[0].fn == "unaryMinus" &&
            exp.args[1].args[0].args[0].isConstantNode &&
            exp.args[1].args[1].isSymbolNode))
      ) {
        const RHS = exp.args[1];
        const LHS = exp.args[0];
        const newRHS = new math.ConstantNode(0);
        const newLHS =
          exp.args[1].fn == "unaryMinus" && exp.args[1].args[0].isSymbolNode
            ? new math.OperatorNode("+", "add", [LHS, RHS.args[0]])
            : new math.OperatorNode("-", "minus", [LHS, RHS]);
        const result = new math.OperatorNode("<", "smaller", [newLHS, newRHS]);
        return math.parse(result.toString()); // There is something we don't get about mutating expression trees
      } else {
        return exp;
      }
    }
  </script>
  <script id="2238" type="application/vnd.observable.javascript" pinned="">
    math.parse("1 + 2 ")
  </script>
  <script id="2262" type="application/vnd.observable.javascript" pinned="">
    checkStep(addZeroToRHS, "x < -3 * x", "x - -3 * x < 0")
  </script>
  <script id="1953" type="application/vnd.observable.javascript" pinned="">
    checkStep(addZeroToRHS, '0 < -1', "0 < -1")
  </script>
  <script id="2236" type="application/vnd.observable.javascript" pinned="">
    checkStep(addZeroToRHS, "x < -x", "x + x < 0")
  </script>
  <script id="1198" type="application/vnd.observable.javascript" pinned="">
    checkStep(addZeroToRHS, 'y < 5*y', "y - 5 * y < 0")
  </script>
  <script id="1067" type="application/vnd.observable.javascript" pinned="">
    checkStep(addZeroToRHS, 'x < y', 'x - y < 0')
  </script>
  <script id="1083" type="application/vnd.observable.javascript" pinned="">
    checkStep(addZeroToRHS, 'x < 3', 'x < 3')
  </script>
  <script id="1096" type="application/vnd.observable.javascript" pinned="">
    checkStep(addZeroToRHS, 'x < -3', 'x < -3')
  </script>
  <script id="1143" type="application/vnd.observable.javascript" pinned="">
    checkStep(addZeroToRHS, '5 < x1', "5 - x1 < 0")
  </script>
  <script id="1183" type="application/vnd.observable.javascript" pinned="">
    checkStep(
      exp => math.simplify(addZeroToRHS(exp), constantsToRHS),
      '5 < x1',
      '-x1 < 0 - 5'
    )
  </script>
  <script id="1230" type="application/vnd.observable.javascript" pinned="">
    checkStep(addZeroToRHS, '-4 * y < 0', '-4 * y < 0')
  </script>
  <script id="982" type="application/vnd.observable.javascript">
    md`### Simplify Base Rules

    The default simplify sometimes works against us by introducing brackets. So we trim the rules down a bit, however it is not enough
    `
  </script>
  <script id="985" type="application/vnd.observable.javascript" pinned="">
    simplify2 = {
      const baseRules = [...math.simplify.rules];

      baseRules.splice(
        baseRules.findIndex((r) => r.l === "n1*n3 + n2*n3"),
        1
      );
      /*
      baseRules.splice(
        baseRules.findIndex((r) => r.l === "n1*n2 + n2") + 1,
        0,
        { l: "c1 * (n + c2)", r: "c1 * n + c1 * c2" },
        { l: "-c1 * (n + c2)", r: "-c1 * n - c1 * c2" },
        { l: "- (n1 + n2)", r: "-n1 - n2" }
      );*/

      // Performance issues so we remove some irrelavant ones
      /*
      baseRules.splice(baseRules.findIndex(r => r.l === 'n+n'), 1);
      baseRules.splice(baseRules.findIndex(r => r.l === 'log(e)'), 1);
      baseRules.splice(baseRules.findIndex(r => r.l === 'n-n1'), 1);
      baseRules.splice(baseRules.findIndex(r => r.l === 'n+-n'), 1);
      baseRules.splice(baseRules.findIndex(r => r.l === 'n*n'), 1);
      */
      return [...baseRules];
    }
  </script>
  <script id="2497" type="application/vnd.observable.javascript" pinned="">
    simplifyStepExample("-2 * y - 4 * y < 0", "-6 * y < 0")
  </script>
  <script id="988" type="application/vnd.observable.javascript" pinned="">
    check(simplify2, '-x1 - x2 < 5', '-x1 - x2 < 5')
  </script>
  <script id="1232" type="application/vnd.observable.javascript" pinned="">
    check(simplify2, '-4 * y < 0', '-(4 * y) < 0') // Unfortunate but needed for other cases
  </script>
  <script id="1401" type="application/vnd.observable.javascript" pinned="">
    check(simplify2, '1.1', '1.1')
  </script>
  <script id="1688" type="application/vnd.observable.javascript" pinned="">
    check(simplify2, "x - 1 - 2", "x - 3")
  </script>
  <script id="1699" type="application/vnd.observable.javascript">
    check(simplify2, "x - 1 + 1 + y", "x + y")
  </script>
  <script id="1809" type="application/vnd.observable.javascript">
    md`### Simplify Step

    Note that < causes problems with zeros, so we have to simplify on each AST branch seperately
    `
  </script>
  <script id="1718" type="application/vnd.observable.javascript" pinned="">
    // New simplify rules get confused with comparisons. So its better to do each half seperately
    check(simplify2, "- 1 + 1 + y < 0", "y + 0 < 0")
  </script>
  <script id="1753" type="application/vnd.observable.javascript" pinned="">
    simplifyStep = (exp) => {
      // Simplify gets confused by comparitor, better to run it on each child sperately
      const customSimplify = (exp) =>
        math.simplify(
          math.simplify(exp, math.simplify.rules, {}, { exactFractions: false }),
          [...expandBrackets, ...multiplyOut]
        );

      if (exp.isOperatorNode && exp.op === "<") {
        return exp.map(customSimplify);
      } else {
        return customSimplify(exp);
      }
    }
  </script>
  <script id="1784" type="application/vnd.observable.javascript" pinned="">
    simplifyStepExample("- 1 + 1 + y < 0", "y < 0")
  </script>
  <script id="2017" type="application/vnd.observable.javascript" pinned="">
    simplifyStepExample("-2 * x + -2 < 0", "-2 * x - 2 < 0")
  </script>
  <script id="2147" type="application/vnd.observable.javascript" pinned="">
    simplifyStepExample("2 * (x + 2) < 0", "2 * x + 4 < 0")
  </script>
  <script id="2056" type="application/vnd.observable.javascript" pinned="">
    simplifyStepExample("2 + 2 * x", "2 * x + 2")
  </script>
  <script id="2050" type="application/vnd.observable.javascript" pinned="">
    simplifyStepExample("1 * 2 < 0", "2 < 0")
  </script>
  <script id="761" type="application/vnd.observable.javascript">
    md`### Step 2

    Aim of step 2 is to pull constants to RHS, simplify them, and push complex expression to LHS, and repeat.
    `
  </script>
  <script id="58" type="application/vnd.observable.javascript" pinned="">
    step2 = (exp) => {
      const history = [];
      do {
        history.push(exp);
        const updateRHS = math.simplify(exp, [
          ...expandBrackets,
          ...constantsToRHS
        ]);
        const rhs = simplifyStep(updateRHS);
        const updateLHS = math.simplify(rhs, [...complexityToLHS]);
        exp = addZeroToRHS(updateLHS);
        if (DEBUG) {
          console.log("updateRHS", updateRHS.toString());
          console.log("rhs", rhs.toString());
          console.log("updateLHS", updateLHS.toString());
          console.log("addZeroToRHS", exp.toString());
        }
      } while (history.find((prev) => _.isEqual(exp, prev)) === undefined);

      return math.simplify(exp, [...expandBrackets]);
    }
  </script>
  <script id="1471" type="application/vnd.observable.javascript">
    equalsIsSlow = {
      const n = 20;
      const termsA = Array.from({ length: n })
        .map((_, i) => `x${i}`)
        .join(" + ");

      const termsB = Array.from({ length: n })
        .map((_, i) => `x${i}`)
        .join(" + ");

      const a = math.parse(termsA);
      const b = math.parse(termsB);

      //return a.equals(b) // Very slow, uses home rolled deep equals https://github.com/josdejong/mathjs/blob/c6cbf5538915c8964b70a1af086f47c2c0be33df/src/expression/node/Node.js#L221
      return _.isEqual(a, b); // much faster
    }
  </script>
  <script id="2318" type="application/vnd.observable.javascript" pinned="">
    step2Example(
      "-2*-2*2*(1*2+x+2)+(-2+0)*(y+(0+(-2+-2*0*-1*((-2*2+1)*(0+-1)*-1+2))*(2+0*-2))*-2) < 0*1",
      "8 * x - 2 * y < -16"
    )
  </script>
  <script id="2294" type="application/vnd.observable.javascript" pinned="">
    step2Example("-2 - x + y < 0", "y - x < 2")
  </script>
  <script id="2233" type="application/vnd.observable.javascript" pinned="">
    step2Example("((-1*2+-2+0)*0*-1+x+-1+1)*1 < (1+-2)*x", "2 * x < 0")
  </script>
  <script id="1996" type="application/vnd.observable.javascript" pinned="">
    step2Example("-(2 * x) + -2 - y < 0", "-2 * x - y < 2")
  </script>
  <script id="1940" type="application/vnd.observable.javascript" pinned="">
    step2Example("0*0*x < 1", "0 < 1")
  </script>
  <script id="796" type="application/vnd.observable.javascript" pinned="">
    step2Example('4 + x1 + x2 + 1 < x2 + 4', "x1 < -1")
  </script>
  <script id="1918" type="application/vnd.observable.javascript" pinned="">
    step2Example('4 + x1 + 1 < 4', "x1 < -1")
  </script>
  <script id="811" type="application/vnd.observable.javascript" pinned="">
    step2Example('(x + 1) < (3 + x) * (6 - 7)', "2 * x < -4")
  </script>
  <script id="814" type="application/vnd.observable.javascript" pinned="">
    step2Example('(x + 1) * 4 < (3 + x) * (6 - 7)', "5 * x < -7")
  </script>
  <script id="968" type="application/vnd.observable.javascript" pinned="">
    step2Example('-(x1 + x2) < 0', '-x1 - x2 < 0')
  </script>
  <script id="1065" type="application/vnd.observable.javascript" pinned="">
    step2Example('x < y', 'x - y < 0')
  </script>
  <script id="1121" type="application/vnd.observable.javascript" pinned="">
    step2Example('5 < x1', "-x1 < -5")
  </script>
  <script id="1214" type="application/vnd.observable.javascript" pinned="">
    step2Example('-(4 * y) < 0', "-4 * y < 0")
  </script>
  <script id="1365" type="application/vnd.observable.javascript" pinned="">
    step2Example("4x < 0", "4 x < 0")
  </script>
  <script id="1399" type="application/vnd.observable.javascript" pinned="">
    step2Example("x < 1.1", "x < 1.1")
  </script>
  <script id="1683" type="application/vnd.observable.javascript" pinned="">
    step2Example("x - 1 + 1 + y < 0", "x + y < 0")
  </script>
  <script id="1873" type="application/vnd.observable.javascript" pinned="">
    step2Example("0 < -2 * x", "2 * x < 0")
  </script>
  <script id="2111" type="application/vnd.observable.javascript" pinned="">
    step2Example("1 + y < y", "0 < -1")
  </script>
  <script id="2250" type="application/vnd.observable.javascript" pinned="">
    step2Example("x < -3 * x", "4 * x < 0")
  </script>
  <script id="2285" type="application/vnd.observable.javascript" pinned="">
    step2Example("x < -1*(0+-1)*(1+0)*(-2+(0+1+1*0*-1)*0)*2*y", "x + 4 * y < 0")
  </script>
  <script id="567" type="application/vnd.observable.javascript">
    md`### Canonicalize`
  </script>
  <script id="27" type="application/vnd.observable.javascript">
    canonicalize = exp => {
      const ast = math.parse(exp);
      const leq = toLeq(ast);
      const simplified = isCanonical(leq.ast) ? leq.ast : step2(leq.ast);
      return fromLeq(simplified, leq.op);
    }
  </script>
  <script id="105" type="application/vnd.observable.javascript" pinned="">
    canonicalExample('4 + x1 + 1 < 4', "x1 < -1")
  </script>
  <script id="156" type="application/vnd.observable.javascript" pinned="">
    canonicalExample('4 > 4 + x1 + 1', "-x1 > 1")
  </script>
  <script id="119" type="application/vnd.observable.javascript" pinned="">
    canonicalExample('4 + x1 + x2 + 2 < x2 + 4', "x1 < -2")
  </script>
  <script id="142" type="application/vnd.observable.javascript" pinned="">
    canonicalExample('4 + x1 + x2 + 2 <= x2 + 4', "x1 <= -2")
  </script>
  <script id="139" type="application/vnd.observable.javascript" pinned="">
    canonicalExample("5 > x1 + x2", "-x1 - x2 > -5")
  </script>
  <script id="1060" type="application/vnd.observable.javascript" pinned="">
    canonicalExample('- -x + y > 5*y + 2x', "-4 * y - x > 0")
  </script>
  <script id="1252" type="application/vnd.observable.javascript" pinned="">
    canonicalExample("-(4 * y) + -(4 * x) > 0", "-4 * y - 4 * x > 0")
  </script>
  <script id="1397" type="application/vnd.observable.javascript" pinned="">
    canonicalExample('x > 1.1', "x > 1.1")
  </script>
  <script id="1420" type="application/vnd.observable.javascript" pinned="">
    canonicalExample("1 == x1 + x2 + x3", "-x3 - x1 - x2 == -1")
  </script>
  <script id="1679" type="application/vnd.observable.javascript" pinned="">
    canonicalExample("x - 1 + 1 + y <= 0", "x + y <= 0")
  </script>
  <script id="2346" type="application/vnd.observable.javascript" pinned="">
    canonicalExample("(-1+1*(2+y+x))*-2 <= y", "-3 * y - 2 * x <= 2")
  </script>
  <script id="1436" type="application/vnd.observable.javascript" pinned="">
    tests.test(`scale 10k'`, () => {
      const n = 10000;
      const terms = Array.from({ length: n })
        .map((_, i) => `x${i}`)
        .join(" + ");
      canonicalize(terms + " > 0");
    })
  </script>
  <script id="1571" type="application/vnd.observable.javascript">
    md`### isCanonical (special case short circuit)`
  </script>
  <script id="1573" type="application/vnd.observable.javascript" pinned="">
    isCanonical = exp => {
      if (exp.op) {
        try {
          const bounds = extractRHS('<=', exp.args[1]);
          const vars = extractLHS([], exp.args[0]);
        } catch (err) {
          return false;
        }
        return true;
      }

      return false;
    }
  </script>
  <script id="1575" type="application/vnd.observable.javascript" pinned="">
    tests.test("x0 + x1 + x2 > 0 is canonical", () => {
      expect(isCanonical(math.parse("x0 + x1 + x2 < 0"))).toBe(true);
    })
  </script>
  <script id="1597" type="application/vnd.observable.javascript" pinned="">
    tests.test("x0 + x1 - x2 > 0 is canonical", () => {
      expect(isCanonical(math.parse("x0 + x1 - x2 < 0"))).toBe(true);
    })
  </script>
  <script id="1583" type="application/vnd.observable.javascript" pinned="">
    tests.test("x0 + x1 * x2 > 0 is NOT canonical", () => {
      expect(isCanonical(math.parse("x0 + x1 * x2 < 0"))).toBe(false);
    })
  </script>
  <script id="1662" type="application/vnd.observable.javascript" pinned="">
    tests.test("-x < -1 is canonical", () => {
      expect(isCanonical(math.parse("-x < -1"))).toBe(true);
    })
  </script>
  <script id="1257" type="application/vnd.observable.javascript">
    md`### Extract

    This applies our custom canonicalization and converts to a JSON:

    ~~~js
    vars: [
              { name: 'x1', coef: 3.0 },
              { name: 'x2', coef: 1.0 }
            ],
            ub: 2.0
            lb: 0.0
    ~~~
    `
  </script>
  <script id="1261" type="application/vnd.observable.javascript">
    extract = exp => {
      const c = canonicalize(exp);
      if (c.isOperatorNode) {
        const bounds = extractRHS(c.op, c.args[1]);
        const vars = extractLHS([], c.args[0]);

        return {
          vars,
          bounds
        };
      } else {
        throw new Error("cannot deal");
      }
    }
  </script>
  <script id="1274" type="application/vnd.observable.javascript">
    extractRHS = (op, rhs) => {
      let value = undefined;
      if (rhs.isConstantNode) {
        value = rhs.value;
      } else if (rhs.fn === "unaryMinus" && rhs.args[0].isConstantNode) {
        value = -rhs.args[0].value;
      } else {
        throw new Error(`Must be constant: ${rhs.toString()}`);
      }
      if (op === "<=") {
        return {
          upper: value
        };
      } else if (op === ">=") {
        return {
          lower: value
        };
      } else if (op === "==") {
        return {
          lower: value,
          upper: value
        };
      } else {
        throw new Error(`Unsupported op ${op}`);
      }
    }
  </script>
  <script id="1298" type="application/vnd.observable.javascript">
    function extractLHS(acc, rootLhs) {
      const stack = [];
      stack.push(rootLhs);

      // while not empty
      while (stack.length) {
        // Pop off end of stack.
        let lhs = stack.pop();

        if (
          lhs.isOperatorNode &&
          lhs.op === "-" &&
          lhs.fn === "unaryMinus" &&
          lhs.args[0].isConstantNode &&
          lhs.args[0].value === 0
        ) {
          // neg
        } else if (lhs.isConstantNode && lhs.value === 0) {
          // nothing to do
        } else if (lhs.isOperatorNode && lhs.op === "+") {
          stack.push(lhs.args[0]);
          stack.push(lhs.args[1]);
        } else if (
          lhs.isOperatorNode &&
          lhs.op === "-" &&
          lhs.fn !== "unaryMinus"
        ) {
          stack.push(lhs.args[0]);
          const rhs = extractLHS([], lhs.args[1]);
          if (rhs.length !== 1)
            throw new Error("Unexpected complexity for negated op");
          acc.push({
            coef: -rhs[0].coef,
            name: rhs[0].name
          });
        } else if (lhs.isSymbolNode) {
          acc.push({
            coef: 1,
            name: lhs.name
          });
        } else if (
          lhs.isOperatorNode &&
          lhs.op === "-" &&
          lhs.fn === "unaryMinus" &&
          lhs.args[0].isSymbolNode
        ) {
          acc.push({
            coef: -1,
            name: lhs.args[0].name
          });
        } else if (lhs.isOperatorNode && lhs.op === "*") {
          if (lhs.args[1].isSymbolNode) {
            let value = undefined;
            if (lhs.args[0].isConstantNode) {
              value = lhs.args[0].value;
            } else if (
              lhs.args[0].fn === "unaryMinus" &&
              lhs.args[0].args[0].isConstantNode
            ) {
              value = -lhs.args[0].args[0].value;
            } else {
              throw new Error(`Must be constant: ${lhs.args[0].toString()}`);
            }
            acc.push({
              coef: value,
              name: lhs.args[1].name
            });
          } else {
            throw new Error(`Cannot term from ${lhs.toString()}`);
          }
        } else {
          throw new Error(`Cannot extract coeffecients from ${lhs.toString()}`);
        }
      }

      return acc;
    }
  </script>
  <script id="1333" type="application/vnd.observable.javascript">
    checkExtract = (expression, expected) => {
      return tests.test(
        `extract('${expression}') === '${JSON.stringify(expected)}'`,
        () => {
          expect(extract(expression)).toEqual(expected);
        }
      );
    }
  </script>
  <script id="1335" type="application/vnd.observable.javascript" pinned="">
    checkExtract('4x <= 6', {
      vars: [{ coef: 4, name: "x" }],
      bounds: { upper: 6 }
    })
  </script>
  <script id="1349" type="application/vnd.observable.javascript" pinned="">
    checkExtract("x <= 0", {
      vars: [{ coef: 1, name: "x" }],
      bounds: { upper: 0 }
    })
  </script>
  <script id="1342" type="application/vnd.observable.javascript" pinned="">
    checkExtract('4x  + 6 (y + 4) 5 >= -6', {
      vars: [{ coef: 30, name: "y" }, { coef: 4, name: "x" }],
      bounds: { lower: -126 }
    })
  </script>
  <script id="1375" type="application/vnd.observable.javascript" pinned="">
    checkExtract('4x - 2(y) >= 0', {
      bounds: { lower: 0 },
      vars: [{ coef: -2, name: "y" }, { coef: 4, name: "x" }]
    })
  </script>
  <script id="1429" type="application/vnd.observable.javascript" pinned="">
    checkExtract('x + y == 0', {
      vars: [{ coef: 1, name: "y" }, { coef: 1, name: "x" }],
      bounds: { upper: 0, lower: 0 }
    })
  </script>
  <script id="1391" type="application/vnd.observable.javascript" pinned="">
    checkExtract('4x - 2(y) -z >= 0', {
      bounds: { lower: 0 },
      vars: [
        { coef: -1, name: "z" },
        { coef: -2, name: "y" },
        { coef: 4, name: "x" }
      ]
    })
  </script>
  <script id="1867" type="application/vnd.observable.javascript" pinned="">
    checkExtract("0<=-2*x", {
      bounds: { upper: -0 },
      vars: [{ coef: 2, name: "x" }]
    })
  </script>
  <script id="1900" type="application/vnd.observable.javascript" pinned="">
    checkExtract("0 == 0", {
      vars: [],
      bounds: { upper: 0, lower: 0 }
    })
  </script>
  <script id="1907" type="application/vnd.observable.javascript" pinned="">
    checkExtract("0*0*x>=1", {
      vars: [],
      bounds: { lower: 1 }
    })
  </script>
  <script id="1993" type="application/vnd.observable.javascript">
    checkExtract("-2<=y+2*x", {
      vars: [
        {
          coef: -2,
          name: "x"
        },
        {
          coef: -1,
          name: "y"
        }
      ],
      bounds: { upper: 2 }
    })
  </script>
  <script id="12" type="application/vnd.observable.javascript" pinned="">
    viewof tests = createSuite({
      name: "Canonicalization"
    })
  </script>
  <script id="33" type="application/vnd.observable.javascript" pinned="">
    canonicalExample = (expression, expected) => {
      return tests.test(
        `canonicalize('${expression.substring(30)}') === '${expected.substring(
          30
        )}'`,
        () => {
          expect(canonicalize(expression).toString()).toBe(expected);
        }
      );
    }
  </script>
  <script id="798" type="application/vnd.observable.javascript" pinned="">
    step2Example = (expression, expected) => {
      return tests.test(`step2('${expression}') === '${expected}'`, () => {
        expect(step2(expression).toString()).toBe(expected);
      });
    }
  </script>
  <script id="1789" type="application/vnd.observable.javascript" pinned="">
    simplifyStepExample = (expression, expected) => {
      return tests.test(`simplifyStep('${expression}') === '${expected}'`, () => {
        expect(simplifyStep(math.parse(expression)).toString()).toBe(expected);
      });
    }
  </script>
  <script id="1925" type="application/vnd.observable.javascript" pinned="">
    simplifyStepExample('0*0*x < 1', '0 < 1')
  </script>
  <script id="331" type="application/vnd.observable.javascript" pinned="">
    check = (rules, expression, expected) => {
      return tests.test(`check('${expression}') === '${expected}'`, () => {
        expect(
          math.simplify(expression, rules, {}, { exactFractions: false }).toString()
        ).toBe(expected);
      });
    }
  </script>
  <script id="1099" type="application/vnd.observable.javascript" pinned="">
    checkStep = (step, expression, expected) => {
      return tests.test(`check('${expression}') === '${expected}'`, () => {
        expect(step(math.parse(expression)).toString()).toBe(expected);
      });
    }
  </script>
  <script id="8" type="application/vnd.observable.javascript">
    import { createSuite, expect } from '@tomlarkworthy/testing'
  </script>
</notebook>
