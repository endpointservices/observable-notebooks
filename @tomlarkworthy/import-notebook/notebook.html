<!doctype html>
<notebook theme="air">
  <title>Programmatic importNotebook</title>
  <script id="0" type="text/markdown">
    # Programmatic `importNotebook`

    `importNotebook` is a programmatic version of `import`. After an export, the import becomes "baked in" and offline-first.


    Issues:-
    - Observable dependancy resolution can miss, leading to new modules which look similar but are not the same
    - Would be better to import to an isolated module, reserialize, and depend on that.
    - By the time the module is running we lost import map magic though.
    - Maybe esModuleShim can help import a module but hook the resolution. Also supports dynamic import maps.
  </script>
  <script id="399" type="application/vnd.observable.javascript" pinned="">
    runtime._modules
  </script>
  <script id="287" type="application/vnd.observable.javascript" pinned="">
    importNotebook("@tomlarkworthy/exporter", [
      {
        imported: "exporter",
        /* optional */ local: "exporter2"
      }
    ])
  </script>
  <script id="386" type="text/markdown">
    The following cell demonstrate the imported cell works. Also, its the exporter dependancy so you can see that the import continues to work after export, and even offline.
  </script>
  <script id="134" type="application/vnd.observable.javascript" pinned="">
    exporter2() // this depenancy has come from the scripted import
  </script>
  <script id="203" type="application/vnd.observable.javascript" pinned="">
    importNotebook = async (notebook, specifiers = []) => {
      runtime;
      let fn;
      for (const url of [
        notebook,
        `https://api.observablehq.com/${notebook}.js?v=4&${resolutions_key}`
      ]) {
        try {
          fn = eval(`async () => runtime.module((await import("${url}")).default)`);
          await fn();
          break;
        } catch {}
      }
      if (!fn) throw `Can't resolve ${notebook}`;

      const module_variable = `module ${notebook}`;

      if (!main._scope.has(module_variable)) {
        main.define(module_variable, fn);
      }

      for (let { imported, local = null } of specifiers) {
        if (!local) local = imported;
        if (!main._scope.has(local)) {
          main.define(local, [module_variable, "@variable"], (_, v) =>
            v.import(imported, local, _)
          );
        } else {
          main.redefine(local, [module_variable, "@variable"], (_, v) =>
            v.import(imported, local, _)
          );
        }
      }

      return md`~~~js
    importNotebook("${notebook}", ${JSON.stringify(specifiers)})
    ~~~`;
    }
  </script>
  <script id="401" type="application/vnd.observable.javascript">
    resolutions_key = {
      if (isOnObservableCom()) {
        for (let v of runtime._variables) {
          let match;
          if (
            v._value?._scope &&
            (match = /(resolutions=[a-f0-9]+@\d+)/.exec(v._definition.toString()))
          ) {
            return match[1];
          }
        }
      }
    }
  </script>
  <script id="29" type="application/vnd.observable.javascript">
    import { runtime, main } from "@mootari/access-runtime"
  </script>
  <script id="306" type="application/vnd.observable.javascript">
    import {
      keepalive,
      thisModule,
      isOnObservableCom
    } from "@tomlarkworthy/runtime-sdk"
  </script>
  <script id="461" type="text/markdown">
    ---
    Experiments
  </script>
  <script id="463" type="application/vnd.observable.javascript" pinned="">
    //import { esModuleShims } from "@tomlarkworthy/es-module-shims"
  </script>
  <script id="502" type="application/vnd.observable.javascript" pinned="">
    // Combines static import map with dynamic import map to get overall import map
    getImportMap = () => ({
      ...JSON.parse(document.querySelector("script[type='importmap'")?.text || "{}")
        ?.imports,
      ...window.importShim.getImportMap().imports
    })
  </script>
  <script id="518" type="application/vnd.observable.javascript">
    test_getModuleName = {
      let input;
      if (
        (input =
          getModuleName(
            "https://api.observablehq.com/@tomlarkworthy/svg-boinger.js?v=4"
          ) !== "@tomlarkworthy/svg-boinger")
      )
        throw Error(input);
      if (
        (input = getModuleName(
          "/d/c2dae147641e012a@46.js?v=4&resolutions=0b75dbddd18995dc@1761"
        )) !== "d/c2dae147641e012a@46"
      )
        throw Error(input);

      return "ok";
    }
  </script>
  <script id="516" type="application/vnd.observable.javascript">
    getModuleName = (path) =>
      (path.match(/^(?:https?:\/\/[^\/]+\/|\/)([^?#]+?)\.js\b/i) || [])[1]
  </script>
  <script id="470" type="application/vnd.observable.javascript">
    moduleLoader = {
      debugger;
      return esModuleShims({
        shimMode: true,
        resolve
      });
    }
  </script>
  <script id="477" type="application/vnd.observable.javascript" pinned="">
    viewof resolves = Inputs.input([])
  </script>
  <script id="498" type="application/vnd.observable.javascript" pinned="">
    resolves
  </script>
  <script id="475" type="application/vnd.observable.javascript" pinned="">
    resolve = (id, parentUrl, defaultResolve) => {
      viewof resolves.value.push([id, parentUrl]);
      viewof resolves.dispatchEvent(new Event("input"));
      const module = getModuleName(id);
      const importmap = getImportMap();
      debugger;
      if (importmap[module]) return importmap[module];

      // Default resolve will handle the typical URL and import map resolution
      return defaultResolve(id, parentUrl);
    }
  </script>
  <script id="556" type="application/vnd.observable.javascript" pinned="">
    viewof load = Inputs.toggle()
  </script>
  <script id="485" type="application/vnd.observable.javascript">
    boinger = {
      moduleLoader;
      if (load) {
        return window.importShim(
          "https://api.observablehq.com/@tomlarkworthy/debugger.js?v=4"
        );
      }
    }
  </script>
  <script id="487" type="application/vnd.observable.javascript" pinned="">
    boinger.default.toString()
  </script>
  <script id="488" type="application/vnd.observable.javascript" pinned="">
    boinger_module = runtime.module(
      boinger.default,
      observable.Inspector.into(notebook)
    )
  </script>
  <script id="490" type="application/vnd.observable.javascript" pinned="">
    boinger_module._scope
  </script>
  <script id="491" type="application/vnd.observable.javascript" pinned="">
    observable = require("@observablehq/runtime@4")
  </script>
  <script id="492" type="text/html" pinned="">
    <div>
  </script>
  <script id="493" type="application/vnd.observable.javascript" pinned="">
    unzip = async (attachment) =>
      await new Response(
        (await attachment.stream()).pipeThrough(new DecompressionStream("gzip"))
      ).blob()
  </script>
</notebook>
