<!doctype html>
<notebook theme="air">
  <title>YouTube API Video Upload</title>
  <script id="4" type="application/vnd.observable.javascript">
    md`
    # YouTube API Video Upload

    <iframe width="560" height="315" src="https://www.youtube.com/embed/FThG8pVGIS0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

    The Notebook is about how to upload a video using the YouTube API.

    We need the YouTube Data API setup, and an Oauth Web Client redirecting to the Observable Notebook.

    Caution, you only get 6 attempts a day! Quota is extremely tight. I have disabled this notebooks uploads, you need to setup your own.

    [my quota page](https://console.cloud.google.com/iam-admin/quotas/details;servicem=youtube.googleapis.com;metricm=youtube.googleapis.com%2Fdefault;limitIdm=1%2Fd%2F%7Bproject%7D?project=endpointservice)

    I had to authorize "https://tomlarkworthy.static.observableusercontent.com" as a Javascript Origin
    ![](${await FileAttachment("image@1.png").url()})

    `
  </script>
  <script id="184" type="application/vnd.observable.javascript">
    client_id = "1986724398-5adiabbdrs6lrdh54m25nv9l2afjvl2q.apps.googleusercontent.com"
  </script>
  <script id="187" type="application/vnd.observable.javascript">
    api_key = "AIzaSyCQXyMj3N6KWJ4PEdOtSZ_gLnIZwAep4Uo" // This is old
  </script>
  <script id="14" type="application/vnd.observable.javascript">
    gapi = {
      const gapi = await require("https://apis.google.com/js/api.js").catch(() => window.gapi);
      await new Promise((callback, onerror) => gapi.load("client", {callback, onerror}));
      return gapi;
    }
  </script>
  <script id="22" type="application/vnd.observable.javascript" pinned="">
    auth = {
      // Enter an API key from the Google API Console:
      // https://console.developers.google.com/apis/credentials
      var apiKey = api_key;

      // Enter the API Discovery Docs that describes the APIs you want to
      // access. In this example, we are accessing the People API, so we load
      // Discovery Doc found here: https://developers.google.com/people/api/rest/
      var discoveryDocs = ['https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest'];

      // Enter a client ID for a web application from the Google API Console:
      //   https://console.developers.google.com/apis/credentials?project=_
      // In your API Console project, add a JavaScript origin that corresponds
      //   to the domain where you will be running the script.
      var clientId = client_id;

      // Enter one or more authorization scopes. Refer to the documentation for
      // the API or https://developers.google.com/people/v1/how-tos/authorizing
      // for details.
      var scopes = [
        'https://www.googleapis.com/auth/youtube.upload',
        'https://www.googleapis.com/auth/youtube.readonly'
      ];

      function initClient() {
        console.log("Init client")
        gapi.client.init({
          apiKey: apiKey,
          discoveryDocs: discoveryDocs,
          clientId: clientId,
          scope: scopes.join(" ")
        }).then(function () {
          console.log("Initialize login")
          // Listen for sign-in state changes.
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

          // Handle the initial sign-in state.
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        });
      }

      function updateSigninStatus(isSignedIn) {
        var authorizeButton = document.getElementById('authorize-button');
        var signoutButton = document.getElementById('signout-button');
        authorizeButton.style.display = isSignedIn ? 'none' : 'block';
        signoutButton.style.display = isSignedIn ? 'block' : 'none';
      }

      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
      }

      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }

      initClient();

      return html`
        <div>
          <button id="authorize-button" style="display: none;" onclick=${handleAuthClick}>Authorize</button>
          <button id="signout-button" style="display: none;" onclick=${handleSignoutClick}>Sign Out</button>
        </div>
      `
    }
  </script>
  <script id="76" type="application/vnd.observable.javascript">
    import {html} from "@observablehq/htl"
  </script>
  <script id="201" type="application/vnd.observable.javascript" pinned="">
    contents = new Uint8Array(await FileAttachment("sample_640x360.mp4").arrayBuffer())
  </script>
  <script id="276" type="application/vnd.observable.javascript" pinned="">
    // https://stackoverflow.com/questions/12710001/how-to-convert-uint8-array-to-base64-encoded-string
    function Uint8ToString(u8a){
      var CHUNK_SZ = 0x8000;
      var c = [];
      for (var i=0; i < u8a.length; i+=CHUNK_SZ) {
        c.push(String.fromCharCode.apply(null, u8a.subarray(i, i+CHUNK_SZ)));
      }
      return c.join("");
    }
  </script>
  <script id="200" type="application/vnd.observable.javascript" pinned="">
    // https://github.com/google/google-api-javascript-client/issues/625
    gapi.client.request({ <my quota protector remove this:)>
      path: 'https://www.googleapis.com/upload/youtube/v3/videos',
      method: 'POST',
      params: { part: 'id,snippet,status', alt: 'json', uploadType: 'multipart'},
      headers: { accept: 'application/json', 'content-type': 'multipart/related; boundary="random123"', },
      body: '--random123\nContent-Type: application/json\nMIME-Version: 1.0\n\n' + JSON.stringify({
        snippet: {
              title:"test video 3",
              description:"this is a test video"
            },
            status:{
              privacyStatus:'unlisted'
            }
          }
      ) + '\n--random123\nContent-Type: video/mp4\nMIME-Version: 1.0\nContent-Transfer-Encoding: base64\n\n' + btoa(Uint8ToString(contents)) + '\n--random123--\n',
    })
  </script>
  <script id="311" type="application/vnd.observable.javascript">
    import { footer } from "@endpointservices/footer-with-backups"
  </script>
  <script id="333" type="application/vnd.observable.javascript">
    footer
  </script>
</notebook>
