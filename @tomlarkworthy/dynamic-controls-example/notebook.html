<!doctype html>
<notebook theme="air">
  <title>Dynamic Controls Example</title>
  <script id="0" type="text/markdown">
    # Dynamic Controls Example
  </script>
  <script id="5" type="application/vnd.observable.javascript">
    import { view } from "@tomlarkworthy/view"
  </script>
  <script id="8" type="application/vnd.observable.javascript">
    viewof values = {
      const ui = view`
        ${["elements", [], (value) => Inputs.range([0, 1], { value: value })]}
        <div style="display: flex;">
          ${Inputs.button("add", {
            reduce: () => ui.value.elements.push(Math.random())
          })}
          ${Inputs.button("remove", {
            reduce: () => ui.value.elements.pop()
          })}
        </div>
      `;
      return ui;
    }
  </script>
  <script id="62" type="application/vnd.observable.javascript">
    values
  </script>
  <script id="65" type="text/markdown">
    ## Q: How do I create multiple linked views?
  </script>
  <script id="71" type="application/vnd.observable.javascript" pinned="">
    builder = ({ source } = {}) => {
      const ui = view`
        ${["elements", [], (value) => Inputs.range([0, 1], { value: value })]}
        <div style="display: flex;">
          ${Inputs.button("add", {
            reduce: () => ui.value.elements.push(Math.random())
          })}
          ${Inputs.button("remove", {
            reduce: () => ui.value.elements.pop()
          })}
        </div>
      `;

      if (source) {
        ui.value = source.value;
        source.addEventListener("input", () => {
          source.value.elements.forEach((v, i) => {
            // Bug fix for twitchy events, you must not set the target if its the corrent value already
            // In the case of the target changing, the is avoid the source setting the target after being changed itself
            if (ui.value.elements[i] != v) ui.value.elements[i] = v;
          });
          ui.value.elements.splice(
            // Deal with the case someone deleted an element
            source.value.elements.length,
            ui.value.elements.length - source.value.elements.length
          );
        });
        ui.addEventListener("input", () => {
          ui.value.elements.forEach((v, i) => {
            source.value.elements[i] = v; // Straight assignment to source
          });
          source.value.elements.splice(
            // Deal with the case someone deleted an element
            ui.value.elements.length,
            source.value.elements.length - ui.value.elements.length
          );
          // Retrigger source when target changes
          // Same asymetric operation as Inputs.bind
          source.dispatchEvent(new Event("input", { bubbles: true }));
        });
      }

      return ui;
    }
  </script>
  <script id="122" type="application/vnd.observable.javascript" pinned="">
    viewof target = builder({
      source: viewof values
    })
  </script>
</notebook>
