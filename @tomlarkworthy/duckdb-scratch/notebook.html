<!doctype html>
<notebook theme="air">
  <title>DuckDB play</title>
  <script id="0" type="text/markdown" pinned="">
    # DuckDB play
  </script>
  <script id="5" type="application/vnd.observable.javascript" pinned="">
    import { DuckDBClient } from "@cmudig/duckdb"
  </script>
  <script id="9" type="application/vnd.observable.javascript" pinned="">
    duckdb = new DuckDBClient()
  </script>
  <script id="33" type="application/vnd.observable.javascript" pinned="">
    duckdb.db()
  </script>
  <script id="183" type="application/vnd.observable.javascript" pinned="">
    filled_duckdb = {
      insertDatum;
      return duckdb;
    }
  </script>
  <script id="11" type="application/sql" pinned="" database="var:db">
    SELECT * FROM reading;
  </script>
  <script id="162" type="application/vnd.observable.javascript" pinned="">
    results
  </script>
  <script id="15" type="application/vnd.observable.javascript" pinned="">
    firebaseConfig = ({
      apiKey: "AIzaSyA9OQ--0Sn8Gm6C1B4M-SbnxRMtKHgnHzs",
      authDomain: "agropatterns-iot.firebaseapp.com",
      databaseURL: "https://agropatterns-iot-default-rtdb.firebaseio.com",
      projectId: "agropatterns-iot",
      appId: "1:650132950601:web:115b1ba65750d2b0aaf998",
      uiConfig: {
        // https://github.com/firebase/firebaseui-web#configuration
        signInOptions: ["anonymous"]
      }
    })
  </script>
  <script id="17" type="application/vnd.observable.javascript" pinned="">
    import {
      firebase,
      viewof user,
      listen
    } with { firebaseConfig as firebaseConfig } from "@tomlarkworthy/firebase"
  </script>
  <script id="27" type="application/vnd.observable.javascript" pinned="">
    querySensorName = "dev:864475046458393"
  </script>
  <script id="29" type="application/vnd.observable.javascript" pinned="">
    db = firebase.database()
  </script>
  <script id="221" type="application/vnd.observable.javascript">
    Inputs.button("reload data", {
      reduce: () => {
        mutable hasCreatedtable = false;
        mutable refresh++;
      }
    })
  </script>
  <script id="223" type="application/vnd.observable.javascript">
    mutable refresh = 0
  </script>
  <script id="25" type="application/vnd.observable.javascript" pinned="">
    liveViewRaw = Generators.observe((notify) => {
      refresh;
      db.ref(`history/sensors/${querySensorName}`)
        .orderByKey()
        .startAt(Math.floor(Date.now() / 1000 - 60 * 60 * 24) + "") // reduce data returned
        .on("child_added", (snapshot) => {
          const data = snapshot.val();
          if (data && data.body.temperature && data.when) {
            debugger;
            const datum = {
              sensor: querySensorName,
              ...data.body,
              timestamp: data.when
            };
            viewof datum.send(datum);
            mutable sample = datum;
            notify(datum);
          }
        });
    })
  </script>
  <script id="31" type="application/vnd.observable.javascript" pinned="">
    mutable sample = undefined
  </script>
  <script id="47" type="application/vnd.observable.javascript">
    import { flowQueue } from "@tomlarkworthy/flow-queue"
  </script>
  <script id="36" type="application/vnd.observable.javascript">
    syncToDuckDB = {
      await duckdb.query(
        `CREATE TABLE IF NOT EXISTS dt(u STRING, x INTEGER, y FLOAT)`
      );
      db.ref(`history/sensors/${querySensorName}`)
        .orderByKey()
        .startAt(Math.floor(Date.now() / 1000 - 60 * 60 * 24) + "") // reduce data returned
        .on("child_added", (snapshot) => {
          const data = snapshot.val();
          debugger;
          if (data) {
            duckdb.query(
              `INSERT INTO sensors VALUES ('a', 1, 5), ('b', 2, 6), ('c', 3, 7), ('d', 4, 8);`
            );
          }
        });
      return "ok";
    }
  </script>
  <script id="69" type="application/vnd.observable.javascript" pinned="">
    viewof datum = flowQueue({
      timeout_ms: 1000000000
    })
  </script>
  <script id="85" type="application/vnd.observable.javascript">
    mutable hasCreatedtable = false
  </script>
  <script id="191" type="application/vnd.observable.javascript" pinned="">
    Inputs.button("refresh table", {
      reduce: () => (mutable hasCreatedtable = false)
    })
  </script>
  <script id="91" type="application/vnd.observable.javascript" pinned="">
    createTable = {
      datum;
      if (!hasCreatedtable) {
        await duckdb.query("DROP TABLE IF EXISTS reading");
        await duckdb.query(
          `CREATE TABLE IF NOT EXISTS reading(${Object.entries(mutable sample)
            .map(([k, v]) =>
              k == "timestamp"
                ? `${k} TIMESTAMP`
                : typeof v === "number"
                ? `${k} FLOAT`
                : typeof v === "string"
                ? `${k} STRING`
                : "error"
            )
            .join(",")})`
        );
        mutable hasCreatedtable = true;
      }
    }
  </script>
  <script id="154" type="application/vnd.observable.javascript" pinned="">
    typeof ""
  </script>
  <script id="116" type="application/vnd.observable.javascript" pinned="">
    insertDatum = {
      createTable; // Do after createTable
      return duckdb.query(
        `INSERT INTO reading (${Object.keys(datum).join(
          ","
        )}) VALUES (${Object.keys(datum)
          .map((key) =>
            key === "timestamp"
              ? `'${new Date(datum.timestamp * 1000).toISOString()}'`
              : `'${datum[key]}'`
          )
          .join(",")});`
      );
    }
  </script>
  <script id="74" type="application/vnd.observable.javascript" pinned="">
    insertReturn = viewof datum.resolve(insertDatum)
  </script>
  <script id="247" type="application/sql" pinned="" database="var:db">

    SELECT *
    FROM 
    (SELECT *, CAST(startTime - endTime as INTERVAL) duration_millis, avgTemp > 15 AND avgTemp < 25 as isGrowth
    FROM (
      SELECT "sensor", 
        MAX(timestamp) OVER interval startTime,
        MIN(timestamp) OVER interval endTime,
        AVG(temperature) OVER interval avgTemp,
      FROM reading
      WINDOW interval AS (
        PARTITION BY "sensor"
        ORDER BY "timestamp" ASC
        ROWS 1 PRECEDING)
      ORDER BY "sensor", "timestamp"
    )
    WHERE duration_millis > INTERVAL 0 SECONDS)

  </script>
  <script id="311" type="application/sql" pinned="" database="var:db">

    SELECT *, CASE WHEN isGrowth THEN EXTRACT(epoch FROM duration_millis) ELSE 0 END growth_secs
    FROM 
    (SELECT *, CAST(startTime - endTime as INTERVAL) duration_millis, avgTemp > 15 AND avgTemp < 25 as isGrowth
    FROM (
      SELECT "sensor", 
        MAX(timestamp) OVER interval startTime,
        MIN(timestamp) OVER interval endTime,
        AVG(temperature) OVER interval avgTemp,
      FROM reading
      WINDOW interval AS (
        PARTITION BY "sensor"
        ORDER BY "timestamp" ASC
        ROWS 1 PRECEDING)
      ORDER BY "sensor", "timestamp"
    )
    WHERE duration_millis > INTERVAL 0 SECONDS)

  </script>
  <script id="350" type="application/vnd.observable.javascript" pinned="">
    31612 
  </script>
  <script id="321" type="application/sql" pinned="" database="var:db">
    SELECT sensor, SUM(CAST(growth_secs AS FLOAT)/ (60 * 60 * 24)) AS growth_days FROM (
    SELECT *, CASE WHEN isGrowth THEN EXTRACT(epoch FROM duration_millis) ELSE 0 END growth_secs
    FROM 
    (SELECT *, CAST(startTime - endTime as INTERVAL) duration_millis, avgTemp > 15 AND avgTemp < 25 as isGrowth
    FROM (
      SELECT "sensor", 
        MAX(timestamp) OVER interval startTime,
        MIN(timestamp) OVER interval endTime,
        AVG(temperature) OVER interval avgTemp,
      FROM reading
      WINDOW interval AS (
        PARTITION BY "sensor"
        ORDER BY "timestamp" ASC
        ROWS 1 PRECEDING)
      ORDER BY "sensor", "timestamp"
    )
    WHERE duration_millis > INTERVAL 0 SECONDS)
    ) group by sensor
  </script>
  <script id="334" type="application/sql" pinned="" database="var:db">
    SELECT 10000000000000 AS INTEGER st;
  </script>
</notebook>
