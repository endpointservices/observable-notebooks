<!doctype html>
<notebook theme="air">
  <title>Ego graph</title>
  <script id="442" type="application/vnd.observable.javascript">
    md`# Ego graph

    Ego graph with selection, used in https://observablehq.com/@tomlarkworthy/google-vs-trick
    `
  </script>
  <script id="659" type="application/vnd.observable.javascript">
    visualization
  </script>
  <script id="7" type="application/vnd.observable.javascript" pinned="">
    viewof visualization = {
      const links = data.links;
      const nodes = data.nodes;

      const forceLink = d3
        .forceLink(links)
        .id((d) => d.id)
        .distance((link) => {
          const scale = d3.scaleSqrt().domain([0, 1]).range([30, 70]);
          return scale(link.distance);
        })
        .strength((link) => 1 / Math.min(link.source.count, link.target.count));

      const simulation = d3
        .forceSimulation(nodes)
        .force("link", forceLink)
        .force("charge", d3.forceManyBody())
        .force("center", d3.forceCenter(width / 2, height / 2));

      const svg = d3
        .create("svg")
        .attr("viewBox", [0, 0, width, height])
        .call(
          d3
            .zoom()
            .scaleExtent([1 / 2, 4])
            .on("zoom", zoomed)
        );

      const container = svg.append("g");

      svg.on("click", (e) => {
        if (e.target === svg.node()) {
          link.style("stroke-opacity", 0.6);
          node.style("opacity", 0.8);
          text.attr("display", "block");
        }
      });

      function zoomed({ transform }) {
        container.attr("transform", transform);
      }

      const defs = svg.append("defs");

      const gradients = defs
        .selectAll("line")
        .data(links)
        .join("linearGradient")
        .attr("gradientUnits", "userSpaceOnUse")
        .attr("id", (d) => "l-" + d.index)
        .attr("x1", (d) => d.source.x)
        .attr("x2", (d) => d.target.x)
        .attr("y1", (d) => d.source.y)
        .attr("y2", (d) => d.target.y);

      function addStop(w) {
        gradients
          .append("stop")
          .attr("offset", `${w * 100}%`)
          .attr("stop-color", (d) =>
            d3.interpolateTurbo(
              ((1 - w) * d.source.depth + w * d.target.depth) * maxDepthInv
            )
          );
      }
      addStop(0);
      addStop(0.5);
      addStop(1);

      // links
      const link = container
        .append("g")
        .attr("stroke-opacity", 0.6)
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("stroke", (d) => `url(#${"l-" + d.index}`)
        .attr("stroke-width", linkWidth);

      const node = container
        .append("g")
        .attr("opacity", 0.8)
        .attr("stroke", "#fff")
        .attr("stroke-width", 2)
        .selectAll("circle")
        .data(nodes)
        .join("circle")
        .attr("r", nodeSize)
        .attr("fill", color)
        .call(drag(simulation));

      node.append("title").text((d) => d.id);

      const text = container
        .append("g")
        .attr("class", "labels")
        .selectAll("g")
        .data(nodes)
        .enter()
        .append("g");

      text
        .append("text")
        .attr("fill", "black")
        .attr("stroke", "#fff")
        .attr("stroke-width", 3)
        .attr("paint-order", "stroke fill")
        .attr("pointer-events", "none")
        .attr("text-anchor", "middle")
        .attr("dy", labeldY)
        .style("font-family", "sans-serif")
        .style("font-size", labelSize)
        .text(function (d) {
          return d.id;
        });

      node.on("click", (_, d) => {
        var _nodes = [d];
        link.style("stroke-opacity", function (l) {
          if (d === l.source) {
            _nodes.push(l.target);
            return 1.0;
          } else if (d === l.target) {
            _nodes.push(l.source);
            return 1.0;
          } else return 0.3;
        });

        node.style("opacity", function (n) {
          return _nodes.indexOf(n) !== -1 ? 0.8 : 0.3;
        });

        text.attr("display", function (t) {
          return _nodes.indexOf(t) !== -1 ? "block" : "none";
        });

        svg.node().value = {
          selected: d,
          neighbourhood: _nodes
        };
        svg.node().dispatchEvent(new Event("input", { bubbles: true }));
      });

      simulation.on("tick", () => {
        link
          .attr("x1", (d) => d.source.x)
          .attr("y1", (d) => d.source.y)
          .attr("x2", (d) => d.target.x)
          .attr("y2", (d) => d.target.y);

        gradients
          .attr("x1", (d) => d.source.x)
          .attr("y1", (d) => d.source.y)
          .attr("x2", (d) => d.target.x)
          .attr("y2", (d) => d.target.y);

        node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);

        text.attr("transform", (d) => `translate(${d.x}, ${d.y})`);
      });

      invalidation.then(() => simulation.stop());

      return svg.node();
    }
  </script>
  <script id="512" type="application/vnd.observable.javascript" pinned="">
    Inputs.table(
      data.links.map((l) => ({ ...l, source: l.source.id, target: l.target.id }))
    )
  </script>
  <script id="649" type="application/vnd.observable.javascript">
    maxDepth = data.nodes.reduce((m, n) => Math.max(m, n.depth), Number.MIN_VALUE)
  </script>
  <script id="636" type="application/vnd.observable.javascript">
    maxDepthInv = 1 / maxDepth
  </script>
  <script id="629" type="application/vnd.observable.javascript" pinned="">
    Inputs.table(data.nodes)
  </script>
  <script id="76" type="application/vnd.observable.javascript" pinned="">
    drag = simulation => {

      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(event,d) {
        d.fx = event.x;
        d.fy = event.y;
      }

      function dragended(event,d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }

      return d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended);
    }
  </script>
  <script id="163" type="application/vnd.observable.javascript" pinned="">
    nodeSize = {
      const scale = d3.scaleSqrt()
        .domain([1, 50])
        .range([5, 15]);
      return d => scale(d.count);
    }
  </script>
  <script id="308" type="application/vnd.observable.javascript" pinned="">
    labelSize = {
      const scale = d3.scaleSqrt()
        .domain([1, 50])
        .range([10, 18]);
      return d => scale(d.count);
    }
  </script>
  <script id="298" type="application/vnd.observable.javascript" pinned="">
    labeldY = {
      return d => 2*nodeSize(d)+2.0
    }
  </script>
  <script id="173" type="application/vnd.observable.javascript" pinned="">
    linkWidth = {
      const scale = d3.scaleSqrt().domain([1, 11]).range([2, 20]);
      return (d) => scale(d.weight);
    }
  </script>
  <script id="537" type="application/vnd.observable.javascript" pinned="">
    nodesById = new Map(data.nodes.map((n) => [n.id, n]))
  </script>
  <script id="26" type="application/vnd.observable.javascript" pinned="">
    color = {
      const scale = d3.scaleOrdinal(d3.schemeCategory10);
      return d => scale(d.depth);
    }
  </script>
  <script id="3" type="application/vnd.observable.javascript">
    data = FileAttachment("poodle (3).json").json()
  </script>
  <script id="32" type="application/vnd.observable.javascript">
    height = 600
  </script>
  <script id="11" type="application/vnd.observable.javascript">
    d3 = require("d3@6")
  </script>
</notebook>
