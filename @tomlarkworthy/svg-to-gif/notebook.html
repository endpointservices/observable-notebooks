<!doctype html>
<notebook theme="air">
  <title>SVG Timeseries to GIF</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# SVG Timeseries to GIF


    Reference an external notebook cell that contains an _SVG_ timeseries:

    ~~~js
      (number) => svg 
    ~~~ 

    or a generator

    ~~~js
       svg*
    ~~~

    and it will loop to a downloadable _gif_

    ## TODO

    switch to https://observablehq.com/@mootari/gif#GifConverter

    ## Change log
    - 2021-01-03: Fixed background and generalized generators
    - 2021-01-27: Updated to use '@tomlarkworthy/metaprogramming' instead of rolling own Runtime manipulation
    - 2021-01-25: Auto set xmlns attributeNS and xlink (see [discusison](https://talk.observablehq.com/t/svg-export-from-a-vega-lite-api-chart-error-on-opening-the-file/4398/6))
    - 2021-01-21: Auto set xmlns attribute to SVG as that is often missing
    - 2021-01-03: Can also render generators.
    `
  </script>
  <script id="438" type="application/vnd.observable.javascript">
    md `## Choose Your Reference`
  </script>
  <script id="3" type="application/vnd.observable.javascript">
    viewof id = {
      const {text} = submit({
        value: searchParams.get("id") || "@tomlarkworthy/svg-boinger"
      });
      text.addEventListener("input", () => {
        let v = text.value, m;
        if (m = /\.js(\?|$)/i.exec(v)) v = v.slice(0, m.index);
        if (m = /^[0-9a-f]{16}$/i.test(v)) v = `d/${v}`;
        if (m = /^https:\/\/(api\.|beta\.|)observablehq\.com\//i.exec(v)) v = v.slice(m[0].length);
        if (v !== text.value) text.value = v;
      });
      text.addEventListener("paste", () => {
        Promises.delay(50).then(() => {
          text.form.dispatchEvent(new CustomEvent("submit", {cancelable: true}));
        });
      });
      return text.form;
    }
  </script>
  <script id="420" type="application/vnd.observable.javascript">
    viewof target = html`<input placeholder="cell name SVG or (t) => SVG" value=${
      searchParams.get("cell") || 'timeseries'
    }>`
  </script>
  <script id="990" type="application/vnd.observable.javascript">
    html`<a href="/@tomlarkworthy/svg-to-gif?id=${id}&cell=${target}&frame_min=${frame_min}&frame_max=${frame_max}&fillStyle=${fillStyle}&frame_duration=${frame_duration}&fps=${fps}">Perm link to your page settings</a>`
  </script>
  <script id="708" type="application/vnd.observable.javascript">
    md`## Here is what we can load`
  </script>
  <script id="120" type="application/vnd.observable.javascript">
    source = peek({
      notebook: id,
      cell: target
    })
  </script>
  <script id="718" type="application/vnd.observable.javascript">
    md`### Choose Your Loop Params`
  </script>
  <script id="478" type="application/vnd.observable.javascript">
    viewof frame_min = number({
      value: searchParams.get("frame_min") || 0,
      description: "frame_min (inclusive)"
    })
  </script>
  <script id="482" type="application/vnd.observable.javascript">
    viewof frame_max = number({
      value: searchParams.get("frame_max") || 3,
      description: "frame_max (exclusive)"
    })
  </script>
  <script id="487" type="application/vnd.observable.javascript">
    viewof frame_duration = number({
      value: searchParams.get("frame_duration") || 3,
      description: "frame_duration (secs)"
    })
  </script>
  <script id="493" type="application/vnd.observable.javascript">
    viewof fps = number({
      value: searchParams.get("fps") || 30,
      description: "fps"
    })
  </script>
  <script id="647" type="application/vnd.observable.javascript">
    viewof fillStyle = html`<input value=${
      new URL(location).searchParams.get("fillStyle") || 'transparent'
    }>`
  </script>
  <script id="729" type="application/vnd.observable.javascript">
    md`### Restart the rendering loop if you change params to fix issues`
  </script>
  <script id="627" type="application/vnd.observable.javascript">
    {
      const button = html`<button>restart`
      button.onclick = (evt) => {
        mutable frame = 0;
      }
      return button;
    }
  </script>
  <script id="1053" type="application/vnd.observable.javascript">
    md`#### Our current frame for rendering`
  </script>
  <script id="514" type="application/vnd.observable.javascript">
    mutable frame = frame_min
  </script>
  <script id="561" type="application/vnd.observable.javascript">
    step = {
      if (isNaN(frame)) {
        mutable frame = frame_min;
        return;
      }
      if (frame == frame_min) {
        console.log("restart");
        mutable gif = new GIF();
      }

      const step = (frame_max - frame_min) / (frame_duration * fps);

      if (frame > frame_max - step - 0.0001) {
        // The end
        if (gif.rendered) return;
        const result = new Promise(resolve => {
          try {
            console.log("render");
            gif.rendered = true;
            const p = mutable gif.render();
            mutable gif.on("finished", resolve);
          } catch (err) {
            // restart on error
            console.log(err);
            mutable frame = frame_min;
          }
        });

        result.then(data => {
          mutable render = data;
        });

        return result;
      } else {
        // step
        console.log("frame " + frame);
        gif.addFrame(canvas, { copy: true, delay: 1000 / fps });
        mutable frame = frame + step;
      }
      return new Promise(() => frame);
    }
  </script>
  <script id="734" type="application/vnd.observable.javascript">
    md`### When the button below appears, your gif is ready.`
  </script>
  <script id="559" type="application/vnd.observable.javascript">
    DOM.download(render,
                 target + ".gif", // optional file name
                 "Download " + target + ".gif")
  </script>
  <script id="848" type="application/vnd.observable.javascript">
    md`### preview gif`
  </script>
  <script id="845" type="application/vnd.observable.javascript">
    html`<img src="${URL.createObjectURL(render, {type: "image/gif"})}">`
  </script>
  <script id="739" type="application/vnd.observable.javascript">
    md`Thanks [@mootari](https://observablehq.com/@mootari) for suggesting to use gif.js in the [talk thread](https://talk.observablehq.com/t/how-to-make-a-gif-e-g-from-an-svg)`
  </script>
  <script id="1044" type="application/vnd.observable.javascript">
    md`### SVG to ImageElement`
  </script>
  <script id="613" type="application/vnd.observable.javascript">
    mutable gif = new GIF 
  </script>
  <script id="533" type="application/vnd.observable.javascript">
    img = {
      return new Promise(resolve => {
        const img = new Image();
        const svg = typeof source === 'function' ? source(frame) : source;
        svg.setAttributeNS(
          "http://www.w3.org/2000/xmlns/",
          "xmlns",
          "http://www.w3.org/2000/svg"
        );
        svg.setAttributeNS(
          "http://www.w3.org/2000/xmlns/",
          "xmlns:xlink",
          "http://www.w3.org/1999/xlink"
        );
        img.onload = () => resolve(img);
        img.src = `data:image/svg+xml;utf8,${encodeURIComponent(svg.outerHTML)}`;
      });
    }
  </script>
  <script id="1048" type="application/vnd.observable.javascript">
    md`### ImageElement to Canvas with background`
  </script>
  <script id="1034" type="application/vnd.observable.javascript">
    canvas = {
      const c = document.createElement('canvas');
      var ctx = c.getContext('2d');
      c.width = img.width;
      c.height = img.height;
      ctx.fillStyle = fillStyle;
      ctx.fillRect(0, 0, img.width, img.height);
      ctx.drawImage(img, 0, 0, img.width, img.height);
      return c;
    }
  </script>
  <script id="877" type="application/vnd.observable.javascript">
    mutable render = null
  </script>
  <script id="999" type="application/vnd.observable.javascript">
    searchParams = new URL(location).searchParams
  </script>
  <script id="982" type="application/vnd.observable.javascript">
    import { peek } from '@tomlarkworthy/metaprogramming'
  </script>
  <script id="556" type="application/vnd.observable.javascript">
    import {GIF} from '@mbostock/canvas-to-gif'
  </script>
  <script id="7" type="application/vnd.observable.javascript">
    import {submit} from "@mbostock/more-deliberate-inputs"
  </script>
  <script id="456" type="application/vnd.observable.javascript">
    import {number} from "@jashkenas/inputs"
  </script>
  <script id="1071" type="application/vnd.observable.javascript">
    import { footer } from "@tomlarkworthy/footer"
  </script>
  <script id="1089" type="application/vnd.observable.javascript" pinned="">
    footer
  </script>
</notebook>
