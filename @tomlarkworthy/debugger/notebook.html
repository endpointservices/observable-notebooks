<!doctype html>
<notebook theme="air">
  <title>Debugger: Notebook Dataflow Debugger (ndd)</title>
  <script id="0" type="text/markdown">
    # Debugger: Notebook Dataflow Debugger (ndd)

  </script>
  <script id="209" type="application/vnd.observable.javascript">
    _ndd = this || // Reuse DOM to keep control state working, but mixin 'vizUpdater'
      htl.html`<div style="display:flex;flex-wrap:wrap; max-height: 200px; ">
            ${viewof clear}
            ${viewof pause}
            ${viewof windowSecs}
            ${viewof timeDelay}
          </div>
          ${(vizUpdater, vizHolder)}
          `
  </script>
  <script id="1710" type="application/vnd.observable.javascript" pinned="">
    b = a + 6
  </script>
  <script id="1708" type="application/vnd.observable.javascript" pinned="">
    viewof a = Inputs.range()
  </script>
  <script id="1690" type="text/markdown">

    A [moldable](https://moldabledevelopment.com/) development tool to help debug [dataflow problems](https://observablehq.com/@observablehq/how-observable-runs) by visualizing all cell state transitions in the containing notebook on a timeline.

    ```js
    import {_ndd} from '@tomlarkworthy/debugger'
    ```

    Thanks to [`@mootari/access-runtime`](https://observablehq.com/@mootari/access-runtime) on which this tool builds upon.


    |Date| Change|
    |---|---|
    | 2025-04-27 | Fixed bug that broke exports by calling observe on unobserved variables
    | 2025-03-11 | Visualize all variables in runtime, better zoom
    | 2024-12-08 | Added dependancy graph and track anon variables too
    | 2023-11-04 | Fixed renaming bug not tracking the new variable name
    |            | Fixed initial variables not triggering
  </script>
  <script id="1674" type="text/markdown">
    ## TODO
    - Reduce volume of signals (filters? Search)
    - Vertical zoom?
    - brush zoom horzintal
  </script>
  <script id="780" type="application/vnd.observable.javascript">
    viewof slider2 = Inputs.range([0, 1], { label: "slide me!" })
  </script>
  <script id="292" type="application/vnd.observable.javascript">
    viewof clicker = Inputs.button("Click me!")
  </script>
  <script id="523" type="application/vnd.observable.javascript" pinned="">
    delayedDependentAsyncComputation = {
      clicker; // create dependancy on clicker cellto resolve a value
      return uid();
    }
  </script>
  <script id="1596" type="application/vnd.observable.javascript" pinned="">
    uid = () => (Math.random() + 1).toString(36).substring(7)
  </script>
  <script id="665" type="text/markdown">
    ## State
  </script>
  <script id="1431" type="application/vnd.observable.javascript">
    mutable extra_excludes = new Set()
  </script>
  <script id="1419" type="application/vnd.observable.javascript" pinned="">
    excludes = descendants(
      await lookupVariable("range", module),
      await lookupVariable("events", module),
      await lookupVariable("dedupe_range", module),
      await lookupVariable("trackedVariables", module),
      ...extra_excludes
    )
  </script>
  <script id="199" type="application/vnd.observable.javascript">
    mutable events = {
      const val = [];
      return val;
    }
  </script>
  <script id="645" type="application/vnd.observable.javascript">
    viewof endTime = Inputs.input(null)
  </script>
  <script id="531" type="text/markdown">
    ### UI
  </script>
  <script id="554" type="text/markdown">
    #### timeline
  </script>
  <script id="1560" type="application/vnd.observable.javascript" pinned="">
    events
  </script>
  <script id="1736" type="application/vnd.observable.javascript" pinned="">
    range = {
      now;
      const end = (endTime || performance.now()) - timeDelay * 1000;
      const start = Math.max(end - windowSecs * 1000);
      if (
        viewof dedupe_range.value[0] !== start ||
        viewof dedupe_range.value[1] !== end
      ) {
        viewof dedupe_range.value[0] = start;
        viewof dedupe_range.value[1] = end;
        viewof dedupe_range.dispatchEvent(new Event("input"));
      }
    }
  </script>
  <script id="1747" type="application/vnd.observable.javascript" pinned="">
    viewof dedupe_range = {
      keepalive(module, "range");
      return Inputs.input([0, 30]);
    }
  </script>
  <script id="556" type="application/vnd.observable.javascript" pinned="">
    viz = {
      const [start, end] = dedupe_range;
      return Plot.plot({
        width,
        marginLeft: 200,
        y: {
          axis: null,
          domain: [
            ...events.reduce((acc, e) => (acc.add(e.name), acc), new Set())
          ].sort()
        },
        x: {
          domain: [start, end],
          type: "time"
        },
        color: {
          domain: ["pending", "fulfilled", "rejected", "idle"],
          range: ["#BBF", "#0F0", "#F44", "#EEE"]
        },
        marks: [
          Plot.ruleY(
            events,
            Plot.selectLast({
              z: "name",
              y: "name",
              stroke: "#EEE",
              strokeDasharray: [2, 3]
            })
          ),
          Plot.barX(
            events,
            Plot.selectLast({
              x1: start,
              x2: start - 60 * 60 * 1000,
              y: "name",
              z: "name",
              text: "name",
              textAnchor: "end",
              dx: -10,
              fill: (d) =>
                d.type === "pending" ? "pending" : end - d.t < 500 ? d.type : "idle"
            })
          ),
          Plot.tickX(events, {
            x: "t",
            y: "name",
            stroke: "type",
            strokeWidth: 2
          }),
          // Plot.arrow(
          //   events.flatMap((e) =>
          //     e.variable._inputs.map((i) => ({
          //       input: i,
          //       variable: e.variable
          //     }))
          //   ),
          //   {
          //     x1: start,
          //     y1: (d) => d.input._name,
          //     x2: start,
          //     y2: (d) => d.variable._name,
          //     bend: true,
          //     stroke: "#ccc",
          //     headLength: 4,
          //     strokeWidth: 1
          //   }
          // ),
          Plot.text(
            events,
            Plot.selectLast({
              x: start,
              y: "name",
              z: "name",
              text: (d) => d.name, // + "\n " + d.variable._definition.toString().slice(0, 30),
              textAnchor: "end",
              dx: -10,
              fill: "black"
            })
          )
        ]
      });
    }
  </script>
  <script id="1013" type="text/markdown">
    #### timeline holder
  </script>
  <script id="564" type="application/vnd.observable.javascript">
    vizHolder = document.createElement("div")
  </script>
  <script id="572" type="application/vnd.observable.javascript">
    vizUpdater = {
      interceptVariables;
      vizHolder.firstChild?.remove();
      vizHolder.appendChild(viz);

    }
  </script>
  <script id="1565" type="text/markdown">
    #### clear button
  </script>
  <script id="1568" type="application/vnd.observable.javascript" pinned="">
    viewof clear = Inputs.button("clear", {
      reduce: () => (mutable events = [])
    })
  </script>
  <script id="622" type="text/markdown">
    #### pause toggle
  </script>
  <script id="626" type="application/vnd.observable.javascript">
    viewof pause = {
      const ui = Inputs.toggle({ label: "pause" });

      const updateEndTime = () => {
        viewof endTime.value = ui.value ? performance.now() : null;
        viewof endTime.dispatchEvent(new Event("input", { bubbles: true }));
      };
      ui.addEventListener("input", updateEndTime);
      return ui;
    }
  </script>
  <script id="804" type="text/markdown">
    #### break toggler
  </script>
  <script id="808" type="application/vnd.observable.javascript">
    viewof breakpoint = Inputs.toggle({ label: "break next?" })
  </script>
  <script id="535" type="text/markdown">
    #### Time window
  </script>
  <script id="540" type="application/vnd.observable.javascript">
    viewof windowSecs = Inputs.range([0.01, 60], {
      value: 30,
      step: 0.01,
      label: "window (secs)"
    })
  </script>
  <script id="1574" type="text/markdown">
    #### Time delay
  </script>
  <script id="1576" type="application/vnd.observable.javascript" pinned="">
    viewof timeDelay = Inputs.range([0, 30], {
      value: 0,
      step: 0.01,
      label: "delay (secs)"
    })
  </script>
  <script id="294" type="text/markdown">
    ## Implementation
  </script>
  <script id="296" type="text/markdown">
    ### Get the runtime
  </script>
  <script id="6" type="application/vnd.observable.javascript">
    import { runtime, modules, main } from "@mootari/access-runtime"
  </script>
  <script id="302" type="text/markdown">
    ### track notebook variables
  </script>
  <script id="1390" type="application/vnd.observable.javascript">
    import {
      variables,
      descendants,
      lookupVariable,
      observe,
      thisModule,
      keepalive
    } from "@tomlarkworthy/runtime-sdk"
  </script>
  <script id="1396" type="application/vnd.observable.javascript">
    viewof allVariables = variables(runtime)
  </script>
  <script id="1405" type="application/vnd.observable.javascript">
    viewof module = thisModule()
  </script>
  <script id="54" type="application/vnd.observable.javascript">
    trackedVariables = [...allVariables]
  </script>
  <script id="313" type="application/vnd.observable.javascript">
    mainVariableNames = trackedVariables.map((v) => v._name)
  </script>
  <script id="108" type="application/vnd.observable.javascript" pinned="">
    interceptVariables = {
      trackedVariables.forEach((v) => interceptVariable(v, invalidation, excludes));
      return Object.fromEntries(trackedVariables.map((v) => [v._name, v]));
    }
  </script>
  <script id="72" type="application/vnd.observable.javascript" pinned="">
    function notify(name, type, value, variable) {
      if (viewof pause.value) return;

      const event = {
        t: performance.now(),
        name: name || variable._definition.toString().slice(0, 30),
        value,
        type,
        variable
      };
      mutable events.push(event);
      while (mutable events.length > 2000) mutable events.shift();

      mutable events = mutable events;
      if (viewof breakpoint.value) {
        debugger;
      }
    }
  </script>
  <script id="1495" type="application/vnd.observable.javascript" pinned="">
    names = ({})
  </script>
  <script id="64" type="application/vnd.observable.javascript" pinned="">
    function interceptVariable(v, invalidation, excludes, firstSeen = false) {
      if (excludes.has(v)) return;
      if (v._name === "now") return;
      if (!v._reachable) return; // causes bugs and there is nothing interesting to debug anyway
      if (!v.ndd) {
        v.ndd = true;
        observe(v, {
          pending: (...args) => notify(v._name, "pending", args[0], v),
          rejected: (...args) => notify(v._name, "rejected", args[0], v),
          fulfilled: (...args) => notify(v._name, "fulfilled", args[0], v)
        });
      }
    }
  </script>
</notebook>
