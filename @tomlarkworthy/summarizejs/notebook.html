<!doctype html>
<notebook theme="air">
  <title>SummarizeJS</title>
  <script id="0" type="text/markdown">
    # SummarizeJS

    Wraps [Observable's inspect](https://github.com/observablehq/inspector) to a single string and enforces a size limit, intended for sending Javascript values to LLM. Inspect is a good base because it includes type information, common edge cases (typed arrays, regex, symbols), truncates long lists and has functionality to expand and contract the represention. For this use-case we expand up to the max_size when possible.
  </script>
  <script id="123" type="application/vnd.observable.javascript">
    viewof max_size = Inputs.range([3, 500], { label: "max size", step: 1 })
  </script>
  <script id="113" type="application/vnd.observable.javascript" pinned="">
    example = summarizeJS(data, { max_size })
  </script>
  <script id="144" type="application/vnd.observable.javascript" pinned="">
    example.length
  </script>
  <script id="7" type="application/vnd.observable.javascript">
    import { inspect, Inspector, src } from "@tomlarkworthy/inspector"
  </script>
  <script id="12" type="application/vnd.observable.javascript">
    data = ({
      nested: {
        date: new Date(),
        fn: function (arg) {},
        symbol: Symbol("cool"),
        nesting: {
          regex: /dsds/,
          map: new Map([
            ["key", "value"],
            ["key2", "value2"]
          ]),
          bar: Array.from({ length: 1000 }).map((_, i) => i)
        }
      },
      obj: {
        nested: Array.from({ length: 1000 }).map((_, i) => i)
      },
      cls: class foo {},
      instance: new URL("https://google.com")
    })
  </script>
  <script id="22" type="application/vnd.observable.javascript">
    function summarizeJS(value, { max_size = 5000 } = {}) {
      // Render the inspected HTML into a temporary <div>
      const inspection = html`<div>${inspect(value)}`;
      let text = postProcess(inspection);
      let prior = undefined;

      // Helper to find all currently collapsed nodes
      const getCollapsed = () => [];

      // Expand collapsed nodes one by one until we exceed max_size
      let el;
      while ((el = inspection.querySelector(".observablehq--collapsed"))) {
        if (!el) break;
        if (text.length >= max_size) break;
        el.dispatchEvent(
          new MouseEvent("mouseup", {
            bubbles: true,
            cancelable: true,
            view: window
          })
        );
        prior = text;
        text = postProcess(inspection);
      }
      // If we've gone over max_size, return the last “prior” snapshot; otherwise current
      const best = prior && text.length > max_size ? prior : text;

      if (best.length > max_size) {
        const trimmed =
          best.slice(0, (max_size - 1) / 2) +
          "…" +
          best.slice(best.length - (max_size - 1) / 2, best.length);
        return trimmed;
      } else return best;
    }
  </script>
  <script id="39" type="application/vnd.observable.javascript" pinned="">
    walked = postProcess(inspect(data))
  </script>
  <script id="96" type="application/vnd.observable.javascript">
    postProcess = (dom) => walk(dom).join("")
  </script>
  <script id="43" type="application/vnd.observable.javascript">
    TEXT = 3
  </script>
  <script id="130" type="application/vnd.observable.javascript" pinned="">
    walk(inspect(data))
  </script>
  <script id="32" type="application/vnd.observable.javascript">
    walk = function walk(dom, elements = []) {
      if (dom.nodeType === TEXT) {
        if (dom.parentNode.className.baseVal == "observablehq--caret") {
        } else if (dom.parentNode.className == "observablehq--key") {
          elements.push(dom.nodeValue.trim());
        } else if (dom.nodeValue == "  … more") {
          elements.push("…more");
        } else {
          elements.push(dom.nodeValue);
        }
        return;
      }
      let skipNext = false;
      let previous = undefined;
      for (let child of dom.childNodes) {
        if (
          child.className == "observablehq--field" &&
          child.firstChild.className == "observablehq--prototype-key"
        ) {
          continue;
        }
        if (
          child.className == "observablehq--field" &&
          previous?.className == "observablehq--field"
        ) {
          elements.push(", ");
        }

        if (child.className == "observablehq--index") {
          skipNext = true;
          continue;
        }
        if (skipNext) {
          skipNext = false;
          continue;
        }
        walk(child, elements);
        previous = child;
      }
      return elements;
    }
  </script>
</notebook>
