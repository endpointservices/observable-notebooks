<!doctype html>
<notebook theme="air">
  <title>Make a Game Part VIIb - Displacement Map deepdive</title>
  <script id="0" type="text/markdown">
    # Make a Game Part VIIb - Displacement Map deepdive



  </script>
  <script id="2298" type="application/vnd.observable.javascript">
    viewof deps = {
      ({
        prompt:
          'Create a DI impelmentation that makes use of Observable resolution.\n\nThe named service should end up bound to an implementation with \n\n"mySystem = deps.resolve("mySystem")"\n\ndifferent implementations are added with\n\n"deps.register("mySystem", <value>, 1)"\n\nwith a monotonic version counter.\n\nthe deps implementation should keep all versions, so we can dynamically switch implementations, e.g. for a/b testing, but by default things should resolve to the highest number.\n\nbecause when deps changes it should dispatch and event, callers will try to reregister. So it should sniff where the call is coming from for deduplication with caller_id and time',
        time: 1699900881324,
        comment: "Create a viewof cell for Dependency Injection container v2"
      });

      const caller_id =
        {
          prompt:
            "Write a function called caller_id that will identifying the source code location by reading a stack trace and hashing it",
          time: 1699860967160,
          comment: "Function for identifying the source code location"
        } &&
        function caller_id() {
          const err = new Error();
          const stack = err.stack.split("\n");
          const sourceLocation = stack[2];
          let hash = 0;
          for (let i = 0; i < sourceLocation.length; i++) {
            const char = sourceLocation.charCodeAt(i);
            hash = (hash << 5) - hash + char;
            hash = hash & hash; // Convert to 32bit integer
          }
          return hash;
        };

      const game_view = Inputs.input();

      class DIContainer {
        constructor() {
          this.dependencies = new Map();
        }

        register(name, factory, version = 0) {
          const caller = caller_id();
          let versions = this.dependencies.get(name);
          if (!versions) {
            versions = {};
            this.dependencies.set(name, versions);
          }

          if (
            !versions[version] ||
            versions[version].trigger_time < Date.now() - 1000
          ) {
            game_view.dispatchEvent(new Event("input"));
          }

          versions[version] = { factory, caller, trigger_time: Date.now() };
          return factory;
        }

        resolve(name) {
          const versions = this.dependencies.get(name);
          if (!versions) return null;
          const maxVersion = Math.max(...Object.keys(versions));
          return versions[maxVersion]?.factory || null;
        }
      }

      game_view.value = new DIContainer();
      return game_view;
    }
  </script>
  <script id="4302" type="application/vnd.observable.javascript">
    import { view } from "@tomlarkworthy/view"
  </script>
  <script id="4064" type="application/vnd.observable.javascript" pinned="">
    html`<h4>crtWarpDisplacementMap</h4><img src=${crtWarpDisplacementMap_v5}>`
  </script>
  <script id="3985" type="application/vnd.observable.javascript">
    viewof crtWarpAdjustment = {
      ({
        prompt:
          "So the CRT display backdrop is barrel warped, and a bit trapazoidal. We need another filter to apply a similar distortion. Create a UI for adjusting barrel warp and trapazoid parameters",
        time: 1701199826611,
        comment:
          "Create a UI for adjusting CRT display barrel warp and trapezoid parameters"
      });

      const crtWarpSettings = view`<div>
        <h2>CRT Warp Adjustment</h2>
        ${[
          "barrel_warp",
          Inputs.range([-512, 512], {
            value: 128,
            step: 0.01,
            label: "Barrel Warp"
          })
        ]}
        ${[
          "trapezoid_warp",
          Inputs.range([-1, 1], {
            value: 0,
            step: 0.01,
            label: "Trapezoid Warp"
          })
        ]}
        ${[
          "warp_scale",
          Inputs.range([0, 100], {
            value: 2,
            step: 0.01,
            label: "Scale"
          })
        ]}
        ${[
          "displacement_size",
          Inputs.range([0, 1024], {
            value: 16,
            step: 0.01,
            label: "Size"
          })
        ]}
      </div>`;

      return crtWarpSettings;
    }
  </script>
  <script id="4095" type="application/vnd.observable.javascript">
    warpImageTest = {
      ({
        prompt:
          "I can;t tell if the warp image generator works, can you draw a checkboard with SVG with the filter applied to test it",
        time: 1701293709944,
        comment:
          "Create a checkerboard SVG with CRT warp filter applied to test the warp image generator"
      });

      const warpFilter = deps.resolve("crtWarpFilter")(0, 0); // Applying moderate barrel warp for test
      const warpMapImage = crtWarpAdjustmentGenerator_v3;

      const checkerboard = htl.svg`<svg width="200" height="200" viewBox="-1 -1 2 2">
        <defs>
          <pattern id="checkerboard" patternUnits="userSpaceOnUse" width="0.2" height="0.2">
            <rect width="0.1" height="0.1" />
            <rect x="0.1" y="0.1" width="0.1" height="0.1" fill="black" />
          </pattern>
          <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:rgb(0,255,0);stop-opacity:1" />
            <stop offset="100%" style="stop-color:rgb(255,0,0);stop-opacity:1" />
          </linearGradient>
          ${warpFilter}
        </defs>
        <rect x="-1" y="-1" width="2" height="2" fill="url(#grad1)" filter="url(#crt-warp)" />
        <rect x="-1" y="-1" width="2" height="2" fill="url(#checkerboard)" filter="url(#crt-warp)" />
      </svg>`;

      return checkerboard;
    }
  </script>
  <script id="4091" type="application/vnd.observable.javascript" pinned="">
    crtWarpAdjustmentGenerator_v3 = ({
      prompt:
        "OK make a new crtWarpAdjustmentGenerator that uses the displacement map",
      time: 1701292141453,
      comment: "Generate CRT warp adjustment filter using the displacement map"
    } &&
      deps.register(
        "crtWarpFilter",
        function crtWarpAdjustmentGenerator(barrel_warp, trapezoid_warp) {
          const warpMapImage = crtWarpDisplacementMap_v5;
          const filter = htl.svg`<filter id="crt-warp" x="0" y="0" width="1" height="1"  color-interpolation-filters="sRGB">
        <feImage href="${warpMapImage}" result="warpMap" />
        <feDisplacementMap in="SourceGraphic" in2="warpMap" scale="${crtWarpAdjustment.warp_scale}" xChannelSelector="R" yChannelSelector="G" />
      </filter>`;
          return filter;
        },
        3
      ))
  </script>
  <script id="4126" type="application/vnd.observable.javascript" pinned="">
    crtWarpDisplacementMap_v5 = {
      ({
        prompt:
          "Maybe barrel distortion is not the right term. I want the corners pulled in. So displacements far from the center should be deflected towards the center",
        time: 1701296188546,
        comment:
          "Generate displacement map for CRT warp effect with corners pulled towards the center"
      });

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = canvas.height = crtWarpAdjustment.displacement_size; // Use a power of 2 for better texture performance

      // Draw the displacement map
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const warpEffect = crtWarpAdjustment.barrel_warp;
      for (let index = 0; index < data.length; index += 4) {
        const x = (index / 4) % canvas.width;
        const y = index / 4 / canvas.width;
        const dy = y / (canvas.height * 1.0) - 0.5;
        let dx = x / (canvas.width * 1.0) - 0.5;

        const distance2 = dx * dx + dy * dy;
        data[index] = 127.5 + dx * distance2 * distance2 * warpEffect; // Red channel for X displacement
        data[index + 1] = 127.5 + dy * distance2 * distance2 * warpEffect; // Green channel for Y displacement
        data[index + 2] = 127; // Blue channel not used
        data[index + 3] = 127; // Alpha channel
      }
      ctx.putImageData(imageData, 0, 0);

      // Convert canvas to an image blob
      const warp = await new Promise((resolve) => {
        canvas.toBlob((blob) => {
          resolve(URL.createObjectURL(blob));
        });
      });

      deps.register("crtWarpDisplacementMap", warp, 4);

      return warp;
    }
  </script>
  <script id="81" type="application/vnd.observable.javascript">
    viewof prompt
  </script>
  <script id="4079" type="text/markdown">
    Sound Effects from <a href="https://pixabay.com/?utm_source=link-attribution&utm_medium=referral&utm_campaign=music&utm_content=106436">Pixabay</a>
  </script>
  <script id="1014" type="application/vnd.observable.javascript">
    Inputs.button("copy code", {
      reduce: () => {
        navigator.clipboard.writeText(suggestion);
      }
    })
  </script>
  <script id="105" type="application/vnd.observable.javascript">
    viewof suggestion
  </script>
  <script id="1463" type="text/markdown">
    ## Current Chat context
  </script>
  <script id="1252" type="application/vnd.observable.javascript">
    viewof context_viz
  </script>
  <script id="1470" type="text/markdown">
    tick the cells to include in the next prompt
  </script>
  <script id="1473" type="application/vnd.observable.javascript">
    viewof feedback_cells_selector
  </script>
  <script id="1542" type="application/vnd.observable.javascript">
    feedback_prompt
  </script>
  <script id="1692" type="text/markdown">
    ### AI Settings
  </script>
  <script id="29" type="application/vnd.observable.javascript">
    viewof OPENAI_API_KEY
  </script>
  <script id="2061" type="application/vnd.observable.javascript">
    viewof api_endpoint
  </script>
  <script id="2163" type="application/vnd.observable.javascript">
    viewof settings
  </script>
  <script id="2193" type="text/markdown">
    ---
  </script>
  <script id="4083" type="application/vnd.observable.javascript" pinned="">
    source["crtWarpDisplacementMap"]
  </script>
  <script id="2114" type="application/vnd.observable.javascript">
    import {
      source,
      code,
      ask,
      excludes,
      cells,
      update_context,
      on_prompt,
      api_call_response,
      mutable context,
      viewof prompt,
      viewof suggestion,
      viewof settings,
      viewof OPENAI_API_KEY,
      viewof api_endpoint,
      feedback_prompt,
      viewof feedback_cells_selector,
      viewof context_viz
    } from "@tomlarkworthy/robocoop"
  </script>
  <script id="2179" type="application/vnd.observable.javascript">
    workers = {
      update_context;
      on_prompt;
      return api_call_response;
    }
  </script>
</notebook>
