<!doctype html>
<notebook theme="air">
  <title>Bluetooth Proxy PoC</title>
  <script id="39" type="application/vnd.observable.javascript">
    md`# Bluetooth Proxy PoC

    Bluetooth does not work in embedded cross-origin iframes. So this is a work around with [serverless cells](https://observablehq.com/@endpointservices/serverless-cells) to get in contact with the Bluetooth API. 

    ![](${await FileAttachment("image.png").url()})

    Open a 2nd tab by clicking: ${
      bluetoothLink.outerHTML
    }. The opened tab is able to communicate back to *this* notebook. And this notebook is able to send commands to it. Thus, we are finally able to use the bluetooth API from a notebook (in theory, I have not fleshed the details out, advice welcome on how to proxy the API without a ton of code).
    `
  </script>
  <script id="71" type="application/vnd.observable.javascript" pinned="">
    selectedBluetoothDeviceId = {
      const events = [];
      return Generators.observe(next => {
        next([]);
        window.onmessage = e => {
          if (e.origin !== "https://endpointservice.web.app") return;

          events.push(e.data);
          next(events);
        };
      });
    }
  </script>
  <script id="3" type="application/vnd.observable.javascript">
    import { deploy } from '@endpointservices/serverless-cells'
  </script>
  <script id="43" type="application/vnd.observable.javascript">
    md`## Cross-origin bridge to child iframe

    The bridge is a child iframe of the observable notebook. As such it cannot open a bluetooth session. However, even though it is cross-origin it can communicate with the parent bidirectionally using postMessage. So we use this to create a converter to https://endpointservice.web.app domain.
    `
  </script>
  <script id="52" type="application/vnd.observable.javascript" pinned="">
    bridgeLink = deploy("bridge", (req, res) => {
      res.send(
        html`
    <h1>Bridge</h1>
    <script>
    var channel = new BroadcastChannel('${req.query.session}');

    // Bluetooth to Parent
    channel.onmessage = function (e) {
      window.parent.postMessage(e.data, 'https://tomlarkworthy.static.observableusercontent.com')
    } 

    // Parent to Bluetooth
    window.onmessage = (e) => {
      channel.postMessage(e.data);
    }

    <\/script>`.outerHTML
      );
    })
  </script>
  <script id="47" type="application/vnd.observable.javascript" pinned="">
    bridge = html`<iframe height="50px" id="bridge" src=${`${bridgeLink.href}?session=${session}`}></iframe>`
  </script>
  <script id="105" type="application/vnd.observable.javascript">
    md`## Bluetooth Page

    The Bluetooth page has to be its own top level page so it can call bluetooth API. It is on https://endpointservice.web.app domain, so it can can also communicate using Broadcast channel with the bridge iframe who is on same-origin, just click the link below to open it!
    `
  </script>
  <script id="115" type="application/vnd.observable.javascript" pinned="">
    bluetoothLink = {
      const baseLink = deploy("bluetooth", (req, res) => {
        res.send(
          html`
          <button id="connectBtn">Connect to Device</button>
          <script>
            var channel = new BroadcastChannel('${req.query.session}');
            const button = document.getElementById("connectBtn");
            button.onclick = async event => {
              event.preventDefault();
              console.log("clicked");
              navigator.bluetooth.requestDevice({acceptAllDevices: true})
              .then(device=>{
                console.log("Device info: ");
                console.log(device);
                channel.postMessage(device.id); // Call the bidge
              })
              .catch(err=>{
                console.log("Error info: "+err.message);
              });
            };
          <\/script>
      `.outerHTML
        );
      });
      return html`<a target="_blank" href="${baseLink.href}?session=${session}">bluetooth</a>`;
    }
  </script>
  <script id="183" type="application/vnd.observable.javascript" pinned="">
    session = randomId(30)
  </script>
  <script id="177" type="application/vnd.observable.javascript" pinned="">
    import { randomId } from '@tomlarkworthy/randomid'
  </script>
  <script id="200" type="application/vnd.observable.javascript" pinned="">
    import { footer } from "@tomlarkworthy/footer"
  </script>
  <script id="218" type="application/vnd.observable.javascript" pinned="">
    footer
  </script>
</notebook>
