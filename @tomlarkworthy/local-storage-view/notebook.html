<!doctype html>
<notebook theme="air">
  <title>localStorageView: Non-invasive local persistance</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# localStorageView: Non-invasive local persistance`
  </script>
  <script id="14" type="application/vnd.observable.javascript">
    md`Lets make it simple to add local storage to a UI control (e.g. [@observablehq/inputs](/@observablehq/inputs))


    We exploit back-writability and input binding to avoid having to mess with existing UI control code.

    _localStorageView(key)_ creates a read/write view of a [safe-local-storage](/@mbostock/safe-local-storage). Because it's a view it can be [_synchronized_](https://observablehq.com/@observablehq/synchronized-inputs) to any control we want to provide persistence for.

    We avoid having to write any _setItem_/_getItem_ imperative wiring.

    If you want all users to share a networked value, consider [shareview](https://observablehq.com/@tomlarkworthy/shareview).

    This works with an view that follows [design guidelines for views](https://observablehq.com/@tomlarkworthy/ui-linter?collection=@tomlarkworthy/ui). A similar notebook for URL query fields is the [urlQueryFieldView](https://observablehq.com/@tomlarkworthy/url-query-field-view).

    ~~~js
        import {localStorageView} from '@tomlarkworthy/local-storage-view'
    ~~~

    ### Change log
    - 2021-11-21: Added json option which is true uses JSON.stringify/parse
    - 2021-10-09: Added defaultValue option
    `
  </script>
  <script id="136" type="application/vnd.observable.javascript">
    md`### Demo

    So starting with an ordinary control:`
  </script>
  <script id="18" type="application/vnd.observable.javascript">
    viewof example1 = Inputs.range()
  </script>
  <script id="26" type="application/vnd.observable.javascript">
    md`We will use the excellent  [@mbostock/safe-local-storage](/@mbostock/safe-local-storage) which very nicely abstracts over enhanced privacy controls with an in memory fallback.`
  </script>
  <script id="11" type="application/vnd.observable.javascript">
    import { localStorage } from '@mbostock/safe-local-storage'
  </script>
  <script id="30" type="application/vnd.observable.javascript">
    md`However, we don't want to have to mess around with our original control to add local persistence. Instead we create a writable [view](https://observablehq.com/@observablehq/introduction-to-views) of a local storage key`
  </script>
  <script id="40" type="application/vnd.observable.javascript" pinned="">
    viewof example1storage = localStorageView("example1")
  </script>
  <script id="37" type="application/vnd.observable.javascript" pinned="">
    localStorageView = (
      key,
      { bindTo = undefined, defaultValue = null, json = false } = {}
    ) => {
      const id = DOM.uid().id;
      const ui = htl.html`<div class="observablehq--inspect" style="display:flex">
        <code>localStorageView(<span class="observablehq--string">"${key}"</span>): </code><span id="${id}">${inspect(
        localStorage.getItem(key) || defaultValue
      )}</span>
      </div>`;
      const holder = ui.querySelector(`#${id}`);

      const view = Object.defineProperty(ui, "value", {
        get: () => {
          const val = json
            ? JSON.parse(localStorage.getItem(key))
            : localStorage.getItem(key);
          return val || defaultValue;
        },
        set: (value) => {
          value = json ? JSON.stringify(value) : value;
          holder.removeChild(holder.firstChild);
          holder.appendChild(inspect(localStorage.getItem(key) || defaultValue));
          localStorage.setItem(key, value);
        },
        enumerable: true
      });

      if (bindTo) {
        Inputs.bind(bindTo, view);
      }

      return view;
    }
  </script>
  <script id="211" type="application/vnd.observable.javascript" pinned="">
    localStorageView.value
  </script>
  <script id="70" type="application/vnd.observable.javascript">
    md`And we bind our original control to the key view`
  </script>
  <script id="72" type="application/vnd.observable.javascript" pinned="">
    // Note you need to get these the right way round to have the page load work correctly
    Inputs.bind(viewof example1, viewof example1storage)
  </script>
  <script id="139" type="application/vnd.observable.javascript">
    md`Tada! that control will now persist its state across page refreshes.`
  </script>
  <script id="220" type="text/markdown">
    ### JSON support

    Set *json* to true to *serde*.
  </script>
  <script id="244" type="application/vnd.observable.javascript" pinned="">
    viewof jsonView = localStorageView("json", {
      json: true
    })
  </script>
  <script id="225" type="application/vnd.observable.javascript" pinned="">
    jsonView
  </script>
  <script id="230" type="application/vnd.observable.javascript" pinned="">
    viewof jsonView.value
  </script>
  <script id="234" type="text/markdown">
    ### Writing
  </script>
  <script id="238" type="application/vnd.observable.javascript" pinned="">
    {
      viewof jsonView.value = {
        rnd: Math.random()
      };
      viewof jsonView.dispatchEvent(new Event("input", { bubbles: true }));
    }
  </script>
  <script id="176" type="application/vnd.observable.javascript">
    md`### In two cells

    It is quite likely we often just want to create the view and bind it to a ui control so just pass the viewof in as the _bindTo_ option in the 2nd argument
    `
  </script>
  <script id="185" type="application/vnd.observable.javascript" pinned="">
    viewof example2 = Inputs.textarea()
  </script>
  <script id="183" type="application/vnd.observable.javascript" pinned="">
    localStorageView("example2", {
      bindTo: viewof example2
    })
  </script>
  <script id="198" type="application/vnd.observable.javascript">
    md`### In a single cell!

    You can even declare a UI control, wrap it with local storage and return in a single cell! (thanks @mbostock!)
    `
  </script>
  <script id="196" type="application/vnd.observable.javascript" pinned="">
    viewof example3 = Inputs.bind(Inputs.textarea(), localStorageView("example3"))
  </script>
  <script id="51" type="application/vnd.observable.javascript">
    import { inspect } from "@tomlarkworthy/inspector"
  </script>
  <script id="214" type="application/vnd.observable.javascript" pinned="">
    //import { footer } from "@endpointservices/endpoint-services-footer"
  </script>
  <script id="216" type="application/vnd.observable.javascript" pinned="">
    footer
  </script>
</notebook>
