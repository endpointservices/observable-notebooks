<!doctype html>
<notebook theme="air">
  <title>Suncalc server for sqlite-http implemented in a notebook</title>
  <script id="0" type="text/markdown">
    # Suncalc server for [sqlite-http](https://github.com/asg017/sqlite-http) implemented in a notebook

    [@asg017](/@asg017) showed using a Deno deployment how to tap into the power of [sqlite-http](https://observablehq.com/@asg017/introducing-sqlite-http) to extend your database with server-defined processing. However, it required setting up a server. We can do that kind of task inline an observable notebook though with less fuss and with faster development loops and debugging out-of-the-box.

    In this notebook I show how easy it is to convert the provided Deno in [introducing-sqlite-http](https://observablehq.com/@asg017/introducing-sqlite-http) to a webcode equivalent. Here is the original code

    ${await FileAttachment("image@1.png").image({style:"width: 500px"})}
  </script>
  <script id="56" type="text/markdown">
    ## And here is the equivalent in Observable/[WEBCode](http://webcode.run/)

  </script>
  <script id="9" type="application/vnd.observable.javascript" pinned="">
    suncalc = require("suncalc@1.9.0/suncalc.js")
  </script>
  <script id="33" type="application/vnd.observable.javascript" pinned="">
    suntimesRoute = new URLPattern({ pathname: "/suncalc" })
  </script>
  <script id="38" type="application/vnd.observable.javascript" pinned="">
    async function handleSuntimes(request) {
      const { latitude, longitude, date } = await request.json();
      const times = suncalc.getTimes(new Date(date), latitude, longitude);
      return Promise.resolve(new Response(JSON.stringify(times), { status: 200 }));
    }
  </script>
  <script id="31" type="application/vnd.observable.javascript" pinned="">
    // deploy server within Observable notebook
    viewof suncalcServer = endpoint(
      "default",
      async (req, res) => {
        debugger; // put a request debugger breakpoint in for demo purposes
        viewof lastRequest.value = req.body; // Also write the incoming request into the lastRequest value
        if (suntimesRoute.test(req.url)) return handleSuntimes(req);
        else res.status(404).send("Not found");
      },
      {
        // Switch on public livecoding so everybody
        // can experience livecoding
        livecode: "public"
      }
    )
  </script>
  <script id="63" type="text/markdown">
    ### Test with

    ```
    curl -X POST '${suncalcServer.href}/suncalc' --data '{"longitude": -118.1498, "latitude": 34.0414, "date": "2020-03-01"}'
    ```
  </script>
  <script id="122" type="text/markdown">
    Note unlike Deno if we are logged with livecoding, we can see the requests get processed, which is very helpful for development of custom functions!
  </script>
  <script id="107" type="application/vnd.observable.javascript">
    viewof lastRequest = Inputs.text({ disabled: true, label: "last request" })
  </script>
  <script id="124" type="text/markdown">
    You can drop the long string which is the livecoding correlation id and just use 
    ```
    https://webcode.run/observablehq.com/@tomlarkworthy/suncalc-server/suncalc
    ```
    as the URL too (but its not live debuggable)
  </script>
  <script id="81" type="text/markdown">
    ## Live debugging

    If you have your browser tools open and you are logged into the webcode endpoint, you should trigger a breakpoint in the request handler! State-of-the-art-debugging and reactive deployment against production endpoints!
  </script>
  <script id="87" type="text/markdown">
    ---

    #### Helpers
  </script>
  <script id="13" type="application/vnd.observable.javascript">
    import { endpoint } from "@endpointservices/webcode"
  </script>
  <script id="73" type="application/vnd.observable.javascript">
    installHere = {
      testing,
        [...document.querySelectorAll("pre")].map((el) =>
          installCopyCode(el, { invalidation })
        );
    }
  </script>
  <script id="70" type="application/vnd.observable.javascript">
    import { installCopyCode } from "@tomlarkworthy/copy-code"
  </script>
  <script id="129" type="application/vnd.observable.javascript">
    import { footer } from "@endpointservices/footer-with-backups"
  </script>
  <script id="148" type="application/vnd.observable.javascript">
    footer
  </script>
</notebook>
