<!doctype html>
<notebook theme="air">
  <title>AI Hackathon</title>
  <script id="0" type="text/markdown">
    # AI Hackathon
  </script>
  <script id="372" type="application/vnd.observable.javascript">
    viewof refresh = Inputs.button("refresh", { value: 1 })
  </script>
  <script id="14" type="application/vnd.observable.javascript">
    viewof OPEN_AI_KEY = refresh &&
      Inputs.bind(
        Inputs.password({
          label: "ChatGPT key"
        }),
        localStorageView("gpt_key")
      )
  </script>
  <script id="299" type="application/vnd.observable.javascript">
    viewof model = Inputs.bind(
      Inputs.select(
        [
          "gpt-4",
          "gpt-4-0314",
          "gpt-4-32k",
          "gpt-4-32k-0314",
          "gpt-3.5-turbo",
          "gpt-3.5-turbo-16k",
          "gpt-3.5-turbo-0301"
        ].sort(),
        {
          label: "model"
        }
      ),
      localStorageView("gpt_model")
    )
  </script>
  <script id="20" type="application/vnd.observable.javascript">
    viewof api_key = Inputs.bind(
      Inputs.password({
        label: "Personal Staging API key"
      }),
      localStorageView("workspace_api_key")
    )
  </script>
  <script id="31" type="application/vnd.observable.javascript">
    viewof flow_version_url = refresh &&
      Inputs.bind(
        Inputs.text({
          label: "flow_version_url",
          width: "100%"
        }),
        localStorageView("flow_version_url")
      )
  </script>
  <script id="116" type="application/vnd.observable.javascript">
    viewof sample_data = Inputs.select(flow.sample_data, {
      label: "dataset",
      format: (x) => x.name,
      value: (x) => x.id
    })
  </script>
  <script id="697" type="application/vnd.observable.javascript">
    viewof flow_version_selection = Inputs.select(flow.versions, {
      label: "version",
      format: (x) => x.name
    })
  </script>
  <script id="253" type="application/vnd.observable.javascript">
    viewof error = Inputs.select(failures, {
      label: "error",
      format: (x) => {
        return (
          flow_version.graph.nodes.find((n) => n.id == x.node_id)?.name +
          " - " +
          x.msg
        );
      },
      width: "100%"
    })
  </script>
  <script id="426" type="application/vnd.observable.javascript">
    Inputs.textarea({
      label: "hint",
      value: hint,
      disabled: true,
      rows: 5
    })
  </script>
  <script id="633" type="text/markdown">
    ### Response decoder
  </script>
  <script id="682" type="application/vnd.observable.javascript">
    hint = {
      try {
        return openAiResponse.choices[0].message.content
          .match(/---([\s\S]*)---([\s\S]*)---/)[1]
          .trim();
      } catch (err) {
        return openAiResponse.choices[0].message.content;
      }
    }
  </script>
  <script id="744" type="application/vnd.observable.javascript" pinned="">
    openAiResponse.choices[0].message.content
  </script>
  <script id="513" type="text/markdown">
    ## Open AI API call configuration
  </script>
  <script id="413" type="application/vnd.observable.javascript" pinned="">
    system_prompt = `You are a very smart and compassionate support agent for a decision engine built on Python talking a inexperienced programmer with not experience of Python. I am trying to build decision for a fin tech application. I have a larger decision flows comprised of different nodes and a python dictionary called data is passed through it. I have an error on a code node.

    I will supply you the JSON definition of my current code node, the python code is in a field called "src"

    The code node has the current set of Python packages availible which might be helpful. 
    zstd 1.5.2.6
    wrapt 1.14.1
    urllib3 1.26.14
    typing-extensions 4.4.0
    sympy 1.11.1
    six 1.16.0
    s3transfer 0.6.0
    runner 0.1.0
    requests 2.28.1
    python-dateutil 2.8.2
    pyrsistent 0.19.3
    pydantic 1.10.4
    protobuf 4.21.12
    packaging 23.0
    orjson 3.8.5
    onnxruntime 1.13.1
    numpy 1.24.1
    mpmath 1.2.1
    jsonschema 4.17.3
    jmespath 1.0.1
    idna 3.4
    humanfriendly 10.0
    flow-utils 0.1.0
    flatbuffers 23.1.4
    fastjsonschema 2.16.2
    email-validator 1.3.0
    dnspython 2.3.0
    connect-schemas 0.1.0
    coloredlogs 15.0.1
    charset-normalizer 2.1.1
    certifi 2022.12.7
    botocore 1.29.51
    boto3 1.26.51
    aws-xray-sdk 2.11.0
    aws-lambda-powertools 1.28.0
    attrs 22.2.0
    simplejson 3.17.2
    awslambdaric 2.0.4
    setuptools 58.1.0
    pip 22.0.4
    Code nodes use Python 3.9

    I access data through a data object, which is a Python dictionary, but also dot notation which I find more readable and simple. To access the attribute "max_age" of the data object you would type data.max_age.

    There is also a params object availible, which is another Python dictionary. You can access attributes by using dot notation as well. To access the attribute "max_age" of params you would type params.max_age.
    If a parameter is not found, you have the option of adding new parameters with all supported datatypes in Python - in this case, please return the updated <params> json.

    Between nodes the data that is being passed must be json serializable. Note that some datatypes in Python are not (e.g. numpy datatypes)

    I will now send you a message about an error in the system as follows
    ---
    <node definition JSON>
    ---
    <error response>
    ---
    <params>
    ---
    <input schema>
    ---

    The first entry of the <error response> is the data object. 

    The last one is the input schema of the decision flow which corresponds to a REST API accepting data as an input. Usually the solution to schema errors is changing the schema as opposed to changing the data.

    You must response with a helpful error explanation including what the new code should look like in a python markdown formatted code block

    More hints for your response: 
    - Please always suggest fixes for the logic and not for the data object!!!! This is very important!
    - Always refer to null and None as None consistently - the system is based on Python. Sometimes you will have missing data marked as null. In your human readable explanation please always use None and not null.


    You must respond **mardown**, always include the complete code. You should include a comment "# I change the following line for you" above any code modification you make on my node. I cannot respond to follow up questions so do not invite me to follow ups.
    `
  </script>
  <script id="271" type="application/vnd.observable.javascript">
    prompt = `
    ---
    ${JSON.stringify(error_node, null, 2)}
    ---
    ${JSON.stringify(error, null, 2)}
    ---
    ${JSON.stringify(flow_version.parameters, null, 2)}
    ---
    ${JSON.stringify(flow_version.input_schema, null, 2)}
    ---`
  </script>
  <script id="293" type="application/vnd.observable.javascript" pinned="">
    settings = ({
      temperature: 0
    })
  </script>
  <script id="581" type="application/vnd.observable.javascript" pinned="">
    examples = []
  </script>
  <script id="579" type="text/markdown">
    ### OpenAI execution
  </script>
  <script id="291" type="application/vnd.observable.javascript" pinned="">
    openAiResponse = {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${OPEN_AI_KEY}`
        },
        body: JSON.stringify({
          model: model,
          messages: [
            {
              role: "system",
              content: system_prompt
            },
            ...examples,
            {
              role: "user",
              content: prompt
            }
          ],
          ...settings
        })
      });

      if (response.status !== 200)
        throw new Error(`${response.status}: ${await response.text()}`);

      return response.json();
    }
  </script>
  <script id="350" type="text/markdown">
    ## Failures

  </script>
  <script id="370" type="application/vnd.observable.javascript" pinned="">
    error_node = flow_version.graph.nodes.find((n) => n.id == error.node_id)
  </script>
  <script id="354" type="application/vnd.observable.javascript">
    failures = executionErrors.concat(runtimeFailures).map((e) => ({
      ...e,
      timings: undefined,
      provenance: undefined
    }))
  </script>
  <script id="344" type="text/markdown">
    ### Execution Failures
  </script>
  <script id="346" type="application/vnd.observable.javascript" pinned="">
    executionErrors = run_result.errors
      ? run_result.errors.map((e) => ({
          ...e,
          name: e.msg
        }))
      : []
  </script>
  <script id="342" type="text/markdown">
    ### Runtime failures
  </script>
  <script id="210" type="application/vnd.observable.javascript">
    errorPages = run_result.nodes
      ? Object.entries(run_result.nodes).flatMap(([id, n]) => n.failure_pages_urls)
      : []
  </script>
  <script id="337" type="application/vnd.observable.javascript" pinned="">
    run_result
  </script>
  <script id="334" type="application/vnd.observable.javascript" pinned="">
    errorPageResponses = promiseRecursive(
      errorPages.map((errorPage) =>
        fetch(
          `https://${workspace.base_url}/run/api/v1/flows/${flow.slug}/author/test-run/${errorPage}`,
          {
            method: "GET",
            headers: {
              "X-Api-Key": `${api_key}`,
              "content-type": "application/json"
            }
          }
        ).then((r) => r.json())
      )
    )
  </script>
  <script id="242" type="application/vnd.observable.javascript" pinned="">
    runtimeFailures = (
      await promiseRecursive(
        errorPageResponses.map(
          async (errorPageResponse) =>
            (
              await (await fetch(errorPageResponse.url)).json()
            ).failure
        )
      )
    ).flat()
  </script>
  <script id="205" type="text/markdown">
    ## Implementaiton
  </script>
  <script id="38" type="application/vnd.observable.javascript">
    config = {
      const url = new URL(flow_version_url);
      return {
        url,
        path: url.pathname,
        org: url.pathname.match(/org\/([^/]*)/)[1],
        ws: url.pathname.match(/ws\/([^/]*)/)[1],
        flow: url.pathname.match(/flow\/([^/]*)/)[1],
        flow_version: url.pathname.match(/version\/([^/]*)/)[1]
      };
    }
  </script>
  <script id="68" type="application/vnd.observable.javascript">
    flow_version = (
      await fetch(
        `https://flow-api.stg.taktile.com/api/v1/flow_versions/${flow_version_selection.id}`,
        {
          headers: {
            accept: "application/json",
            "X-Api-Key": `${api_key}`
          },
          method: "GET"
        }
      )
    ).json()
  </script>
  <script id="81" type="application/vnd.observable.javascript">
    flow = (
      await fetch(`https://flow-api.stg.taktile.com/api/v1/flows/${config.flow}`, {
        headers: {
          accept: "application/json",
          "X-Api-Key": `${api_key}`
        },
        method: "GET"
      })
    ).json()
  </script>
  <script id="79" type="application/vnd.observable.javascript">
    workspace = (
      await fetch(
        `https://flow-api.stg.taktile.com/api/v1/workspaces/${config.ws}`,
        {
          headers: {
            accept: "application/json",
            "X-Api-Key": `${api_key}`
          },
          referrer: "https://app.stg.taktile.com/",
          referrerPolicy: "strict-origin-when-cross-origin",
          method: "GET",
          mode: "cors"
        }
      )
    ).json()
  </script>
  <script id="87" type="application/vnd.observable.javascript" pinned="">
    run_response = (
      await fetch(
        `https://${workspace.base_url}/run/api/v1/flows/${flow.slug}/author/test-run`,
        {
          method: "POST",
          headers: {
            "X-Api-Key": `${api_key}`,
            "content-type": "application/json"
          },
          body: JSON.stringify({
            flow_version: flow_version.id,
            sample_data: sample_data.id,
            flow_version_etag: flow_version.etag
          })
        }
      )
    ).json()
  </script>
  <script id="406" type="application/vnd.observable.javascript" pinned="">
    sample_data.id
  </script>
  <script id="404" type="application/vnd.observable.javascript" pinned="">
    flow
  </script>
  <script id="154" type="application/vnd.observable.javascript">
    mutable poll_iteration = 1
  </script>
  <script id="148" type="application/vnd.observable.javascript">
    poll_response = poll_iteration &&
      fetch(
        `https://${workspace.base_url}/run/api/v1/flows/${flow.slug}/author/test-run?run_id=${run_response.run_id}`,
        {
          headers: {
            "accept-language": "en-DE,en;q=0.9,de-DE;q=0.8,de;q=0.7,en-US;q=0.6",
            "X-Api-Key": `${api_key}`,
            "content-type": "application/json"
          }
        }
      )
  </script>
  <script id="159" type="application/vnd.observable.javascript" pinned="">
    run_result_link = {
      if (poll_response.status == 200) return poll_response.json();
      if (poll_response.status >= 400) throw poll_response.status;
      else {
        await new Promise((resolve) => setTimeout(resolve, 1000));
        mutable poll_iteration = mutable poll_iteration + 1;
      }
    }
  </script>
  <script id="122" type="application/vnd.observable.javascript">
    run_result = (await fetch(run_result_link.url)).json()
  </script>
  <script id="222" type="text/markdown">
    ## Utils
  </script>
  <script id="224" type="application/vnd.observable.javascript">
    function promiseRecursive(obj) {
      const getPromises = (obj) =>
        Object.keys(obj).reduce(
          (acc, key) =>
            Object(obj[key]) !== obj[key]
              ? acc
              : acc.concat(
                  typeof obj[key].then === "function"
                    ? [[obj, key]]
                    : getPromises(obj[key])
                ),
          []
        );
      const all = getPromises(obj);
      return Promise.all(all.map(([obj, key]) => obj[key])).then(
        (responses) => (
          all.forEach(([obj, key], i) => (obj[key] = responses[i])), obj
        )
      );
    }
  </script>
  <script id="5" type="application/vnd.observable.javascript">
    import { localStorageView } from "@tomlarkworthy/local-storage-view"
  </script>
</notebook>
