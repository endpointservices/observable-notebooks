<!doctype html>
<notebook theme="air">
  <title>How to Dataflow merge on Observable</title>
  <script id="0" type="text/markdown">
    # How to [Dataflow](https://observablehq.com/@observablehq/reactive-dataflow) merge on [Observable](https://observablehq.com)  

    *In this series, I will explore programming techniques for the notebook platform [Observable](https://observablehq.com). Today I am looking at how to *merge* multiple reactive Dataflow streams into a single stream. This article assumes you are familiar with [Observable's non-linear reactive program flow](https://observablehq.com/@observablehq/reactive-dataflow) already.*

    A common situation is this: you have a notebook that performs some useful task, and you want to offer a few different ways to start that task. For example, starting something based on configuration obtained from either URL parameters, local storage, or a manual UI. It's a little trickier than you would hope because, if each of these methods is in their own cell [1], then we have multiple distinct data flow pathways converging into a single flow.

    <small>[1] *and they probably should be because of separation-of-concerns*</small>

  </script>
  <script id="30" type="text/markdown">
    | |
    | --- |

    | <center><img height=300 src=${await FileAttachment("OR_fan.png").url()}></img><center>  |
    | --- |


  </script>
  <script id="50" type="text/markdown">
    The core difficulty is if there is no data in a source, its dataflow won't tick, so if the business logic depends on all the input sources, the business logic will not tick either. So this pattern described here will joins the business logic to the sources a different way so that if any of them tick, the business logic will tick too.

    In [ReactiveX](http://reactivex.io/) terms, [Observable](https://observablehq.com)'s dataflow is a *[combineLatest](https://rxjs.dev/api/index/function/combineLatest)* 
    across cell streams, but we want a *[merge](https://rxjs.dev/api/index/function/merge)*.


    | |
    | --- |

    | <img width="100%" src=${await FileAttachment("image.png").url()}></img> | <img width="100%" src=${await FileAttachment("image@1.png").url()}></img>  |
    |---|---|

    So here is how you can do it with *views* and *Inputs.bind*.


  </script>
  <script id="57" type="text/markdown">
    ## Step 1. Create an unresolved view for the business logic to depend on

    We can quickly create an unresolved view with [`Inputs.input()`](https://github.com/observablehq/inputs/blob/main/README.md#inputsinputvalue). We will fan-in sources to this view.

  </script>
  <script id="63" type="application/vnd.observable.javascript" pinned="">
    viewof config = Inputs.input()
  </script>
  <script id="108" type="text/markdown">
    If the business logic extracts parameters from the *config* variable, then it will not run until it is set to a non-*undefined* value (note grey bar on the left of the cell after notebook startup).

    Our example business logic will flash the notebook in a color set by the config.
  </script>
  <script id="72" type="application/vnd.observable.javascript" pinned="">
    businessLogic = {
      yield htl.svg`<svg style="position: fixed;top:0px;height:100%" viewBox="0 0 1 1">
      <rect width="1" height="1" fill=${config.color} />
    </svg>`;
      await new Promise((resolve) => setTimeout(resolve, 100));
      yield undefined;
    }
  </script>
  <script id="117" type="text/markdown">
    ## 2. Setup all the sources to be views

    Next, we need the sources to be emitting their config to a view's value. 

    Often, a source is already a view:

  </script>
  <script id="122" type="application/vnd.observable.javascript" pinned="">
    viewof source1 = Inputs.button("source1: red", {
      required: true,
      reduce: () => ({
        color: "#f002"
      })
    })
  </script>
  <script id="316" type="application/vnd.observable.javascript" pinned="">
    source1
  </script>
  <script id="133" type="text/markdown">
    But even if it isn't, it is trivial to create a view from a dataflow variable by writing into an  [`Inputs.input()`](https://github.com/observablehq/inputs/blob/main/README.md#inputsinputvalue)
  </script>
  <script id="140" type="application/vnd.observable.javascript" pinned="">
    viewof source2 = Inputs.input()
  </script>
  <script id="144" type="application/vnd.observable.javascript" pinned="">
    viewof var2 = Inputs.button("var2: yellow", {
      required: true,
      reduce: () => ({
        color: "#ff04"
      })
    })
  </script>
  <script id="175" type="application/vnd.observable.javascript" pinned="">
    copyVar2IntoSource2 = {
      viewof source2.value = var2;
      viewof source2.dispatchEvent(new Event("input", { bubbles: true }));
    }
  </script>
  <script id="172" type="application/vnd.observable.javascript" pinned="">
    source2
  </script>
  <script id="152" type="text/markdown">
    ## 3. Bind the source views to the fan-in view backwards


  </script>
  <script id="161" type="application/vnd.observable.javascript" pinned="">
    connectSources = {
      // Note these appear to be wired backwards!
      // Source is in the target argument slot!
      // Bind is not symmetrical!
      Inputs.bind(viewof source1, viewof config, invalidation);
      Inputs.bind(viewof source2, viewof config, invalidation);
    }
  </script>
  <script id="192" type="text/markdown">
    Now, if either of the sources fire, the business logic is run. Give it a try on the live notebook at [@tomlarkworthy/merge-dataflow](https://observablehq.com/@tomlarkworthy/merge-dataflow)

    I hope you find that useful and that you find other useful ways to manipulate dataflow!

  </script>
  <script id="390" type="text/html" pinned="">
    <style>
      code {
        border-radius: 20px;
        padding: 4px;
        background-color: #f5f5f5;
      }
    </style>
  </script>
  <script id="355" type="application/vnd.observable.javascript" pinned="">
    import { footer } from "@tomlarkworthy/footer"
  </script>
  <script id="470" type="application/vnd.observable.javascript" pinned="">
    footer
  </script>
</notebook>
