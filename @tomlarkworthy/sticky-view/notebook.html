<!doctype html>
<notebook theme="air">
  <title>Draggable Sticky view</title>
  <script id="0" type="text/markdown">
    # Draggable Sticky view

    Create complex UIs that are always in view and that can be adjusted when needed.

    Adapted from [@mootari/sticky-positioning](https://observablehq.com/@mootari/sticky-positioning)

  </script>
  <script id="2518" type="application/vnd.observable.javascript" pinned="">
    viewof value = stickyView(
      view`<div>
      ${["text", Inputs.textarea({ value: "text" })]}
      ${["number", Inputs.range()]}
    </div>`,
      { offset: 10, left: width * 0.66, right: 25 }
    )
  </script>
  <script id="2593" type="text/markdown">
    Like other composable views, the `stickyView` exposes its child's value in a back-writable way
  </script>
  <script id="2529" type="application/vnd.observable.javascript">
    value
  </script>
  <script id="2364" type="application/vnd.observable.javascript">
    stickyView = (child, { left = 0, right = 0, offset = 0 } = {}) => {
      ({
        prompt:
          "Can we make a movable sticky square, that responds to drag, by unsticking and resticking itself",
        time: 1725222636096
      });
      const dragger = html`<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px">
          <rect x="1" y="1" width="22" height="22" rx="2" fill="white" stroke="black"></rect>
          <circle cx="9" cy="6" r="2"/>
          <circle cx="9" cy="12" r="2"/>
          <circle cx="9" cy="18" r="2"/>
          <circle cx="15" cy="6" r="2"/>
          <circle cx="15" cy="12" r="2"/>
          <circle cx="15" cy="18" r="2"/>
        </svg>`;
      const element = view`<div style="cursor: grab; pointer-events: auto; left: ${left}px; right: ${right}px">
        ${dragger}
        <div>${["...", child]}</div>
      </div>`;

      const container = view`<div style="z-index: 1000; width:100%; height:100%; position: fixed; top:0px; pointer-events: none;touch-action: none">${[
        "...",
        element
      ]}`;
      makeSticky(container, element, { offset });
      makeMovable(dragger, element);
      return container;
    }
  </script>
  <script id="2439" type="application/vnd.observable.javascript">
    function makeSticky(context, element, { offset = 0 } = {}) {
      element.style.position = "absolute";
      return observeViewport((top) => {
        const rc = context.getBoundingClientRect();
        const rs = element.getBoundingClientRect();
        console.log("stickying", offset);
        element.style.top = `${top - rc.top + offset}px`;
      });
    }
  </script>
  <script id="2440" type="application/vnd.observable.javascript">
    function observeViewport(callback) {
      console.log("creating observeViewport");
      let lastTop = -1,
        raf;
      const observer = new IntersectionObserver(([e]) => {
        if (Math.abs(lastTop - e.intersectionRect.top) > 2) {
          console.log(lastTop, e.intersectionRect.top);
          lastTop = e.intersectionRect.top;
          callback(e.intersectionRect.top);
        }
        observer.unobserve(target);
        raf = requestAnimationFrame(observe);
      });
      const target = document.documentElement;
      const observe = () => observer.observe(target);
      observe();

      // Disconnect callback.
      return () => {
        console.log("disconnect");
        cancelAnimationFrame(raf);
        observer.disconnect();
      };
    }
  </script>
  <script id="2385" type="application/vnd.observable.javascript">
    function makeMovable(handle, el) {
      handle.onpointerdown = (e) => {
        let offsetX = e.clientX - el.offsetLeft;
        event.preventDefault();

        function move(event) {
          el.style.left = `${clamp(0, width - 20, event.clientX - offsetX)}px`;
          event.preventDefault();
        }

        function stopDrag() {
          el.style.cursor = "grab";
          document.removeEventListener("pointermove", move);
          document.removeEventListener("pointerup", stopDrag);
        }

        document.addEventListener("pointermove", move);
        document.addEventListener("pointerup", stopDrag);
      };
    }
  </script>
  <script id="2441" type="application/vnd.observable.javascript">
    function clamp(a, b, v) {
      return v < a ? a : v > b ? b : v;
    }
  </script>
  <script id="2314" type="application/vnd.observable.javascript">
    import { makeSticky as makeStickyRaw } from "@mootari/sticky-positioning"
  </script>
  <script id="2311" type="application/vnd.observable.javascript">
    import { view } from "@tomlarkworthy/view"
  </script>
  <script id="2597" type="text/html">
    <div style="height:300px">
  </script>
</notebook>
