<!doctype html>
<notebook theme="air">
  <title>Laser Simulator</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# Laser Simulator
    `
  </script>
  <script id="645" type="application/vnd.observable.javascript">
    viewof run = checkbox({
      options: [{ value: "run", label: "run" }],
      value: "run"
    })
  </script>
  <script id="7" type="application/vnd.observable.javascript">
    {
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      invalidation.then(() => renderer.dispose());
      renderer.setSize(width, height);
      renderer.setPixelRatio(devicePixelRatio);

      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);
      scene.add(buffers.line);

      const composer = new EffectComposer(renderer);
      const renderScene = new RenderPass(scene, camera);
      const bloomPass = new UnrealBloomPass(
        new THREE.Vector2(Math.min(width, 640), height),
        0,
        0.2,
        0.85
      );
      bloomPass.threshold = 0;
      bloomPass.strength = 50.7;
      bloomPass.radius = 1;

      composer.addPass(renderScene);
      composer.addPass(bloomPass);

      const t_start = performance.now();

      renderer.domElement.style = "width: 100%";
      while (true) {
        mutable t = performance.now() - t_start;
        if (run) composer.render();
        yield renderer.domElement;
      }
    }
  </script>
  <script id="281" type="application/vnd.observable.javascript" pinned="">
    mutable t = 0.0
  </script>
  <script id="287" type="application/vnd.observable.javascript" pinned="">
    buffers = {
      const buffers = {
        last_t: 0,
        positions: new THREE.Float32BufferAttribute( (MAX_SEGMENTS) * 3, 3 ),
        colors: new THREE.Float32BufferAttribute( (MAX_SEGMENTS) * 3, 3 ),
        lineGeometry: new THREE.BufferGeometry(),
        lineMaterial: new THREE.LineBasicMaterial( { color: 0xffffff, vertexColors: true} ),
      }
      buffers.lineGeometry.setAttribute('position', buffers.positions)
      buffers.lineGeometry.setAttribute('color', buffers.colors)
      buffers.line = new THREE.Line( buffers.lineGeometry, buffers.lineMaterial )  
      buffers.lineGeometry.setDrawRange(0, MAX_SEGMENTS);
      return buffers;
    };
  </script>
  <script id="148" type="application/vnd.observable.javascript" pinned="">
    draw = {
      const points = [];
      const colors = [];
      const point = new THREE.Vector3();
      const color = new THREE.Color();

      color.setRGB(Math.cos(t * 0.00011) * 0.5 + 1, Math.cos(t * 0.002) * 0.5 + 1, Math.cos(t * 0.003) * 0.5 + 1)

      // We iterate in time new points.
      for ( var i = buffers.last_t; i < t && points.length < MAX_SEGMENTS * 3; i += 10 ) {
        point.x = Math.cos((i * 0.0091)) * 0.9 * width / 2 ;
        point.y = Math.sin((i * 0.015)) * 0.9 * height / 2;
        points.push( point.x, point.y, point.z );
        colors.push(color.r, color.g, color.b);
      }

      // The main stratergy is to shift all the buffers down, and append new data points to the end
      buffers.positions.set(buffers.positions.array.slice(points.length));
      buffers.positions.set(points, MAX_SEGMENTS * 3 - points.length);
      // We also decay the colors by a factor so the old lines fade out
      buffers.colors.set(buffers.colors.array.slice(colors.length).map(x => x * 0.95), 0);
      buffers.colors.set(colors, MAX_SEGMENTS * 3 - colors.length);


      buffers.positions.needsUpdate = true;
      buffers.colors.needsUpdate = true;
      buffers.last_t = t;
    }
  </script>
  <script id="18" type="application/vnd.observable.javascript">
    camera = new THREE.OrthographicCamera( width / - 2, width / 2, height / 2, height / - 2,height / 2, height / - 2);
  </script>
  <script id="52" type="application/vnd.observable.javascript" pinned="">
    height = 600
  </script>
  <script id="105" type="application/vnd.observable.javascript">
    md`Lastly, we load Three.`
  </script>
  <script id="295" type="application/vnd.observable.javascript" pinned="">
    MAX_SEGMENTS = 1000;
  </script>
  <script id="213" type="application/vnd.observable.javascript">
    THREE_VERSION = "0.112.1"
  </script>
  <script id="3" type="application/vnd.observable.javascript">
    THREE = require(`three@${THREE_VERSION}/build/three.min.js`);
  </script>
  <script id="193" type="application/vnd.observable.javascript">
    EffectComposer = (await import(`https://unpkg.com/three@${THREE_VERSION}/examples/jsm/postprocessing/EffectComposer.js?module`)).EffectComposer
  </script>
  <script id="237" type="application/vnd.observable.javascript">
    RenderPass = (await import(`https://unpkg.com/three@${THREE_VERSION}/examples/jsm/postprocessing/RenderPass.js?module`)).RenderPass
  </script>
  <script id="227" type="application/vnd.observable.javascript">
    UnrealBloomPass = (await import(`https://unpkg.com/three@${THREE_VERSION}/examples/jsm/postprocessing/UnrealBloomPass.js?module`)).UnrealBloomPass
  </script>
  <script id="649" type="application/vnd.observable.javascript" pinned="">
    import {checkbox} from "@jashkenas/inputs"
  </script>
  <script id="670" type="application/vnd.observable.javascript" pinned="">
    import { footer } from "@tomlarkworthy/footer"
  </script>
  <script id="688" type="application/vnd.observable.javascript" pinned="">
    footer
  </script>
</notebook>
