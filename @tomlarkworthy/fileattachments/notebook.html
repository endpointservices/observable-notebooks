<!doctype html>
<notebook theme="air">
  <title>Local FileAttachments</title>
  <script id="0" type="text/markdown">
    # Local FileAttachments

    Attach files to notebooks without uploading them anywhere. Massive files, no problem! Offers programmatic access to the FileAttachments too.

    ~~~js
    import {getFileAttachment, setFileAttachment, removeFileAttachment, jsonFileAttachment, createFileAttachment} from '@tomlarkworthy/fileattachments'
    ~~~
  </script>
  <script id="70" type="application/vnd.observable.javascript">
    viewof file = Inputs.file({ label: "add file" })
  </script>
  <script id="73" type="application/vnd.observable.javascript">
    attach_file = {
      setFileAttachment(file);
    }
  </script>
  <script id="193" type="text/markdown">
    Files are stored in `mutable attachments` as a Map of `filename => FileAttachment` which updates reactively.
  </script>
  <script id="91" type="application/vnd.observable.javascript">
    viewof selected = Inputs.select(attachments, { label: "file attachments" })
  </script>
  <script id="200" type="text/markdown">
    The normal FileAttachment API is available so it plays nicely with other features like downloads.
  </script>
  <script id="185" type="application/vnd.observable.javascript">
    download_selected = selected &&
      DOM.download(selected.blob(), selected.name, `Download ${selected.name}`)
  </script>
  <script id="94" type="application/vnd.observable.javascript">
    size_bytes = selected && (await selected.arrayBuffer()).byteLength
  </script>
  <script id="66" type="application/vnd.observable.javascript">
    viewof attachments = Inputs.input(getFileAttachments())
  </script>
  <script id="278" type="application/vnd.observable.javascript">
    jsonFileAttachment = (name, obj) => {
      const str = JSON.stringify(obj);
      const bytes = new TextEncoder().encode(str);
      const blob = new Blob([bytes], {
        type: "application/json;charset=utf-8"
      });
      const url = URL.createObjectURL(blob);
      return createFileAttachment(url, name, "application/json");
    }
  </script>
  <script id="266" type="application/vnd.observable.javascript">
    createFileAttachment = (url, name, mimeType) => {
      const file = new FileAttachmentClass(name, mimeType);
      Object.defineProperty(file, "url", { value: () => url });
      return file;
    }
  </script>
  <script id="31" type="application/vnd.observable.javascript">
    async function setFileAttachment(file, module = main) {
      file = await file;
      if (!file) return;
      let FileAttachment = module._builtins.get("FileAttachment");

      if (!FileAttachment) {
        // dependancies don't have FileAttachment object so lazily create one
        const fileAttachments = new Map();
        FileAttachment = module._runtime.fileAttachments((name) =>
          fileAttachments.get(name)
        );
        module.builtin("FileAttachment", FileAttachment);
      }

      const map = getFileAttachmentsMap(FileAttachment);
      map.set(file.name, await file.url());
      viewof attachments.value = getFileAttachments();
      viewof attachments.dispatchEvent(new Event("input"));
    }
  </script>
  <script id="252" type="application/vnd.observable.javascript">
    getFileAttachment = (name, module = main) =>
      getFileAttachments(module).get(name)
  </script>
  <script id="237" type="application/vnd.observable.javascript">
    removeFileAttachment = function (name, module = main) {
      getFileAttachmentsMap(module._builtins.get("FileAttachment")).delete(name);
      viewof attachments.value = getFileAttachments();
      viewof attachments.dispatchEvent(new Event("input"));
    }
  </script>
  <script id="151" type="application/vnd.observable.javascript">
    function getFileAttachments(module = main) {
      const FileAttachment = module._builtins.get("FileAttachment");
      return new Map(
        [...getFileAttachmentsMap(FileAttachment).entries()].map(
          ([name, payload]) => [name, FileAttachment.call(null, name)]
        )
      );
    }
  </script>
  <script id="15" type="application/vnd.observable.javascript">
    getFileAttachmentsMap = (FileAttachment) => {
      let fileMap;
      const backup_get = Map.prototype.get;
      const backup_has = Map.prototype.has;
      Map.prototype.has = Map.prototype.get = function (...args) {
        fileMap = this;
      };
      try {
        FileAttachment("");
      } catch (e) {}
      Map.prototype.has = backup_has;
      Map.prototype.get = backup_get;
      return fileMap || new Map();
    }
  </script>
  <script id="247" type="application/vnd.observable.javascript">
    FileAttachmentClass = {
      return sampleFileAttachment.__proto__.__proto__.constructor;
    }
  </script>
  <script id="303" type="application/vnd.observable.javascript">
    viewof fileInput = Inputs.file()
  </script>
  <script id="312" type="application/vnd.observable.javascript">
    plainFile = new File([], "cool")
  </script>
  <script id="323" type="application/vnd.observable.javascript">
    sampleFileAttachment = {
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(plainFile);
      viewof fileInput[0].files = dataTransfer.files;
      viewof fileInput[0].dispatchEvent(new Event("input"));
      return viewof fileInput.value;
    }
  </script>
  <script id="441" type="application/vnd.observable.javascript">
    import { runtime, main } from "@tomlarkworthy/runtime-sdk"
  </script>
</notebook>
