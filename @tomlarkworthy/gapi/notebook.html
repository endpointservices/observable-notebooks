<!doctype html>
<notebook theme="air">
  <title>Google API Client</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# Google API Client

    Lets try and make the [Google APIs](https://github.com/google/google-api-javascript-client) easier to use in Observable. Feedback welcome (use the burger menu to the left to 'Add Comment').

    ## Autocomplete!
    If you correctly setup a [discovery doc](https://developers.google.com/apis-explorer/#p/), autocomplete on observable works! Press TAB on the client object after a **.** to see your options! _exampleClient.logging_ should be an autocompleted item in this notebook

    <img width="400px" src="${await FileAttachment("image.png").url()}"></img>

    ## Auth

    I use Google (Cloud) APIs [serverside](https://observablehq.com/@tomlarkworthy/serverless-cells) with a service account, so that's the one way to authorize at the moment. You would use this to access resources owned by yourself.

    You can also let the user grant the webpage access to their personal resources with Oauth2 (e.g. accessing their Google Drive). Please leave comments if you want an example of that.


    ## Use field 'resource' to send a body

    To set the POST request body use the field 'resource', for example:

    ~~~js
      response = await exampleClient.logging.projects.locations.buckets.views.create({
        parent: "projects/endpointserviceusers/locations/europe-west1/buckets/users_europe_west1",
        viewId: "t4",
        resource: {
          "name": "t4",
          "description": "",
          "filter": ""
        }
      })
    ~~~
    `
  </script>
  <script id="331" type="application/vnd.observable.javascript" pinned="">
    signature(createGapi)
  </script>
  <script id="124" type="application/vnd.observable.javascript">
    async function createGapi({
      // Create API key https://cloud.google.com/docs/authentication/api-keys
      apiKey = undefined,
      // Find the APIs you want to use https://developers.google.com/apis-explorer/#p/
      discoveryDocs = [],
      // One way of authenticating is with an access_token
      // gcloud auth print-access-token
      access_token = undefined,
      // Another is with a service account key like
      /*
      {
        "type": "service_account",
        "project_id": "...",
        "private_key_id": "...",
        "private_key": "...",
        "client_email": "...@....iam.gserviceaccount.com",
        "client_id": "....",
        "auth_uri": "https://accounts.google.com/o/oauth2/auth",
        "token_uri": "https://oauth2.googleapis.com/token",
        "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
        "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/....iam.gserviceaccount.com"
      }*/
      service_account_key = undefined
    } = {}) {
      const gapi = await new Promise((resolve, reject) => {
        require("https://apis.google.com/js/api.js")
          .catch(() => {
            window.gapi.load("client:auth2", () => resolve(window.gapi));
          })
          .then(() => {
            window.gapi.load("client:auth2", () => resolve(window.gapi)); // Embeds work?
          });
      });
      await gapi.client.init({
        apiKey,
        discoveryDocs
      });
      // Auth based on config
      if (service_account_key) {
        console.log("Using service account to mint access token");
        access_token = await getAccessTokenFromServiceAccount(service_account_key);
      }
      if (access_token) {
        console.log("Using access token");
        gapi.client.setToken({
          access_token
        });
      }
      return gapi.client;
    }
  </script>
  <script id="259" type="application/vnd.observable.javascript">
    md`## Playground`
  </script>
  <script id="407" type="application/vnd.observable.javascript">
    md`
    A simple way to get an access token for testing is execute:

    ~~~
        gcloud auth print-access-token --project=endpointservices
    ~~~
    `
  </script>
  <script id="190" type="application/vnd.observable.javascript">
    viewof exampleConfigText = Inputs.bind(
      Inputs.textarea({
        value: `{
      "apiKey": "AIzaSyCRV8x-DcOQmZXI_rbEz2-6JCRV7FqIscg",
      "discoveryDocs": ["https://logging.googleapis.com/$discovery/rest?version=v2"],
      "access_token": "ya29.a0AfH6SMB9PzK7H5pFcf3qvyFwp3rukRsWF93crr4unG0UAMJ1u9LaHUQHN_9bS7FhKnN2w7x_0Btuva7FCNVzYCxwwPdnyGdTyBXrdnbSYXgRAK0SDN0csT0-abQNIGjDgH_qp-VaMn_A43MCsvAePWR-9PfW1L9Bvld5z6aSvpRnf7BZiVmk"
    }`,
        rows: 10
      }),
      localStorageView("@tomlarkworthy/gapi")
    )
  </script>
  <script id="277" type="application/vnd.observable.javascript" pinned="">
    config = JSON.parse(exampleConfigText)
  </script>
  <script id="145" type="application/vnd.observable.javascript" pinned="">
    exampleClient = {
      try {
        return await createGapi(config);
      } catch (err) {
        return err;
      }
    }
  </script>
  <script id="72" type="application/vnd.observable.javascript" pinned="">
    response = {
      try {
        return await exampleClient.monitoring.projects.timeSeries.query({
          name: 'projects/endpointservice',
          query: `fetch generic_task
                  | metric 'logging.googleapis.com/user/serverless_cell_duration'
                  | align delta(1h)
                  | every 1h
                  | group_by [metric.namespace], [row_count: row_count()]`
        });
      } catch (err) {
        return err;
      }
    }
  </script>
  <script id="267" type="application/vnd.observable.javascript" pinned="">
    response.body
  </script>
  <script id="449" type="application/vnd.observable.javascript" pinned="">
    response
  </script>
  <script id="95" type="application/vnd.observable.javascript">
    async function getAccessTokenFromServiceAccount(serviceAccountKey) {
      // First create a JWT from the credentials
      const tNow = Math.floor((new Date()).getTime() / 1000);
      const sHeader = JSON.stringify({alg: 'RS256', typ: 'JWT'});
      const sPayload = JSON.stringify({
          iss: serviceAccountKey.client_email,
          scope: "https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform",
          iat: tNow,
          exp: tNow + 600,
          aud: "https://oauth2.googleapis.com/token",
      });
      const JWT = jsrsasign.KJUR.jws.JWS.sign("RS256", sHeader, sPayload, serviceAccountKey.private_key);

      // Swap JWT for access_token
      const tokenResponse = await fetch(
        'https://oauth2.googleapis.com/token',
        {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: `grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&assertion=${JWT}`,
        }
      );

      if (tokenResponse.status != 200) {
        throw new Error(await tokenResponse.text())
      }
      return (await tokenResponse.json()).access_token;
    }
  </script>
  <script id="98" type="application/vnd.observable.javascript">
    jsrsasign = require('https://bundle.run/jsrsasign@10.1.4')
  </script>
  <script id="329" type="application/vnd.observable.javascript">
    import { signature } from '@mootari/signature'
  </script>
  <script id="430" type="application/vnd.observable.javascript" pinned="">
    import { localStorageView } from '@tomlarkworthy/local-storage-view'
  </script>
</notebook>
