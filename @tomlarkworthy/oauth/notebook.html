<!doctype html>
<notebook theme="air">
  <title>Oauth 2.0 Client</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# Oauth 2.0 Client

    Login to 3rd party services like Github/Reddit and obtain an 'access_token' for API usage or identification purposes. 

    Working examples found [here](https://observablehq.com/@tomlarkworthy/oauth-examples).

    `
  </script>
  <script id="281" type="application/vnd.observable.javascript">
    md`## Outputs`
  </script>
  <script id="285" type="application/vnd.observable.javascript">
    md`The authorization link is where users need to be redirected to, in order to login. Probably put it in an anchor on a login form.`
  </script>
  <script id="10" type="application/vnd.observable.javascript">
    authorize_link = {
      // Reference the state transition rules
      initial_state;
      exchange_token;

      return (
        state &&
        AUTHORIZE_URL &&
        `${AUTHORIZE_URL}?${encodeParams({
          client_id: CLIENT_ID,
          redirect_uri: REDIRECT_URI,
          response_type: RESPONSE_TYPE,
          scope: SCOPES.join(" "),
          state: state.state
        })}`
      );
    }
  </script>
  <script id="289" type="application/vnd.observable.javascript">
    md`The state parameter will provide information about the _status_ of the authorization process, and will contain the *access_token*`
  </script>
  <script id="107" type="application/vnd.observable.javascript">
    mutable state = {
      try {
        return JSON.parse(await STORAGE_BACKEND.getItem(CLIENT_ID + AUTHORIZE_URL));
      } catch (err) {
        console.error(err);
        return undefined;
      }
    }
  </script>
  <script id="75" type="application/vnd.observable.javascript">
    md`## Config

    You will have to set the necessary configuration parameters at import time. 
    `
  </script>
  <script id="13" type="application/vnd.observable.javascript">
    CLIENT_ID = undefined
  </script>
  <script id="330" type="application/vnd.observable.javascript">
    md`The name under which the secret has been stored using Serverless Cell [secrets](https://observablehq.com/@endpointservices/secrets). Don't put the actual secret here.`
  </script>
  <script id="5" type="application/vnd.observable.javascript">
    CLIENT_SECRET_SECRET_NAME = undefined
  </script>
  <script id="361" type="application/vnd.observable.javascript">
    md`_If_ sending the client secret in the parameters, what is the name of the parameter? (e.g. client_secret)`
  </script>
  <script id="354" type="application/vnd.observable.javascript">
    CLIENT_SECRET_PARAMETER_NAME = undefined
  </script>
  <script id="364" type="application/vnd.observable.javascript">
    md`Use basic auth to authenticate with token endpoint?`
  </script>
  <script id="349" type="application/vnd.observable.javascript">
    USE_BASIC_AUTH = null
  </script>
  <script id="420" type="application/vnd.observable.javascript">
    md`Endpoint used to initiate auth flow`
  </script>
  <script id="16" type="application/vnd.observable.javascript">
    AUTHORIZE_URL = undefined
  </script>
  <script id="423" type="application/vnd.observable.javascript">
    md`Endpoint later used to change a code for a token.`
  </script>
  <script id="80" type="application/vnd.observable.javascript">
    TOKEN_URL = undefined
  </script>
  <script id="158" type="application/vnd.observable.javascript">
    TOKEN_PARAMS = args => ({})
  </script>
  <script id="386" type="application/vnd.observable.javascript">
    TOKEN_HEADERS = args => ({})
  </script>
  <script id="391" type="application/vnd.observable.javascript">
    TOKEN_BODY = () => undefined
  </script>
  <script id="326" type="application/vnd.observable.javascript">
    RESPONSE_TYPE = "code"
  </script>
  <script id="29" type="application/vnd.observable.javascript">
    REDIRECT_URI = {
      const url = new URL(html`<a href="">`.href);
      url.search = "";
      url.hash = "";
      return url.toString();
    }
  </script>
  <script id="21" type="application/vnd.observable.javascript">
    SCOPES = []
  </script>
  <script id="432" type="application/vnd.observable.javascript">
    md`By default we use local storage with an in-memory fallback for storing the Oauth session state parameter, but you can bring your own. Just define setItem and getItem`
  </script>
  <script id="426" type="application/vnd.observable.javascript">
    STORAGE_BACKEND = localStorage
  </script>
  <script id="448" type="application/vnd.observable.javascript">
    CORS_BYPASS = false
  </script>
  <script id="104" type="application/vnd.observable.javascript">
    md`## State machine`
  </script>
  <script id="179" type="application/vnd.observable.javascript">
    async function setState(newState) {
      if (!CLIENT_ID) return;
      await STORAGE_BACKEND.setItem(
        CLIENT_ID + AUTHORIZE_URL,
        JSON.stringify(newState)
      );
      mutable state = newState;
    }
  </script>
  <script id="310" type="application/vnd.observable.javascript" pinned="">
    initial_state = {
      if (!state && CLIENT_ID) {
        await setState({
          status: "unauthorized",
          state: randomId()
        });
      } else if (!state && !CLIENT_ID) {
        mutable state = {
          status: "unconfigured"
        };
      }
    }
  </script>
  <script id="175" type="application/vnd.observable.javascript" pinned="">
    exchange_token = {
      if (
        state &&
        state.last_code !== pageParams.code &&
        pageParams.code &&
        state.state === pageParams.state
      ) {
        exchange();
      }
    }
  </script>
  <script id="69" type="application/vnd.observable.javascript">
    md`## Calculated values`
  </script>
  <script id="56" type="application/vnd.observable.javascript">
    // https://stackoverflow.com/questions/8648892/how-to-convert-url-parameters-to-a-javascript-object
    pageParams = {
      const urlParams = new URLSearchParams(location.search);
      return Object.fromEntries(urlParams);
    }
  </script>
  <script id="24" type="application/vnd.observable.javascript">
    //https://stackoverflow.com/questions/8135132/how-to-encode-url-parameters
    encodeParams = p =>
      Object.entries(p)
        .map(kv => kv.map(encodeURIComponent).join("="))
        .join("&")
  </script>
  <script id="86" type="application/vnd.observable.javascript">
    md`## Token exchange`
  </script>
  <script id="89" type="application/vnd.observable.javascript">
    exchange = async () => {
      if (!pageParams.code) throw new Error("No CODE to exchange");

      const exchange_url = `${resolveConfig(TOKEN_URL)}?${encodeParams(
        resolveConfig(TOKEN_PARAMS)
      )}`;

      const fetchFn = CLIENT_SECRET_SECRET_NAME || CORS_BYPASS ? tokenProxy : fetch;

      const tokenResponse = await fetchFn(exchange_url, {
        method: "POST",
        headers: resolveConfig(TOKEN_HEADERS),
        body: resolveConfig(TOKEN_BODY)
      });

      try {
        const token = await decodeToken(tokenResponse);
        await setState({
          status: "authorized",
          access_token: token,
          last_code: pageParams.code,
          state: randomId()
        });
      } catch (err) {
        await setState({
          error: err.message,
          status: "unauthorized",
          last_code: pageParams.code,
          state: randomId()
        });
      }
    }
  </script>
  <script id="146" type="application/vnd.observable.javascript">
    tokenDomains = TOKEN_URL ? [new URL(TOKEN_URL).host] : []
  </script>
  <script id="149" type="application/vnd.observable.javascript">
    tokenSecretParams = {
      if (CLIENT_SECRET_PARAMETER_NAME) {
        return {
          [CLIENT_SECRET_PARAMETER_NAME]: CLIENT_SECRET_SECRET_NAME
        };
      } else {
        return {};
      }
    }
  </script>
  <script id="372" type="application/vnd.observable.javascript" pinned="">
    tokenBasicAuth = {
      if (USE_BASIC_AUTH) {
        return {
          protocol: 'RFC 7617',
          username: CLIENT_ID,
          passwordSecret: CLIENT_SECRET_SECRET_NAME
        };
      }
    }
  </script>
  <script id="144" type="application/vnd.observable.javascript">
    import { fetchp as tokenProxy } with {
      tokenDomains as ALLOW_DOMAINS,
      tokenSecretParams as SECRET_PARAMS,
      tokenBasicAuth as BASIC_AUTH
    } from '@tomlarkworthy/fetchp'
  </script>
  <script id="194" type="application/vnd.observable.javascript">
    decodeToken = async response => {
      if (response.status !== 200)
        throw new Error(`Status: ${response.status} ${await response.text()}`);
      const responseText = await response.text();

      // Try JSON decode
      try {
        return JSON.parse(responseText).access_token;
      } catch (err) {
        // OK if not a JSON
      }

      // Try Form decode
      const token = new URLSearchParams(responseText).get('access_token');
      if (token !== null) {
        return token;
      } else {
        throw new Error(`Cannot find token in response: ${responseText}`);
      }
    }
  </script>
  <script id="397" type="application/vnd.observable.javascript" pinned="">
    resolveConfig = arg => {
      if (typeof arg === 'function') {
        return arg({
          CLIENT_ID,
          REDIRECT_URI,
          SCOPES,
          code: pageParams.code,
          state: state.state
        });
      } else {
        return arg;
      }
    }
  </script>
  <script id="94" type="application/vnd.observable.javascript">
    import { localStorage } from "@mbostock/safe-local-storage"
  </script>
  <script id="441" type="application/vnd.observable.javascript">
    import { randomId } from '@tomlarkworthy/secure-random-id'
  </script>
</notebook>
