<!doctype html>
<notebook theme="air">
  <title>Notebook Deploy to S3</title>
  <script id="0" type="text/markdown">
    # Notebook Deploy to S3

    Reads Notebook code (the tar.gz file from the "Download Code" feature), unpacks, and uploads the individual files to S3, guesses MIME type based on file extension and invalidates CloudFront cache if applicable.

    For utility notebooks like this one, you can run them directly from AWS, For example, I uploaded *this* notebook to S3, see:-

    http://tomlarkworthy-access-aws.s3-website.eu-central-1.amazonaws.com/notebooks/1/index.html

    For access direct from a bucket, you will need to set you bucket up for public access and serving static websites. Con: only insecure HTTP access

    https://docs.aws.amazon.com/AmazonS3/latest/userguide/WebsiteHosting.html

    The simplest way to get secure SSL access is to use a CloudFront dsitribution:

    https://aws.amazon.com/premiumsupport/knowledge-center/cloudfront-https-requests-s3/

    then you can access it with SSL through an auto provisioned domain:-

    https://d3gckb7a9lekvd.cloudfront.net/notebooks/1/index.html

    If you wish to automate this notebook, simply rewrite the config cells at import time (https://observablehq.com/@observablehq/introduction-to-imports). 

  </script>
  <script id="6" type="application/vnd.observable.javascript">
    viewof notebookURL = Inputs.bind(
      Inputs.text({
        width: "1vu",
        label: "URL of notebook",
        placeholder: "https://observablehq.com/@tomlarkworthy/notebook-deploy-to-s3"
      }),
      localStorageView(`deploy_to_s3_notebookURL`)
    )
  </script>
  <script id="64" type="application/vnd.observable.javascript">
    notebook = notebookURL.replace('https://observablehq.com/', '')
  </script>
  <script id="271" type="application/vnd.observable.javascript">
    viewof cells = Inputs.bind(
      Inputs.text({
        width: "1vu",
        label: "[Optional] cells (comma seperated)",
        placeholder: "viewof notebookURL, viewof cells"
      }),
      localStorageView(`deploy_to_s3_notebookURL`)
    )
  </script>
  <script id="17" type="application/vnd.observable.javascript">
    viewof s3Target = Inputs.bind(
      Inputs.text({
        width: "1vu",
        label: "S3 bucket + path",
        placeholder: 'tomlarkworthy-access-aws/notebooks/1'
      }),
      localStorageView(`deploy_to_s3_s3target`)
    )
  </script>
  <script id="34" type="application/vnd.observable.javascript">
    bucket = s3Target.split("/")[0]
  </script>
  <script id="37" type="application/vnd.observable.javascript">
    path = s3Target.substring(bucket.length).replace(/^\//, '')
  </script>
  <script id="132" type="application/vnd.observable.javascript">
    viewof manualCredentials
  </script>
  <script id="137" type="application/vnd.observable.javascript">
    saveCreds
  </script>
  <script id="224" type="application/vnd.observable.javascript">
    viewof API_KEY = Inputs.bind(
      Inputs.text({
        width: "1vu",
        label: "[Optional] Observablehq API key"
      }),
      localStorageView(`deploy_to_s3_apikey`)
    )
  </script>
  <script id="246" type="application/vnd.observable.javascript">
    viewof CLOUD_FRONT_DISTRIBUTION_ID = Inputs.bind(
      Inputs.text({
        width: "1vu",
        label: "[Optional] Cloud Front distribution ID"
      }),
      localStorageView(`deploy_to_s3_cf_d_id`)
    )
  </script>
  <script id="249" type="application/vnd.observable.javascript">
    viewof INVALIDATION_PATH = Inputs.bind(
      Inputs.text({
        width: "1vu",
        label: "[Optional] Cloud Front paths",
        placeholder: "/notebooks/1/index.*"
      }),
      localStorageView(`deploy_to_s3_cf_path`)
    )
  </script>
  <script id="291" type="application/vnd.observable.javascript" pinned="">
    viewof indexHtml = Inputs.bind(
      Inputs.textarea({
        width: "1vu",
        rows: 50,
        label: "[Optional] Optional index.html"
      }),
      localStorageView(`deploy_to_s3_index.html`)
    )
  </script>
  <script id="182" type="application/vnd.observable.javascript">
    viewof uploadButton = Inputs.button("Deploy", {
      reduce: async () => {
        const url = `https://api.observablehq.com/${notebook}.tgz?v=3${
          API_KEY.length > 0 ? `&api_key=${API_KEY}` : ""
        }`;
        const response = await fetch(url);
        if (response.status !== 200)
          throw new Error(`${response.status} ${await response.text()}`);
        mutable gzTarBytes = response.arrayBuffer();
        mutable deployed = false;
      }
    })
  </script>
  <script id="57" type="application/vnd.observable.javascript">
    mutable gzTarBytes = undefined
  </script>
  <script id="114" type="application/vnd.observable.javascript">
    tarBytes = {
      const buffer = new Uint8Array(gzTarBytes);
      return await pako.ungzip(buffer);
    }
  </script>
  <script id="87" type="application/vnd.observable.javascript">
    files = await untar(tarBytes.buffer)
  </script>
  <script id="233" type="application/vnd.observable.javascript">
    mutable deployed = false
  </script>
  <script id="185" type="application/vnd.observable.javascript">
    md`Current: ${files[index].name}`
  </script>
  <script id="81" type="application/vnd.observable.javascript">
    mutable index = (files, 0)
  </script>
  <script id="146" type="application/vnd.observable.javascript">
    currentFile = files[index]
  </script>
  <script id="149" type="application/vnd.observable.javascript" pinned="">
    uploader = {
      // upload current file
      const filename = files[index].name.replace("./", "");
      if (filename === "index.html" && indexHtml.length > 0) {
        files[index].buffer = indexHtml; // Not really a buffer but putObject accepts both
      }
      await putObject(bucket, path + "/" + filename, files[index].buffer, {
        ContentType: mimetypes.contentType(filename)
      });

      if (index < files.length - 1) {
        // next file
        mutable index = mutable index + 1;
      } else {
        // done!
        // Invalidate cloud front cache if needed.
        if (CLOUD_FRONT_DISTRIBUTION_ID.length > 0) {
          await createInvalidation(CLOUD_FRONT_DISTRIBUTION_ID, [
            INVALIDATION_PATH
          ]);
        }
        mutable deployed = true;
      }
    }
  </script>
  <script id="151" type="application/vnd.observable.javascript">
    REGION = 'eu-central-1'
  </script>
  <script id="14" type="application/vnd.observable.javascript">
    import {
      viewof manualCredentials,
      saveCreds,
      putObject,
      createInvalidation
    } with { REGION } from "@tomlarkworthy/aws"
  </script>
  <script id="41" type="application/vnd.observable.javascript">
    import { localStorageView } from '@tomlarkworthy/local-storage-view'
  </script>
  <script id="60" type="application/vnd.observable.javascript">
    import { getMetadata } from '@mootari/notebook-data'
  </script>
  <script id="167" type="application/vnd.observable.javascript">
    mimetypes = import('https://cdn.skypack.dev/mime-types@2.1.32?min')
  </script>
  <script id="91" type="application/vnd.observable.javascript">
    jszip = require("jszip@3/dist/jszip.min.js")
  </script>
  <script id="105" type="application/vnd.observable.javascript">
    pako = require('https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.3/pako.es5.min.js')
  </script>
  <script id="109" type="application/vnd.observable.javascript">
    untar = require('js-untar')
  </script>
</notebook>
