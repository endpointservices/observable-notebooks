<!doctype html>
<notebook theme="air">
  <title>Lopepage</title>
  <script id="393" type="text/html">
    <div id="lopepage" style="height: ${isOnObservableCom() ? '800px' : '100vh'}">
      ${lopeviz_handle_css}
      ${base_css}
      ${light_theme_css}
      <style>
        body {
          max-width: 100vw;
        }
        #lopepage:has(.observablehq-root) > .module-explorer {
          display: none;
        }
      </style>
      <h1 style="display:none;">Lopepage</h1>
      <div class="module-explorer">
        Lost? Open the <a href="${linkTo('@tomlarkworthy/module-selection', {onObservable: false})}">module explorer</a>
      </div>
    </div>
  </script>
  <script id="2516" type="application/vnd.observable.javascript">
    auto_attach = {
      // If exported in headless mode, this will attach the page
      if (!page.isConnected) {
        document.body.appendChild(page);
      }
    }
  </script>
  <script id="2834" type="text/html">
    <h2>Manual Testing links</h2>
    <ul>
    <li><a href="https://observablehq.com/@tomlarkworthy/lopepage#testNavigation">refresh page</a></li>
    <li><a href="#testNavigation">reset view</a></li>
    <li><a href="${linkTo("@tomlarkworthy/stream-operators", {onObservable: false})}">stream-operators</a> module</li>
    <li><a href="${linkTo("@tomlarkworthy/stream-operators#combineLatest", {onObservable: false})}">stream-operators#combineLatest</a> 
    <li><a href="${linkTo("@tomlarkworthy/runtime-sdk#observe", {onObservable: false})}">runtime-sdk#observe</a> cell</li>
    </ul>
  </script>
  <script id="2116" type="text/markdown">
    ## TODO

    ### Lopepage
    - <strike>links should use URL param structure</strike>
      - links are not updated when dynamically added (e.g. after opening a module)
    - <strike>Should load headlessly so we don't see imports at bottom</strike>
    - Can reliably load random notebooks
    - Support opening FileAttachments directly (e.g. blobs)

    ### Module-selection


    ### Exporter

    - close open editor when deleting
    - katex should be offline

    ### Editor / Context-Menu

    ### Visualizer

    ### debugger
    - <strike>something module load failure -- its not reliable tomlarkworthy_jumpgate_20250426T170239Z.html does it sometimes. Its the observe call breaks things</strike>
    - hover over menu to see what things are better?
    - Not offline-first yet

    ### decompiler
    - Does not handle static class class properly.

    ### tests
    - within notebook cell links don't work on second click
  </script>
  <script id="1727" type="application/vnd.observable.javascript">
    sync_module_tabs = {
      const module_items = layout.root
        .getAllContentItems()
        .filter((ci) => ci.componentName == "module");

      const modulePanel_diff = unorderedSync(
        selected_modules,
        module_items,
        (a, b) => a.name == b.title
      );
      modulePanel_diff.add.forEach((moduleInfo) => {
        layout.root.addItem({
          type: "component",
          title: moduleInfo.name,
          componentName: "module",
          componentState: { cell: moduleInfo.cell }
        });
      });

      // links with cells in them need scrolling
      const cells = selected_modules.filter((m) => m.cell);
      cells.forEach((module) => {
        console.log(`scrolling ${module.name} to ${module.cell}`);
        const item = module_items.find((item) => item.title == module.name);
        const node = visualizer_cache.get(module.module);
        const cell = module.module._scope.get(module.cell);
        fix_scroll(item.container, item.component, node, cell);
      });

      modulePanel_diff.remove.forEach((item) => {
        item.remove();
      });
    }
  </script>
  <script id="1892" type="application/vnd.observable.javascript">
    sync_layout_url = {
      const hashParams = new URLSearchParams(location.hash.slice(1));
      if (!config.root) return;
      const view = serializeGoldenDSL(config.root);
      if (hashParams.get("view") !== view) {
        hashParams.set("view", serializeGoldenDSL(config.root));
        const link = html`<a href="#${hashParams.toString()}">view`;
        setTimeout(() => link.click(), 0);
        console.log("sync_layout_url", link.href);
        return link;
      }
    }
  </script>
  <script id="2009" type="application/vnd.observable.javascript">
    onLoadConfig = {
      exportState; // after URL is set by exporter
      try {
        return parseGoldenDSL(
          new URLSearchParams(location.hash.substring(1)).get("view")
        );
      } catch (err) {
        return undefined;
      }
    }
  </script>
  <script id="2495" type="application/vnd.observable.javascript">
    visualizer_cache = new Map()
  </script>
  <script id="1603" type="application/vnd.observable.javascript" pinned="">
    modulePanel = function (container, component) {
      console.log("new module panel", component);
      const moduleInfo = [...currentModules.values()].find(
        (m) => m.name == container.title
      );
      if (!moduleInfo) return;

      const module = moduleInfo.module;
      let node = undefined;
      if (!visualizer_cache.has(module)) {
        node = visualizer(runtime, {
          invalidation: new Promise((r) => {}),
          module,
          detachNodes: true,
          filter: (cell_name) => {
            const result =
              typeof cell_name != "string" || !cell_name.startsWith("module ");

            return result;
          }
        });
        visualizer_cache.set(module, node);
      } else {
        node = visualizer_cache.get(module);
      }

      const cell = module._scope.get(component.cell);

      fix_scroll(container, component, node, cell);

      container.getElement().addEventListener("scroll", (event) => {
        container.extendState({
          scrollTop: container.scrollTop || container.state.scrollTop,
          scrollLeft: container.scrollLeft || container.state.scrollLeft
        });
      });
    }
  </script>
  <script id="2651" type="application/vnd.observable.javascript">
    blobPanel = function (container, component) {
      const node = document.createElement("iframe");
      node.src = component.url;
      const c_element = container.getElement();
      const element = c_element.appendChild(node);
    }
  </script>
  <script id="1665" type="application/vnd.observable.javascript" pinned="">
    fix_scroll = function (container, component, node, cell_variable) {
      // maintain scroll position in the state
      const c_element = container.getElement();
      const element = c_element.appendChild(node);
      const setScroll = () => {
        component = container.state;
        if (cell_variable) {
          const dom =
            cell_variable._observer._node ??
            c_element.querySelector(`div[cell='${cell_variable._name}']`);
          if (dom) {
            const top = dom.offsetTop - c_element.offsetTop;
            c_element.scrollTop = top;
            container.extendState({
              scrollTop: top
            });
          }
        } else {
          if (component.scrollTop) c_element.scrollTop = component.scrollTop;
          if (component.scrollLeft) c_element.scrollLeft = component.scrollLeft;
        }
      };
      setScroll();
      //node.style.visibility = "hidden";
      container.on("open", () => {
        setScroll();
        // Ugly this requires 2 animation frames to settle :/
        requestAnimationFrame(() => {
          setScroll();
          requestAnimationFrame(() => {
            setScroll();
            requestAnimationFrame(() => {
              // actually needs 3 for mobile :s
              setScroll();
            });
          });
        });
      });
    }
  </script>
  <script id="1941" type="application/vnd.observable.javascript">
    settings = ({
      showMaximiseIcon: false,
      showPopoutIcon: false,
      showCloseIcon: true,
      hasHeaders: true
    })
  </script>
  <script id="765" type="application/vnd.observable.javascript">
    is_mobile = width < 800
  </script>
  <script id="386" type="application/vnd.observable.javascript">
    mutable config = {
      if (onLoadConfig) {
        return {
          settings: settings,
          content: [onLoadConfig]
        };
      }
      return {
        settings: settings
      };
    }
  </script>
  <script id="2623" type="application/vnd.observable.javascript" pinned="">
    resize = Generators.observe((notify) => {
      notify(undefined);
      addEventListener("resize", notify);
      invalidation.then(() => removeEventListener("resize", notify));
    })
  </script>
  <script id="388" type="application/vnd.observable.javascript">
    layout = {
      resize;
      const layout = new gl.GoldenLayout(mutable config, page);
      layout.registerComponent("module", modulePanel);
      layout.registerComponent("blob", blobPanel);
      layout.init();
      invalidation.then(() => layout.destroy()); // avoid layouts stacking up
      return layout;
    }
  </script>
  <script id="425" type="application/vnd.observable.javascript" pinned="">
    layout_state = layout.on("stateChanged", () => {
      const state = gl.LayoutConfig.fromResolved(layout.toConfig());
      console.log("stateChanged", state);
      mutable config = state;
    })
  </script>
  <script id="1607" type="application/vnd.observable.javascript" pinned="">
    background_jobs = {
      onLoadConfig;
      layout_state;
      sync_layout_url;
      sync_module_tabs;
      runtime;
      navigator_jobs;
      context_menu;
    }
  </script>
  <script id="1114" type="text/markdown">
    ## Imports
  </script>
  <script id="383" type="application/vnd.observable.javascript">
    import {
      gl,
      base_css,
      light_theme_css
    } from "@tomlarkworthy/golden-layout-2-6-0"
  </script>
  <script id="7" type="application/vnd.observable.javascript">
    import {
      unorderedSync,
      runtime,
      visualizer,
      Inspector,
      lopeviz_handle_css
    } from "@tomlarkworthy/visualizer"
  </script>
  <script id="1804" type="application/vnd.observable.javascript">
    import {
      viewof notebookModule,
      currentModules,
      viewof selected_modules,
      navigator_jobs,
      serializeGoldenDSL,
      parseGoldenDSL,
      linkTo,
      exportState,
      persistedAttachments,
      getHashModules
    } from "@tomlarkworthy/module-selection"
  </script>
  <script id="2575" type="application/vnd.observable.javascript">
    import {
      lookupVariable,
      getPromiseState,
      thisModule,
      ascendants,
      toObject,
      isOnObservableCom
    } from "@tomlarkworthy/runtime-sdk"
  </script>
  <script id="2193" type="application/vnd.observable.javascript">
    context_menu
  </script>
  <script id="2190" type="application/vnd.observable.javascript">
    import { context_menu } from "@tomlarkworthy/editor-4"
  </script>
</notebook>
