<!doctype html>
<notebook theme="air">
  <title>Globally Synchronized Views</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# Globally Synchronized Views

    <img style="max-width: 640px" src=${await FileAttachment(
      "shareview.png"
    ).url()}></img>

    When collaborating it is sometimes desirable that everyone sees exactly the same thing.

    This notebook adds a \`share(key, view)\` which will globally synchronize the view (and remember it between sessions). The view argument must conform to [best practices](https://observablehq.com/@tomlarkworthy/ui-linter), such as [@observablehq/inputs](https://observablehq.com/@observablehq/inputs) or a native input. In particular, it needs to be a writable *viewof*.

    The result of a _share_ call is a link to a [REST API](https://firebase.google.com/docs/reference/rest/database), so you can even manipulate the control outside of a notebook.

    ~~~js
        import {share} from '${await getCurrentPinnedName()}'
    ~~~

    To use:
    ~~~js
      share("uniqueKey", viewof range)
    ~~~

    There is a unique keyspace for each notebook URL, so forks will have their own settings.

    Thanks [@enjalot](https://observablehq.com/@enjalot) for coming up with the idea and sparring solutions.

    shareview uses isTrusted to detect whether a change was by a user or not, which avoids self triggering loops when syncronizing with the server. However, sometimes a component has to raise events manually and it is not possible to set isTrusted on the raised events. So for synthetic events you wish to be serialized,sSet _isUser_ to true inside the "details" object of a CustomEvent object.

    `
  </script>
  <script id="166" type="application/vnd.observable.javascript">
    md`## Demo

    Open this <a target="_blank" href="https://observablehq.com/@tomlarkworthy/shareinput">notebook</a> twice
    `
  </script>
  <script id="22" type="application/vnd.observable.javascript">
    viewof range = html`<input type="range">`
  </script>
  <script id="26" type="application/vnd.observable.javascript" pinned="">
    share("range", viewof range)
  </script>
  <script id="65" type="application/vnd.observable.javascript">
    md`---`
  </script>
  <script id="168" type="application/vnd.observable.javascript">
    signature(share, {
      description:
        "Synchronizes an *viewof* to a notebook scoped *key*. Returns a link to a RESTful resource URL, which you can also GET and PUT"
    })
  </script>
  <script id="68" type="application/vnd.observable.javascript" pinned="">
    async function share(
      key, // Key is notebook scoped storage location to use (typically unique within a notebook)
      view // View is a viewof component like Range. Should be writable
    ) {
      if (typeof key !== 'string')
        throw new Error("First arg of share, 'key', must be a string");
      if (view.value === undefined)
        throw new Error("Sencond arg of share, 'view', must be a viewof");

      const dbRef = db.ref(
        `/shareinput/${FKEY.encode(
          html`<a href>`.href.split('?')[0]
        )}/${FKEY.encode(key)}`
      );

      const inputListener = e => {
        // update the value in firebase only if the user triggered it via user interaction
        if (e.isTrusted || e.isUser) dbRef.set(view.value);
      };

      const dbListener = snapshot => {
        const val = snapshot.val();
        if (val) {
          // val can be null when first used
          view.value = val;
          view.dispatchEvent(new Event('input'));
        }
      };

      view.addEventListener("input", inputListener);
      dbRef.on('value', dbListener);

      invalidation.then(() => {
        view.removeEventListener("input", inputListener);
        dbRef.off('value', dbListener);
      });

      return html`<a target="_blank" href="${dbRef.toString() +
        ".json"}">${key}</a>`;
    }
  </script>
  <script id="194" type="application/vnd.observable.javascript">
    md`---

    ### Synchronized inputs

    If you map two controls to a single key then you get [synchronized input](https://observablehq.com/@observablehq/synchronized-inputs) behavior.
    `
  </script>
  <script id="197" type="application/vnd.observable.javascript" pinned="">
    viewof differentRange = html`<input type="range">`
  </script>
  <script id="199" type="application/vnd.observable.javascript" pinned="">
    share("range", viewof differentRange)
  </script>
  <script id="212" type="application/vnd.observable.javascript">
    md`### Generalized JSON syncing

    So even complex UIs, as long as they follow [best practices](https://observablehq.com/@tomlarkworthy/ui-linter) they should work.
    `
  </script>
  <script id="227" type="application/vnd.observable.javascript">
    viewof sliders = verticalSliders({
      names: 'shareinput'
    })
  </script>
  <script id="232" type="application/vnd.observable.javascript" pinned="">
    share("sliders", viewof sliders)
  </script>
  <script id="224" type="application/vnd.observable.javascript">
    import { verticalSliders } from '@tomlarkworthy/vertical-sliders'
  </script>
  <script id="28" type="application/vnd.observable.javascript">
    md`---`
  </script>
  <script id="49" type="application/vnd.observable.javascript">
    md`### Realtime Database

    We use Firebase realtime database as it has the lowest latency. Its an unpaid account so you cannot possibly bankrupt me, and I am happpy to share this one. BUT, the possibility exists of a non-community minded individual exhausts the credit. In this case, you are able to bring-your-own firebase by overriding FIREBASE_CONFIG, and you can even clientside secure your instance with security rules and a login if you wish.

    The current rules are:

    <img width=300 src=${await FileAttachment("image.png").url()}></img>
    `
  </script>
  <script id="39" type="application/vnd.observable.javascript">
    db = firebase.database()
  </script>
  <script id="33" type="application/vnd.observable.javascript">
    FIREBASE_CONFIG = ({
      apiKey: "AIzaSyAqtghLj-S9NX0rj11ynWIovHOj3Wx9bqQ",
      databaseURL: "https://calculus-d7a63.firebaseio.com",
      projectId: "calculus-d7a63",
      appId: "1:55204078424:web:ee6243e9fcb0578e653b2d"
    })
  </script>
  <script id="31" type="application/vnd.observable.javascript">
    import { firebase, FKEY } with {
      FIREBASE_CONFIG as firebaseConfig
    } from '@tomlarkworthy/firebase'
  </script>
  <script id="124" type="application/vnd.observable.javascript">
    import { resize } from '@endpointservices/resize'
  </script>
  <script id="154" type="application/vnd.observable.javascript">
    md`---
    ### [@Mootari's](https://observablehq.com/@mootari) usefuls and handies
    `
  </script>
  <script id="83" type="application/vnd.observable.javascript">
    import { getCurrentPinnedName } from '@mootari/notebook-data@366'
  </script>
  <script id="162" type="application/vnd.observable.javascript">
    import { signature } from '@mootari/signature'
  </script>
</notebook>
