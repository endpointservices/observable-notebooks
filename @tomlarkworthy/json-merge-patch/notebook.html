<!doctype html>
<notebook theme="air">
  <title>JSON-merge-PATCH Calculator (RFC 7386)</title>
  <script id="0" type="text/markdown">
    # JSON-merge-PATCH Calculator (RFC 7386)
  </script>
  <script id="7" type="application/vnd.observable.javascript">
    viewof source = Inputs.textarea({
      label: "source",
      rows: 10
    })
  </script>
  <script id="10" type="application/vnd.observable.javascript">
    viewof target = Inputs.textarea({
      label: "target",
      rows: 10
    })
  </script>
  <script id="15" type="application/vnd.observable.javascript">
    viewof output = Inputs.textarea({
      label: "output",
      rows: 10,
      disabled: true
    })
  </script>
  <script id="21" type="application/vnd.observable.javascript">
    doDiff = {
      try {
        const s_json = JSON.parse(source);
        const t_json = JSON.parse(target);
        const s = dictify ? arrayToDict(s_json) : s_json;
        const t = dictify ? arrayToDict(t_json) : t_json;
        viewof output.value = JSON.stringify(generateJsonMergePatch(s, t), null, 2);
      } catch (err) {
        viewof output.value = err;
      }
    }
  </script>
  <script id="18" type="application/vnd.observable.javascript">
    function generateJsonMergePatch(oldJson, newJson) {
      const result = {};

      for (const key in oldJson) {
        if (!(key in newJson)) {
          result[key] = null; // Value has been removed
        } else if (
          typeof oldJson[key] === "object" &&
          !Array.isArray(oldJson[key]) &&
          oldJson[key] !== null
        ) {
          const nestedPatch = generateJsonMergePatch(oldJson[key], newJson[key]);
          if (Object.keys(nestedPatch).length > 0) {
            result[key] = nestedPatch; // There are changes in the nested object
          }
        } else if (oldJson[key] !== newJson[key]) {
          result[key] = newJson[key]; // Value has changed
        }
      }

      for (const key in newJson) {
        if (!(key in oldJson)) {
          result[key] = newJson[key]; // Value is new
        }
      }

      return result;
    }
  </script>
  <script id="35" type="text/markdown">
    the following feature toggle looks for arrays contained entries with an **id**, and converts them to dictionaries before calculating the merge
  </script>
  <script id="31" type="application/vnd.observable.javascript">
    viewof dictify = Inputs.toggle({
      label: "convert arrays to dicts?"
    })
  </script>
  <script id="38" type="application/vnd.observable.javascript">
    function arrayToDict(data) {
      if (Array.isArray(data)) {
        // Check if all elements are objects with an "id" property
        let allObjectsHaveId = true;
        let idsAreUnique = true;
        const idSet = new Set();
        for (const element of data) {
          if (typeof element !== "object" || element.id === undefined) {
            allObjectsHaveId = false;
            break;
          } else if (idSet.has(element.id)) {
            idsAreUnique = false;
            break;
          } else {
            idSet.add(element.id);
          }
        }
        if (allObjectsHaveId && idsAreUnique) {
          // Convert array to dictionary
          const dict = {};
          for (const element of data) {
            dict[element.id] = arrayToDict(element);
          }
          return dict;
        } else {
          // Recurse on array elements
          return data.map(arrayToDict);
        }
      } else if (typeof data === "object" && data !== null) {
        // Recurse on object properties
        const newObj = {};
        for (const key in data) {
          newObj[key] = arrayToDict(data[key]);
        }
        return newObj;
      } else {
        // Return primitive values as is
        return data;
      }
    }
  </script>
  <script id="50" type="application/vnd.observable.javascript">
    viewof arrayToDictOutput = Inputs.textarea({
      label: "arrayToDict(source)",
      rows: 10,
      disabled: true
    })
  </script>
  <script id="63" type="application/vnd.observable.javascript">
    viewof arrayToDictTarget = Inputs.textarea({
      label: "arrayToDict(target)",
      rows: 10,
      disabled: true
    })
  </script>
  <script id="57" type="application/vnd.observable.javascript">
    doArrayToDict = {
      try {
        viewof arrayToDictOutput.value = JSON.stringify(
          arrayToDict(JSON.parse(source)),
          null,
          2
        );
      } catch (err) {
        viewof arrayToDictOutput.value = err;
      }

      try {
        viewof arrayToDictTarget.value = JSON.stringify(
          arrayToDict(JSON.parse(target)),
          null,
          2
        );
      } catch (err) {
        viewof arrayToDictTarget.value = err;
      }
    }
  </script>
</notebook>
