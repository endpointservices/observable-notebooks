<!doctype html>
<notebook theme="air">
  <title>Oauth 2.0 Client Examples</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# Oauth 2.0 Client Examples

    These are preconfigured clients that can authorize *this* notebook. You would need to create your own secrets and *client_id* and *redirect_uri*'s if you were to host your own, but here you can experience it working.

    We only support the Oauth 2.0 _ Authorization Code_ grant flow. For high level documentation on Oauth 2.0, I recommend [Auth0](https://auth0.com/docs/protocols/protocol-oauth2)'s.

    Each Oauth client runs its own [proxy](https://observablehq.com/@tomlarkworthy/fetchp) which injects [secrets](https://observablehq.com/@endpointservices/secrets) during transit outside the browser environment.

    The Oauth Client Example here are for-
    - [RelMeAuth](#relmeauth)
    - [Github](#github)
    - [Reddit](#reddit)
    - [Google](#google)
    - [Strava](#strava)

    We do not suppor PCKE yet, but the [IndieAuth server](https://observablehq.com/@endpointservices/auth) does do a PKCE handshake including the b64S256 hash function when talking to an upstream indie auth endpoint.
    `
  </script>
  <script id="830" type="text/markdown" pinned="">
    ## Xero
  </script>
  <script id="860" type="application/vnd.observable.javascript" pinned="">
    xero_link
  </script>
  <script id="877" type="application/vnd.observable.javascript" pinned="">
    xero_authorization_params = Object.fromEntries(
      new URLSearchParams(xero_link).entries()
    )
  </script>
  <script id="863" type="text/html">
    <div style="height: 50px">
      <a style="background-color: #999; padding: 10px; margin: 5px; border-radius: 5px" href="${xero_link}">login to Xero
  </script>
  <script id="858" type="application/vnd.observable.javascript" pinned="">
    xero_state
  </script>
  <script id="834" type="application/vnd.observable.javascript" pinned="">
    XERO_CLIENT_ID = "CB5B515DAA534A4881C69F1895266E2D"
  </script>
  <script id="886" type="application/vnd.observable.javascript" pinned="">
    XERO_CLIENT_SECRET_SECRET_NAME = "tomlarkworthy_xero_oauth_secret"
  </script>
  <script id="846" type="application/vnd.observable.javascript" pinned="">
    XERO_CLIENT_ID
  </script>
  <script id="849" type="application/vnd.observable.javascript" pinned="">
    XERO_AUTHORIZE_URL = "https://login.xero.com/identity/connect/authorize"
  </script>
  <script id="851" type="application/vnd.observable.javascript" pinned="">
    XERO_TOKEN_URL = "https://identity.xero.com/connect/token"
  </script>
  <script id="855" type="application/vnd.observable.javascript" pinned="">
    XERO_TOKEN_PARAMS = (args) => {
      return {
        client_id: args.CLIENT_ID,
        redirect_uri: args.REDIRECT_URI,
        scope: args.SCOPES.join(" "),
        code: args.code,
        state: args.state
      };
    }
  </script>
  <script id="908" type="application/vnd.observable.javascript" pinned="">
    XERO_TOKEN_HEADERS = ({
      "content-type": "application/x-www-form-urlencoded"
    })
  </script>
  <script id="905" type="application/vnd.observable.javascript" pinned="">
    XERO_TOKEN_BODY = (args) => {
      return `grant_type=authorization_code&code=${args.code}&redirect_uri=${args.REDIRECT_URI}`;
    }
  </script>
  <script id="915" type="application/vnd.observable.javascript" pinned="">
    XERO_USE_BASIC_AUTH = true
  </script>
  <script id="880" type="application/vnd.observable.javascript" pinned="">
    XERO_SCOPES = ["openid", "profile", "email"]
  </script>
  <script id="838" type="application/vnd.observable.javascript" pinned="">
    import { authorize_link as xero_link, state as xero_state } with {
      XERO_CLIENT_ID as CLIENT_ID,
      XERO_AUTHORIZE_URL as AUTHORIZE_URL,
      XERO_TOKEN_URL as TOKEN_URL,
      XERO_USE_BASIC_AUTH as USE_BASIC_AUTH,
      XERO_TOKEN_PARAMS as TOKEN_PARAMS,
      XERO_TOKEN_HEADERS as TOKEN_HEADERS,
      XERO_TOKEN_BODY as TOKEN_BODY,
      XERO_SCOPES as SCOPES,
      XERO_CLIENT_SECRET_SECRET_NAME as CLIENT_SECRET_SECRET_NAME
    } from "@tomlarkworthy/oauth"
  </script>
  <script id="702" type="application/vnd.observable.javascript">
    relmeauth = md`## Login to an RelMeAuth server

    Login using a URL to a privacy preserving authorization server hosted [on Observable](https://observablehq.com/@endpointservices/relmeauth).
    `
  </script>
  <script id="741" type="application/vnd.observable.javascript">
    html`<a href="${relmeauth_link}">login to RelMeAuth on @endpointservices</a>`
  </script>
  <script id="739" type="application/vnd.observable.javascript">
    relmeauth_link
  </script>
  <script id="737" type="application/vnd.observable.javascript">
    relmeauth_state
  </script>
  <script id="773" type="application/vnd.observable.javascript" pinned="">
    relmeauth_state.access_token
  </script>
  <script id="734" type="application/vnd.observable.javascript" pinned="">
    import { authorize_link as relmeauth_link, state as relmeauth_state } with {
      RELMEAUTH_CLIENT_ID as CLIENT_ID,
      RELMEAUTH_AUTHORIZE_URL as AUTHORIZE_URL,
      RELMEAUTH_TOKEN_URL as TOKEN_URL,
      RELMEAUTH_TOKEN_PARAMS as TOKEN_PARAMS
    } from '@tomlarkworthy/oauth's
  </script>
  <script id="711" type="application/vnd.observable.javascript">
    RELMEAUTH_CLIENT_ID = "https://observablehq.com/@tomlarkworthy/oauth-examples"
  </script>
  <script id="713" type="application/vnd.observable.javascript">
    RELMEAUTH_AUTHORIZE_URL = "https://webcode.run/notebooks/@endpointservices/auth/deploys/authorization_endpoint/mods/X/secrets/endpointservices_secretadmin_service_account_key"
  </script>
  <script id="715" type="application/vnd.observable.javascript">
    RELMEAUTH_TOKEN_URL = "https://webcode.run/notebooks/@endpointservices/auth/deploys/token_endpoint/mods/X/secrets/endpointservices_secretadmin_service_account_key,endpointservices_minter"
  </script>
  <script id="717" type="application/vnd.observable.javascript" pinned="">
    RELMEAUTH_TOKEN_PARAMS = args => ({
      client_id: args.CLIENT_ID,
      redirect_uri: args.REDIRECT_URI,
      scope: args.SCOPES.join(" "),
      code: args.code,
      state: args.state
    })sasa
  </script>
  <script id="75" type="application/vnd.observable.javascript">
    github = md`## Github example`
  </script>
  <script id="503" type="application/vnd.observable.javascript">
    md`Github App are configured at [/settings/apps](https://github.com/settings/apps). Technical documentation is [here](https://docs.github.com/en/developers/apps/identifying-and-authorizing-users-for-github-apps).`
  </script>
  <script id="294" type="application/vnd.observable.javascript" pinned="">
    html`<a href="${github_link}">login to Github</a>`
  </script>
  <script id="300" type="application/vnd.observable.javascript" pinned="">
    github_state
  </script>
  <script id="165" type="application/vnd.observable.javascript" pinned="">
    import { authorize_link as github_link, state as github_state } with {
      GITHUB_CLIENT_ID as CLIENT_ID,
      GITHUB_CLIENT_SECRET_SECRET_NAME as CLIENT_SECRET_SECRET_NAME,
      GITHUB_CLIENT_SECRET_PARAMETER_NAME as CLIENT_SECRET_PARAMETER_NAME,
      GITHUB_AUTHORIZE_URL as AUTHORIZE_URL,
      GITHUB_TOKEN_URL as TOKEN_URL,
      GITHUB_TOKEN_PARAMS as TOKEN_PARAMS
    } from '@tomlarkworthy/oauth's
  </script>
  <script id="5" type="application/vnd.observable.javascript">
    GITHUB_CLIENT_SECRET_SECRET_NAME = "tomlarkworthy_github_client_secret"
  </script>
  <script id="349" type="application/vnd.observable.javascript">
    GITHUB_CLIENT_SECRET_PARAMETER_NAME = "client_secret"
  </script>
  <script id="13" type="application/vnd.observable.javascript">
    GITHUB_CLIENT_ID = "Iv1.058b3e2cc86bdb17"
  </script>
  <script id="16" type="application/vnd.observable.javascript">
    GITHUB_AUTHORIZE_URL = 'https://github.com/login/oauth/authorize'
  </script>
  <script id="80" type="application/vnd.observable.javascript">
    GITHUB_TOKEN_URL = "https://github.com/login/oauth/access_token"
  </script>
  <script id="404" type="application/vnd.observable.javascript">
    GITHUB_TOKEN_PARAMS = args => ({
      client_id: args.CLIENT_ID,
      redirect_uri: args.REDIRECT_URI,
      scope: args.SCOPES.join(" "),
      code: args.code,
      state: args.state
    })
  </script>
  <script id="531" type="application/vnd.observable.javascript">
    github_storage = md`## Github multi tenancy external storage example`
  </script>
  <script id="640" type="application/vnd.observable.javascript">
    md`Here we investigate how to set up shared storage of the auth state. Note in this example the database is publically readable, so the *auth_tokens* are public! However, we do not ask for any scopes so they have limited power.

    In a real situation you would need to secure these, for example, run the browsers in a privileged environment like [serverless cells](https://www.producthunt.com/posts/serverless-cells). The purpose of this is to document how to inject a custom storage backend for the Auth clients.

    We also show how to do dynamic lookup of the tenant despite the redirect_uri being different to the source notebook. This indirection is, for instance, we you could keep the access_tokens hidden from the end user.
    `
  </script>
  <script id="560" type="application/vnd.observable.javascript">
    html`<a href="https://observablehq.com/@tomlarkworthy/oauth-examples?tenant=tom#github_storage"> Switch to tenant</a>`
  </script>
  <script id="652" type="application/vnd.observable.javascript">
    html`<a href="${github_storage_link}">login to Github as ${tenant}</a>`
  </script>
  <script id="674" type="application/vnd.observable.javascript">
    import { deploy } from '@endpointservices/serverless-cells'
  </script>
  <script id="677" type="application/vnd.observable.javascript" pinned="">
    GITHUB_REDIRECT_URI = deploy("github_storage_redirect", async (req, res) => {
      // From the state parameter we can figure out the tenant that used it.
      const tenant = (await firebase
        .database()
        .ref(`@tomlarkworthy/oauth-examples/${req.query.state}`)
        .once('value')).val();
      res.redirect(
        `https://observablehq.com/@tomlarkworthy/oauth-examples?tenant=${tenant}&state=${req.query.state}&code=${req.query.code}#github_storage`
      );
    })sas
  </script>
  <script id="574" type="application/vnd.observable.javascript">
    github_storage_state
  </script>
  <script id="550" type="application/vnd.observable.javascript">
    tenant = new URLSearchParams(location.search).get("tenant")
  </script>
  <script id="687" type="application/vnd.observable.javascript" pinned="">
    state_to_tenant = {
      if (github_storage_state.state && tenant)
        return firebase
          .database()
          .ref(`@tomlarkworthy/oauth-examples/${github_storage_state.state}`)
          .set(tenant);
    }
  </script>
  <script id="546" type="application/vnd.observable.javascript">
    firebaseConfig = ({
      apiKey: "AIzaSyBN4bxw6d0cM0CGPNzRrkRlBqwFQnPLdN4",
      authDomain: "larkworthy-dfb11.firebaseapp.com",
      databaseURL:
        "https://larkworthy-dfb11-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "larkworthy-dfb11",
      appId: "1:786910701676:web:8d7dd002acf3b78c74d049"
    })
  </script>
  <script id="543" type="application/vnd.observable.javascript">
    import { firebase } with { firebaseConfig } from '@tomlarkworthy/firebase'
  </script>
  <script id="593" type="application/vnd.observable.javascript">
    md`
       Security rules look like

    ~~~js
    {
      "rules": {
        "@tomlarkworthy": {
          "oauth-examples": {
          	"$tenant": {
              ".read": true,
              ".write": true
            }
          }
        }
      }
    }
    ~~~
    `
  </script>
  <script id="584" type="application/vnd.observable.javascript">
    ref = firebase.database().ref(`/@tomlarkworthy/oauth-examples/${tenant}`)
  </script>
  <script id="637" type="application/vnd.observable.javascript">
    md`In a multitenancy situation we want the current user to be included in the redirect URL`
  </script>
  <script id="541" type="application/vnd.observable.javascript" pinned="">
    GITHUB_STORAGE_BACKEND = ({
      getItem: async key => (await ref.child(btoa(key)).once('value')).val(),
      setItem: async (key, value) => await ref.child(btoa(key)).set(value)
    })
  </script>
  <script id="569" type="application/vnd.observable.javascript" pinned="">
    import {
      authorize_link as github_storage_link,
      state as github_storage_state
    } with {
      GITHUB_CLIENT_ID as CLIENT_ID,
      GITHUB_CLIENT_SECRET_SECRET_NAME as CLIENT_SECRET_SECRET_NAME,
      GITHUB_CLIENT_SECRET_PARAMETER_NAME as CLIENT_SECRET_PARAMETER_NAME,
      GITHUB_AUTHORIZE_URL as AUTHORIZE_URL,
      GITHUB_TOKEN_URL as TOKEN_URL,
      GITHUB_TOKEN_PARAMS as TOKEN_PARAMS,
      GITHUB_STORAGE_BACKEND as STORAGE_BACKEND,
      GITHUB_REDIRECT_URI as REDIRECT_URI
    } from '@tomlarkworthy/oauth'
  </script>
  <script id="303" type="application/vnd.observable.javascript">
    reddit = md`## Reddit example`
  </script>
  <script id="340" type="application/vnd.observable.javascript">
    md`[Reddit Oauth 2.0 instructuctions](https://github.com/reddit-archive/reddit/wiki/OAuth2). Apps can be created at [/prefs/apps](https://www.reddit.com/prefs/apps).`
  </script>
  <script id="331" type="application/vnd.observable.javascript">
    html`<a href="${reddit_link}">login to Reddit</a>`
  </script>
  <script id="327" type="application/vnd.observable.javascript">
    reddit_state
  </script>
  <script id="322" type="application/vnd.observable.javascript" pinned="">
    import { authorize_link as reddit_link, state as reddit_state } with {
      REDDIT_CLIENT_ID as CLIENT_ID,
      REDDIT_CLIENT_SECRET_SECRET_NAME as CLIENT_SECRET_SECRET_NAME,
      REDDIT_USE_BASIC_AUTH as USE_BASIC_AUTH,
      REDDIT_AUTHORIZE_URL as AUTHORIZE_URL,
      REDDIT_TOKEN_URL as TOKEN_URL,
      REDDIT_TOKEN_HEADERS as TOKEN_HEADERS,
      REDDIT_TOKEN_BODY as TOKEN_BODY,
      REDDIT_SCOPES as SCOPES
    } from '@tomlarkworthy/oauth'sasa
  </script>
  <script id="310" type="application/vnd.observable.javascript">
    REDDIT_CLIENT_ID = 'HS-UEO2EWugyNg'
  </script>
  <script id="306" type="application/vnd.observable.javascript">
    REDDIT_CLIENT_SECRET_SECRET_NAME = 'tomlarkworthy_reddit_client_secret'
  </script>
  <script id="354" type="application/vnd.observable.javascript">
    REDDIT_USE_BASIC_AUTH = true
  </script>
  <script id="314" type="application/vnd.observable.javascript">
    REDDIT_AUTHORIZE_URL = 'https://www.reddit.com/api/v1/authorize'
  </script>
  <script id="317" type="application/vnd.observable.javascript">
    REDDIT_TOKEN_URL = 'https://www.reddit.com/api/v1/access_token'
  </script>
  <script id="373" type="application/vnd.observable.javascript">
    REDDIT_TOKEN_BODY = args => {
      return `grant_type=authorization_code&code=${args.code}&redirect_uri=${args.REDIRECT_URI}`;
    }
  </script>
  <script id="383" type="application/vnd.observable.javascript">
    REDDIT_TOKEN_HEADERS = ({
      'content-type': 'application/x-www-form-urlencoded'
    })
  </script>
  <script id="312" type="application/vnd.observable.javascript">
    REDDIT_SCOPES = ['read']
  </script>
  <script id="421" type="application/vnd.observable.javascript">
    google = md`## Google`
  </script>
  <script id="515" type="application/vnd.observable.javascript">
    md`Oauth 2.0 credentials can be minted in [Google Cloud Console](https://console.cloud.google.com/apis/credentials). Information on the web-server authentication flow is [here](https://developers.google.com/identity/protocols/oauth2/web-server).`
  </script>
  <script id="444" type="application/vnd.observable.javascript" pinned="">
    html`<a href="${google_link}">login to Google</a>`
  </script>
  <script id="445" type="application/vnd.observable.javascript" pinned="">
    google_state
  </script>
  <script id="442" type="application/vnd.observable.javascript" pinned="">
    import { authorize_link as google_link, state as google_state } with {
      GOOGLE_CLIENT_ID as CLIENT_ID,
      GOOGLE_CLIENT_SECRET_SECRET_NAME as CLIENT_SECRET_SECRET_NAME,
      GOOGLE_CLIENT_SECRET_PARAMETER_NAME as CLIENT_SECRET_PARAMETER_NAME,
      GOOGLE_AUTHORIZE_URL as AUTHORIZE_URL,
      GOOGLE_TOKEN_URL as TOKEN_URL,
      GOOGLE_TOKEN_HEADERS as TOKEN_HEADERS,
      GOOGLE_TOKEN_BODY as TOKEN_BODY,
      GOOGLE_SCOPES as SCOPES
    } from '@tomlarkworthy/oauth'
  </script>
  <script id="427" type="application/vnd.observable.javascript">
    GOOGLE_CLIENT_ID = '1986724398-5adiabbdrs6lrdh54m25nv9l2afjvl2q.apps.googleusercontent.com'
  </script>
  <script id="429" type="application/vnd.observable.javascript">
    GOOGLE_CLIENT_SECRET_SECRET_NAME = 'tomlarkworthy_google_client_secret'
  </script>
  <script id="456" type="application/vnd.observable.javascript">
    GOOGLE_CLIENT_SECRET_PARAMETER_NAME = "client_secret"
  </script>
  <script id="431" type="application/vnd.observable.javascript">
    GOOGLE_AUTHORIZE_URL = 'https://accounts.google.com/o/oauth2/v2/auth'
  </script>
  <script id="433" type="application/vnd.observable.javascript">
    GOOGLE_TOKEN_URL = 'https://oauth2.googleapis.com/token'
  </script>
  <script id="451" type="application/vnd.observable.javascript">
    GOOGLE_TOKEN_HEADERS = ({
      'content-type': 'application/x-www-form-urlencoded'
    })
  </script>
  <script id="454" type="application/vnd.observable.javascript">
    GOOGLE_TOKEN_BODY = args => {
      return (
        `code=${args.code}&client_id=${args.CLIENT_ID}&` +
        `redirect_uri=${args.REDIRECT_URI}&grant_type=authorization_code`
      );
    }
  </script>
  <script id="435" type="application/vnd.observable.javascript">
    GOOGLE_SCOPES = ['email']
  </script>
  <script id="781" type="application/vnd.observable.javascript">
    strava = md`## Strava`
  </script>
  <script id="790" type="application/vnd.observable.javascript" pinned="">
    html`<a href="${strava_link}">login to Strava</a>`
  </script>
  <script id="811" type="application/vnd.observable.javascript" pinned="">
    strava_state
  </script>
  <script id="784" type="application/vnd.observable.javascript">
    STRAVA_CLIENT_SECRET_SECRET_NAME = 'tomlarkworthy_strava_client_secret'
  </script>
  <script id="807" type="application/vnd.observable.javascript">
    STRAVA_CLIENT_SECRET_PARAMETER_NAME = 'client_secret'
  </script>
  <script id="788" type="application/vnd.observable.javascript">
    STRAVA_CLIENT_ID = "69457"
  </script>
  <script id="798" type="application/vnd.observable.javascript">
    STRAVA_AUTHORIZE_URL = 'https://www.strava.com/oauth/authorize'
  </script>
  <script id="800" type="application/vnd.observable.javascript">
    STRAVA_TOKEN_URL = 'https://www.strava.com/oauth/token'
  </script>
  <script id="796" type="application/vnd.observable.javascript">
    STRAVA_SCOPES = ["activity:read"]
  </script>
  <script id="803" type="application/vnd.observable.javascript" pinned="">
    STRAVA_TOKEN_PARAMS = args => ({
      client_id: args.CLIENT_ID,
      redirect_uri: args.REDIRECT_URI,
      scope: args.SCOPES.join(" "),
      code: args.code,
      state: args.state
    })saas
  </script>
  <script id="786" type="application/vnd.observable.javascript" pinned="">
    import { authorize_link as strava_link, state as strava_state } with {
      STRAVA_CLIENT_ID as CLIENT_ID,
      STRAVA_CLIENT_SECRET_SECRET_NAME as CLIENT_SECRET_SECRET_NAME,
      STRAVA_CLIENT_SECRET_PARAMETER_NAME as CLIENT_SECRET_PARAMETER_NAME,
      STRAVA_AUTHORIZE_URL as AUTHORIZE_URL,
      STRAVA_TOKEN_URL as TOKEN_URL,
      STRAVA_TOKEN_PARAMS as TOKEN_PARAMS,
      STRAVA_SCOPES as SCOPES
    } from '@tomlarkworthy/oauth'
  </script>
  <script id="823" type="application/vnd.observable.javascript" pinned="">
    import { footer } from "@endpointservices/endpoint-services-footer"
  </script>
  <script id="825" type="application/vnd.observable.javascript" pinned="">
    footer
  </script>
</notebook>
