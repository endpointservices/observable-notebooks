<!doctype html>
<notebook theme="air">
  <title>CodeMirror 6 Backwritable View</title>
  <script id="0" type="text/markdown">
    # CodeMirror 6 Backwritable View
  </script>
  <script id="7" type="text/markdown">
    Refactor of [@andy0130tw](https://observablehq.com/@andy0130tw/codemirror) Codemirror component. Added back-writability (it was very hard to get events right, use [@tomlarkworthy/ndd](/@tomlarkworthy/ndd)) and switched to <strike>UPKG</strike> `jspm.dev`  because Skypack was causing errors ([issue](https://github.com/skypackjs/skypack-cdn/issues/159)).

    Sample usage: 

    ```javascript
    import { CodeMirror } from '@tomlarkworthy/codemirror-6'

    viewof editor = CodeMirror('initial text', {
      extensions: []
    })
    ```

    Thanks [@jmatsushita](https://observablehq.com/@jmatsushita) for the `jspm.dev` fix!

    Back-writability allows the view to be bound to other views, such as [localStorageView](https://observablehq.com/@tomlarkworthy/local-storage-view). Example [here](https://observablehq.com/@tomlarkworthy/community-help#cell-540).

  </script>
  <script id="428" type="application/vnd.observable.javascript" pinned="">
    javascriptPlugin = esmCodeMirror("lang-javascript")
  </script>
  <script id="52" type="application/vnd.observable.javascript" pinned="">
    viewof editor = CodeMirror("const foo = () => 4.5\n", {
      extensions: [
        javascriptPlugin.javascript(),
        codemirror.basicSetup,
        myDefaultTheme
      ]
    })
  </script>
  <script id="66" type="application/vnd.observable.javascript" pinned="">
    editor
  </script>
  <script id="382" type="application/vnd.observable.javascript" pinned="">
    viewof texarea = Inputs.bind(
      Inputs.textarea({
        label: "bidirecitonal binding"
      }),
      viewof editor
    )
  </script>
  <script id="15" type="application/vnd.observable.javascript">
    md`---`
  </script>
  <script id="19" type="application/vnd.observable.javascript">
    CODEMIRROR_VERSION = "6.0.1"
  </script>
  <script id="282" type="application/vnd.observable.javascript">
    md`---`
  </script>
  <script id="35" type="application/vnd.observable.javascript" pinned="">
    CodeMirror = (doc = "", config = {}) => {
      const extensions = config.extensions ?? [];

      const updateViewOf = codemirror.EditorView.updateListener.of((update) => {
        if (doc !== view.state.doc.toString()) {
          doc = view.state.doc.toString();
          container.dispatchEvent(new Event("input", { bubbles: true }));
        }
      });

      const view = new codemirror.EditorView({
        doc,
        extensions: [updateViewOf, ...extensions]
      });
      const el = view.dom;
      const container = htl.html`<div><span onInput=${(evt) =>
        evt.stopPropagation()}>${el}`;
      Object.defineProperty(container, "value", {
        enumerable: true,
        get: () => doc,
        set: (newContent = "") => {
          const change = calcChange(doc, newContent, view.state.selection);
          doc = newContent;
          view.dispatch(change);
        }
      });
      return container;
    }
  </script>
  <script id="624" type="application/vnd.observable.javascript" pinned="">
    calcChange("abcddddddefg", "abcddddddefg", { ranges: [{ from: 8 }] })
  </script>
  <script id="621" type="application/vnd.observable.javascript" pinned="">
    calcChange = (previous, next, selection) => {
      // Find where to start inserting
      for (
        var insertOffset = 0;
        insertOffset < selection.ranges[0].from;
        insertOffset++
      ) {
        if (previous[insertOffset] !== next[insertOffset]) break;
      }

      // Find where the insert ends
      for (
        var endOffset = 0;
        endOffset < previous.length - selection.ranges[0].from;
        endOffset++
      ) {
        if (
          previous[previous.length - endOffset - 1] !==
          next[next.length - endOffset - 1]
        )
          break;
      }
      const insert = next.substring(insertOffset, next.length - endOffset);
      const cursor = Math.min(insertOffset + insert.length, next.length);
      return {
        changes: [
          {
            from: insertOffset,
            to: previous.length - endOffset,
            insert
          }
        ],
        selection: {
          anchor: cursor,
          head: cursor
        }
      };
    }
  </script>
  <script id="198" type="application/vnd.observable.javascript">
    md`---`
  </script>
  <script id="60" type="application/vnd.observable.javascript" pinned="">
    myDefaultTheme = codemirror.EditorView.theme({
      "&": {
        fontFamily: 'Consolas, "Roboto Mono", monospace',
        fontSize: "14px",
        height: "200px",
        border: "1px solid #ddd"
      }
    })
  </script>
  <script id="28" type="application/vnd.observable.javascript">
    md`---`
  </script>
  <script id="12" type="application/vnd.observable.javascript" pinned="">
    esmImport = (pkg) =>
      import(
        /*`https://unpkg.com/${pkg}/dist/index.js?module`*/
        `https://jspm.dev/${pkg}`
      ) /*broken: import(`https://cdn.skypack.dev/${pkg}`)*/
  </script>
  <script id="18" type="application/vnd.observable.javascript">
    esmCodeMirror = (mod) =>
      esmImport(
        "@codemirror/" +
          (mod.indexOf("@") >= 0 ? mod : `${mod}@${CODEMIRROR_VERSION}`)
      )
  </script>
  <script id="496" type="application/vnd.observable.javascript" pinned="">
    codemirror = esmImport(`codemirror`)
  </script>
  <script id="359" type="application/vnd.observable.javascript">
    md`---`
  </script>
</notebook>
