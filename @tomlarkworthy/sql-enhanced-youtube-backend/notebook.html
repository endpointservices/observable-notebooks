<!doctype html>
<notebook theme="air">
  <title>SQL Enhanced YouTube -- Backend</title>
  <script id="0" type="text/markdown">
    # SQL Enhanced YouTube -- Backend
  </script>
  <script id="292" type="text/html">
    <h2> NOT POSSIBLE, YouTube does not allow caption downloads!</h2>
  </script>
  <script id="105" type="application/vnd.observable.javascript">
    Inputs.button("test caption request", {
      reduce: () => getCaptions("I845O57ZSy4")
    })
  </script>
  <script id="205" type="text/html">
    <a href="${authorize_link}">
        authorize
    </a>
  </script>
  <script id="210" type="application/vnd.observable.javascript">
    access_token = google_state?.access_token || invalidation
  </script>
  <script id="111" type="application/vnd.observable.javascript" pinned="">
    getCaptions = async (id) => {
      const response = await fetch(`${backend.href}?id=${id}`, {
        headers: {
          Authorization: access_token
        }
      });
      if (response.status !== 200) throw new Error(await response.text());
      else return response.json();
    }
  </script>
  <script id="59" type="application/vnd.observable.javascript" pinned="">
    backend = endpoint("backend", async (req, res, ctx) => {
      try {
        viewof request.send({ req, res, ctx });
      } catch (err) {
        res.status(err.code || 500).send(err.message);
      }
    })
  </script>
  <script id="90" type="application/vnd.observable.javascript" pinned="">
    viewof request = flowQueue({
      timeout_ms: 5000
    })
  </script>
  <script id="108" type="application/vnd.observable.javascript">
    request
  </script>
  <script id="128" type="application/vnd.observable.javascript">
    API_KEY = "AIzaSyA3nWv_jQuZ7Mvti69gGAVBH2Rd4aAmHbs"
  </script>
  <script id="126" type="application/vnd.observable.javascript" pinned="">
    youtubeCaptionsListResponse = {
      const response = await fetch(
        `https://youtube.googleapis.com/youtube/v3/captions?part=id&videoId=${request.req.query.id}&key=${API_KEY}`,
        {
          headers: {
            Authorization: `Bearer ${request.req.headers.authorization}`,
            Accept: "application/json"
          }
        }
      );
      return response.json();
    }
  </script>
  <script id="280" type="application/vnd.observable.javascript" pinned="">
    (
      await fetchp(
        `https://video.google.com/timedtext?lang=en&v=${request.req.query.id}`,
        {
          headers: {
            Accept: "application/json"
          }
        }
      )
    ).text()
  </script>
  <script id="285" type="application/vnd.observable.javascript" pinned="">
    request.req.query.id
  </script>
  <script id="254" type="application/vnd.observable.javascript" pinned="">
    captions = youtubeCaptionsListResponse.items
  </script>
  <script id="259" type="application/vnd.observable.javascript" pinned="">
    youtubeCaptionsDownloadResponse = {
      const response = await fetchp(
        `https://youtube.googleapis.com/youtube/v3/captions/${captions[0].id}?key=${API_KEY}`,
        {
          headers: {
            Authorization: `Bearer ${request.req.headers.authorization}`,
            Accept: "application/json"
          }
        }
      );
      return response.text();
    }
  </script>
  <script id="267" type="application/vnd.observable.javascript" pinned="">
    youtubeCaptionsDownloadResponse.text()
  </script>
  <script id="119" type="application/vnd.observable.javascript" pinned="">
    import { getAccessTokenFromServiceAccount } from "@tomlarkworthy/firebase-admin"
  </script>
  <script id="62" type="application/vnd.observable.javascript">
    import { flowQueue } from "@tomlarkworthy/flow-queue"
  </script>
  <script id="40" type="application/vnd.observable.javascript">
    import { endpoint } from "@endpointservices/webcode"
  </script>
  <script id="144" type="application/vnd.observable.javascript" pinned="">
    import { localStorageView } from "@tomlarkworthy/local-storage-view"
  </script>
  <script id="264" type="application/vnd.observable.javascript">
    import { fetchp } from "@tomlarkworthy/fetchp"
  </script>
  <script id="173" type="text/markdown">
    ## Oauth
  </script>
  <script id="171" type="application/vnd.observable.javascript" pinned="">
    import { authorize_link, state as google_state } with {
      GOOGLE_CLIENT_ID as CLIENT_ID,
      GOOGLE_CLIENT_SECRET_SECRET_NAME as CLIENT_SECRET_SECRET_NAME,
      GOOGLE_CLIENT_SECRET_PARAMETER_NAME as CLIENT_SECRET_PARAMETER_NAME,
      GOOGLE_AUTHORIZE_URL as AUTHORIZE_URL,
      GOOGLE_TOKEN_URL as TOKEN_URL,
      GOOGLE_TOKEN_HEADERS as TOKEN_HEADERS,
      GOOGLE_TOKEN_BODY as TOKEN_BODY,
      GOOGLE_SCOPES as SCOPES
    } from "@tomlarkworthy/oauth"
  </script>
  <script id="177" type="application/vnd.observable.javascript">
    GOOGLE_CLIENT_ID = '786910701676-0lg1uf3udtpnct9ji4ojijvv2rcelq6n.apps.googleusercontent.com'

  </script>
  <script id="179" type="application/vnd.observable.javascript">
    GOOGLE_CLIENT_SECRET_SECRET_NAME = "tomlarkworthy_sql-enhanced-youtube-backend"
  </script>
  <script id="181" type="application/vnd.observable.javascript">

    GOOGLE_CLIENT_SECRET_PARAMETER_NAME = "client_secret"

  </script>
  <script id="183" type="application/vnd.observable.javascript">

    GOOGLE_AUTHORIZE_URL = 'https://accounts.google.com/o/oauth2/v2/auth'

  </script>
  <script id="185" type="application/vnd.observable.javascript">

    GOOGLE_TOKEN_URL = 'https://oauth2.googleapis.com/token'

  </script>
  <script id="187" type="application/vnd.observable.javascript">

    GOOGLE_TOKEN_HEADERS = ({
      'content-type': 'application/x-www-form-urlencoded'
    })

  </script>
  <script id="189" type="application/vnd.observable.javascript">

    GOOGLE_TOKEN_BODY = args => {
      return (
        `code=${args.code}&client_id=${args.CLIENT_ID}&` +
        `redirect_uri=${args.REDIRECT_URI}&grant_type=authorization_code`
      );
    }

  </script>
  <script id="191" type="application/vnd.observable.javascript">
    GOOGLE_SCOPES = ["https://www.googleapis.com/auth/youtube.force-ssl"]
  </script>
</notebook>
