<!doctype html>
<notebook theme="air">
  <title>Reversible attachment</title>
  <script id="0" type="text/markdown">
    # Reversible attachment

    _reversibleAttach_ allows you toggle whether a view is attached to a composite view at runtime. This is useful for development when building views hierarchically, as you can use the _reversibleAttach_ to work on isolated pieces or the whole.

    The value remain accessible in both places. Works with both `Inputs.form` and `@tomlarkworthy/view`, the latter supports back-driving values, which only works when the attachment is active.

    ```js
    import {reversibleAttach} from '@tomlarkworthy/reversible-attachment'
    ```
  </script>
  <script id="17" type="application/vnd.observable.javascript">
    viewof attach = Inputs.toggle({
      label: "attach"
    })
  </script>
  <script id="55" type="text/markdown">
    ## child view
  </script>
  <script id="7" type="application/vnd.observable.javascript">
    viewof child = Inputs.text()
  </script>
  <script id="57" type="text/markdown">
    ## parent view ([@tomlarkworthy/view](https://observablehq.com/@tomlarkworthy/view))
  </script>
  <script id="10" type="application/vnd.observable.javascript" pinned="">
    viewof parent = view`<div>
    ${["child", reversibleAttach(attach, viewof child)]}
    </div>`
  </script>
  <script id="166" type="text/markdown">
    Note changes propogate to both
  </script>
  <script id="31" type="application/vnd.observable.javascript" pinned="">
    child
  </script>
  <script id="80" type="application/vnd.observable.javascript" pinned="">
    parent
  </script>
  <script id="229" type="text/markdown">
    Backdrivability works 
  </script>
  <script id="199" type="application/vnd.observable.javascript" pinned="">
    Inputs.button("backdrive parent", {
      reduce: () => {
        viewof parent.value.child = Math.random();
        viewof parent.child.dispatchEvent(new Event("input", { bubbles: true }));
      }
    })
  </script>
  <script id="174" type="text/markdown">
    ## grandparent view ([Inputs.form](https://observablehq.com/@observablehq/input-form))
  </script>
  <script id="179" type="application/vnd.observable.javascript">
    viewof attach_gp = Inputs.toggle({
      label: "attach gradparent"
    })
  </script>
  <script id="185" type="application/vnd.observable.javascript" pinned="">
    viewof grand_parent = Inputs.form({
      parent: reversibleAttach(attach_gp, viewof parent)
    })
  </script>
  <script id="190" type="application/vnd.observable.javascript" pinned="">
    grand_parent
  </script>
  <script id="208" type="application/vnd.observable.javascript" pinned="">
    Inputs.button("backdrive grand_parent", {
      reduce: () => {
        viewof grand_parent.value.parent.child = Math.random();
        viewof grand_parent.dispatchEvent(new Event("input", { bubbles: true }));
      }
    })
  </script>
  <script id="168" type="text/markdown">
    ---
  </script>
  <script id="43" type="application/vnd.observable.javascript">
    parents = new Map()
  </script>
  <script id="26" type="application/vnd.observable.javascript">
    function reversibleAttach(shouldBind, view, invalidation) {
      if (!parents.has(view) && view.parentElement) {
        parents.set(view, view.parentElement);
      }
      if (shouldBind) {
        return view;
      } else {
        if (parents.has(view)) {
          const parent = parents.get(view);
          if (parent.firstChild !== view) parent.appendChild(view);
        }
        const dummy = document.createTextNode("<detached>");
        return bindOneWay(dummy, view, invalidation);
      }
    }
  </script>
  <script id="89" type="application/vnd.observable.javascript">
    import { view, bindOneWay } from "@tomlarkworthy/view"
  </script>
  <script id="243" type="application/vnd.observable.javascript" pinned="">
    //import { footer } from "@tomlarkworthy/footer"
  </script>
  <script id="260" type="application/vnd.observable.javascript" pinned="">
    footer
  </script>
</notebook>
