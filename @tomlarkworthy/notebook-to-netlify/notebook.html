<!doctype html>
<notebook theme="air">
  <title>Publish Notebook to Netlify</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# Publish Notebook to Netlify

    The tools deploys my notebooks on my personal site. For example: [multiplayer-cursors](https://tomlarkworthy.endpointservices.net/notebooks/tomlarkworthy/multiplayer-cursors.html)

    Technologies
    - [@mootari/sortable-notebook-list](https://observablehq.com/@mootari/sortable-notebook-list), for finding what notebooks I own
    - [@tomlarkworthy/fetchp](https://observablehq.com/@tomlarkworthy/fetchp), for downloading notebook data _.tgz_ bundles
    - [@endpointservices/storage](https://observablehq.com/@endpointservices/storage), provides filestorage, for unpacking _.tgz_ into
    - [@endpointservices/netlify](https://observablehq.com/@endpointservices/netlify), for uploading to Netlify from URLs
    - _pako_, and _untar_ - gzip and tar browser utilities.
    - Firestore as a CMS (enabling partial sync to Netlify)
    - IndieAuth as identity provider
    `
  </script>
  <script id="15" type="application/vnd.observable.javascript">
    storageLogin
  </script>
  <script id="496" type="application/vnd.observable.javascript">
    md`#### Deploy notebook source wrapper (${notebook.title})`
  </script>
  <script id="349" type="application/vnd.observable.javascript">
    deployCustomNotebookPage({
      title: notebook.title,
      owner: notebook.owner,
      slug: notebook.slug,
      thumbnail: notebook.thumbnail,
      collection: notebook.collection
    })
  </script>
  <script id="491" type="application/vnd.observable.javascript">
    md`#### Deploy notebook source (${notebook.title})`
  </script>
  <script id="487" type="application/vnd.observable.javascript">
    deployNotebookTgz({
      owner: notebook.owner,
      slug: notebook.slug
    })
  </script>
  <script id="520" type="application/vnd.observable.javascript">
    htl.html`<button onclick=${() => {
      state.unpacked = {};
    }}>clear cache `
  </script>
  <script id="662" type="application/vnd.observable.javascript">
    md`### Choose Notebook to deploy`
  </script>
  <script id="619" type="application/vnd.observable.javascript">
    viewof search = Inputs.search(notebookData)
  </script>
  <script id="21" type="application/vnd.observable.javascript">
    viewof notebooks
  </script>
  <script id="533" type="application/vnd.observable.javascript">
    md`## HTML`
  </script>
  <script id="228" type="application/vnd.observable.javascript">
    function customNotebookIndex({
      title,
      url,
      notebookURL,
      description,
      imageURL,
      twitterCreator = "@tomlarkworthy",
      baseURL = "."
    } = {}) {
      return `<!DOCTYPE html>
    <html class="has-navbar-fixed-top">
    <meta charset="utf-8">
    <title>${title}</title>
    <link rel="stylesheet" type="text/css" href="${baseURL}/inspector.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.1/css/bulma.min.css">
    <script src="https://kit.fontawesome.com/aeb44cf583.js" crossorigin="anonymous"><\/script>
    <meta property="og:type" content="article"/>
    ${description ? `<meta name="description" content=${description}/>` : ''}
    <meta property="og:url" content="${url}"/>
    <meta property="og:description" content="${description}"/>
    <meta property="og:image" content="${imageURL}"/>

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="${url}" />
    <meta name="twitter:creator" content="${twitterCreator}" />
    <meta name="twitter:title" content=${title} />
    <meta name="twitter:description" content=${description} />
    <meta name="twitter:image" content=${imageURL} />

    <body>
    ${topbar.outerHTML}
    <div class="columns">
      ${sidebar.outerHTML}
      <div class="column is-half">
        <div style="text-align:right;">
          <svg width="20" height="16" viewBox="0 0 16 16" fill="currentColor" class="ml2 mr1"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.5 1.75C3.80964 1.75 3.25 2.30964 3.25 3C3.25 3.69036 3.80964 4.25 4.5 4.25C5.19036 4.25 5.75 3.69036 5.75 3C5.75 2.30964 5.19036 1.75 4.5 1.75ZM1.75 3C1.75 1.48122 2.98122 0.25 4.5 0.25C6.01878 0.25 7.25 1.48122 7.25 3C7.25 4.16599 6.52434 5.1625 5.5 5.56253V7H8.5C9.4199 7 10.1947 6.37895 10.4281 5.53327C9.44188 5.11546 8.75 4.13853 8.75 3C8.75 1.48122 9.98122 0.25 11.5 0.25C13.0188 0.25 14.25 1.48122 14.25 3C14.25 4.18168 13.5047 5.18928 12.4585 5.57835C12.1782 7.51343 10.5127 9 8.5 9H5.5V10.4375C6.52434 10.8375 7.25 11.834 7.25 13C7.25 14.5188 6.01878 15.75 4.5 15.75C2.98122 15.75 1.75 14.5188 1.75 13C1.75 11.834 2.47566 10.8375 3.5 10.4375L3.5 9V7V5.56253C2.47566 5.1625 1.75 4.16599 1.75 3ZM4.5 11.75C3.80964 11.75 3.25 12.3096 3.25 13C3.25 13.6904 3.80964 14.25 4.5 14.25C5.19036 14.25 5.75 13.6904 5.75 13C5.75 12.3096 5.19036 11.75 4.5 11.75ZM10.25 3C10.25 2.30964 10.8096 1.75 11.5 1.75C12.1904 1.75 12.75 2.30964 12.75 3C12.75 3.69036 12.1904 4.25 11.5 4.25C10.8096 4.25 10.25 3.69036 10.25 3Z"></path></svg>
          <strong>Fork</strong> this on <a href=${notebookURL}>Observablehq.com</a>
        </div>
        <br>
        <div id="notebook" class="content">
        </div>
      </div>
    </div>

    <script type="module">

    import define from "${baseURL}/index.js";
    import {Runtime, Library, Inspector} from "${baseURL}/runtime.js";

    const runtime = new Runtime();
    const main = runtime.module(define, Inspector.into(document.querySelector("#notebook")));
    <\/script>

    <footer class="footer">
      <div class="content has-text-centered">
        <p>
          <small>&copy; Copyright ${new Date().getFullYear()}, Tom Larkworthy</small>
        </p>
        <p>
          ${
            notebookURL
              ? html`The forkable notebook source code is available on <a href=${notebookURL}>Observablehq.com</a>. Deployed using <a href="https://observablehq.com/@tomlarkworthy/notebook-to-netlify">@tomlarkworthy/notebook-to-netlify</a>.`
                  .outerHTML
              : null
          } 
          The website contentis licensed <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY NC SA 4.0</a>.
        </p>
      </div>
    </footer>
    </body>
    </html>
    `;
    }
  </script>
  <script id="331" type="application/vnd.observable.javascript">
    customNotebookURL = (options) => `data:text/html;charset=UTF-8,${encodeURIComponent(
      customNotebookIndex(options)
    )}`
  </script>
  <script id="607" type="application/vnd.observable.javascript">
    notebookGallery = () => {
      const title = `Tom's notebook gallery`;
      const description =
        "Gallery of noteoboks authored by Tom Larkworthy on https://observablehq.com, all forkable with pointers to their original source";
      const imageURL = null;
      return `<!DOCTYPE html>
    <html class="has-navbar-fixed-top">
    <meta charset="utf-8">
    <title>${title}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.1/css/bulma.min.css">
    <script src="https://kit.fontawesome.com/aeb44cf583.js" crossorigin="anonymous"><\/script>
    <meta property="og:type" content="article"/>
    <meta name="description" content="${description}"/>
    <meta property="og:description" content="${description}"/>
    <meta property="og:image" content="${imageURL}"/>

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="https://tomlarkworthy.endpointservices.net" />
    <meta name="twitter:creator" content="@tomlarkworhy" />
    <meta name="twitter:title" content=${title} />
    <meta name="twitter:description" content=${description} />
    <meta name="twitter:image" content=${imageURL} />

    <body>
    ${topbar.outerHTML}
    <div class="columns">
      ${sidebar.outerHTML}
      <div class="column is-half">

      </div>
    </div>
    <footer class="footer">
      <div class="content has-text-centered">
        <p>
          <small>&copy; Copyright ${new Date().getFullYear()}, Tom Larkworthy</small>
        </p>
        <p>
          Deployed using <a href="https://observablehq.com/@tomlarkworthy/notebook-to-netlify">@tomlarkworthy/notebook-to-netlify</a>.
          The website contentis licensed <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY NC SA 4.0</a>.
        </p>
      </div>
    </footer>
    </body>
    </html>
    `;
    }
  </script>
  <script id="563" type="application/vnd.observable.javascript">
    md`## Implementation`
  </script>
  <script id="528" type="application/vnd.observable.javascript">
    notebook = ({
      title: notebooks[0].title,
      slug: notebooks[0].slug,
      thumbnail: notebooks[0].thumbnail,
      collection: notebooks[0]?.collection?.slug,
      owner: notebooks[0].owner.login
    })
  </script>
  <script id="18" type="application/vnd.observable.javascript">
    storage = storageClient('gs://o_tomlarkworthy_toms').ref(
      "/backups/notebooks/@tomlarkworthy"
    )
  </script>
  <script id="420" type="application/vnd.observable.javascript">
    mutable state = ({
      expansions: {},
      unpacked: {}
    })
  </script>
  <script id="565" type="application/vnd.observable.javascript">
    md`## Deployers`
  </script>
  <script id="66" type="application/vnd.observable.javascript">
    async function* deployNotebookTgz({ slug, owner } = {}) {
      const name = `@${owner}/${slug}`;
      if (!state.expansions[name]) {
        let expand;
        state.expansions[name] = new Promise(resolve => (expand = resolve));
        yield Object.defineProperty(
          htl.html`<button onclick=${expand}>${name}</button>`,
          'value',
          {
            value: state.expansions[name]
          }
        );
      }
      await state.expansions[name];

      if (!state.unpacked[name]) {
        yield md`Preparing deploy from backups`;

        const url = `https://api.observablehq.com/@${owner}/${slug}.tgz?v=3`;
        const contents = await untar(
          await pako.ungzip(await (await fetchp(url)).arrayBuffer()).buffer
        );

        // unzip tar into storage so you can get the URL
        const unpackPromise = contents.map(async file => {
          const filename = file.name.substring(2); // trim "./"
          const ref = storageClient('gs://o_tomlarkworthy_toms').ref(
            "/deploys/notebooks/" + name + "/" + filename
          );
          await ref.put(file.buffer);
          return {
            name: filename,
            url: await ref.getDownloadURL()
          };
        });

        state.unpacked[name] = await promiseRecursive(unpackPromise);
      }

      yield deployStaticFiles({
        app_id: 'b6a918d2-9cda-4fde-b2ec-add91b22ea02',
        immediate: true,
        files: state.unpacked[name].map(file => ({
          source: file.url,
          target: `/notebooks/${name}/${file.name}`,
          tags: ['notebook_tgz']
        }))
      });
    }
  </script>
  <script id="320" type="application/vnd.observable.javascript">
    deployCustomNotebookPage = async ({
      owner,
      slug,
      title,
      description,
      thumbnail,
      collection
    }) => {
      const target = `/notebooks/${owner}/${slug}.html`;
      const notebookURL = `https://observablehq.com/@${owner}/${slug}`;
      const preview = customNotebookURL({
        title,
        description,
        baseURL: `https://tomlarkworthy.endpointservices.net/notebooks/@${owner}/${slug}`,
        notebookURL,
        url: target,
        imageURL: `https://static.observableusercontent.com/thumbnail/${thumbnail}.jpg`
      });

      return html`
        <div><a href=${notebookURL}>notebook</a></div>
        <div><a href=${preview}>preview (right click)</a></div>
        <div><a target="_blank" href=${'https://tomlarkworthy.endpointservices.net' +
          target}>deployed ${target}</a></div>
        ${await deployStaticFile({
          app_id: 'b6a918d2-9cda-4fde-b2ec-add91b22ea02',
          source: preview,
          target,
          tags: collection ? ['notebook', collection] : ['notebook'],
          dependsOnTags: [name],
          title,
          owner,
          slug
        })}
      `;
    }
  </script>
  <script id="554" type="application/vnd.observable.javascript">
    md`## Imports`
  </script>
  <script id="12" type="application/vnd.observable.javascript">
    import { storageClient, storageLogin } from '@endpointservices/storage'
  </script>
  <script id="7" type="application/vnd.observable.javascript">
    import { deployStaticFiles, deployStaticFile } from '@endpointservices/netlify'
  </script>
  <script id="376" type="application/vnd.observable.javascript">
    import { getContext } from '@endpointservices/serverless-cells'
  </script>
  <script id="378" type="application/vnd.observable.javascript">
    sort = "updated"
  </script>
  <script id="374" type="application/vnd.observable.javascript">
    username = getContext().serverless ? new Promise(() => {}) : "tomlarkworthy"
  </script>
  <script id="368" type="application/vnd.observable.javascript">
    import { notebooks as notebookData } with {
      username
    } from '@mootari/sortable-notebook-list@899'
  </script>
  <script id="650" type="application/vnd.observable.javascript" pinned="">
    import { viewof selection as notebooks } with {
      sort,
      search as notebooks
    } from '@mootari/sortable-notebook-list@899'
  </script>
  <script id="91" type="application/vnd.observable.javascript">
    pako = require('https://bundle.run/pako@2.0.3')
  </script>
  <script id="134" type="application/vnd.observable.javascript">
    untar = require('js-untar')
  </script>
  <script id="231" type="application/vnd.observable.javascript">
    import { deploy } from '@endpointservices/serverless-cells'
  </script>
  <script id="257" type="application/vnd.observable.javascript">
    import { sidebar, articleHeader, topbar } from '@tomlarkworthy/blog-theme'
  </script>
  <script id="43" type="application/vnd.observable.javascript">
    import { promiseRecursive } from '@tomlarkworthy/utils'
  </script>
  <script id="406" type="application/vnd.observable.javascript">
    import { fetchp } from '@tomlarkworthy/fetchp'
  </script>
</notebook>
