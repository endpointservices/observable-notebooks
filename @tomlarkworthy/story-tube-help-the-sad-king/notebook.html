<!doctype html>
<notebook theme="air">
  <title>Story Tube: Help the Sad King</title>
  <script id="0" type="application/vnd.observable.javascript">
    html`
    <div class="content">
      <h1>Story Tube: Help the Sad King</h1>
    </div>`
  </script>
  <script id="32" type="application/vnd.observable.javascript">
    tube = html`
    <iframe 
      id="tube"
      width="100%"
      height="480"
      src="https://www.youtube.com/embed?autoplay=1&enablejsapi=1&rel=0"
      frameborder="0"
      allow="autoplay; encrypted-media"
      allowfullscreen
    />`
  </script>
  <script id="941" type="application/vnd.observable.javascript">
    actions = render(() => {
      if (hasPlayed) {
        return hasPlayed && jsx`
          <div class="level is-mobile"> ${
          map[state].map(option => {
              return jsx`
                <a class="button level-item is-large is-primary"
                   style=${{"font-size":"250%"}}
                   href="#${option.next}"

                >${option.label}</a>`
          })}</div>`
      } else {
        return jsx`<div class="level content is-mobile">
                      <button class="button level-item is-large is-primary"
                              style=${{"font-size":"300%"}}
                              onClick=${() => player.playVideo()}>
                        ▶️ 
                      </button>
                   </div>`
      }
    })
  </script>
  <script id="1098" type="application/vnd.observable.javascript">
    chart = {
      const source = `
        digraph {
          rankdir = LR;
          ${Object.keys(map).map(start_state => {
            return `node [shape = ${start_state === state ? "doublecircle": "circle"}
                          color = ${start_state === state ? "red": "black"}
                         ];${start_state};`  
          }).join("\n")}  

          ${Object.keys(map).map(start_state => {
            return map[start_state].map((transition, index) => {
              return `${start_state} -> ${map[start_state][index].next}
                      [ label = "${map[start_state][index].label}"];`
            }).join("\n")
          }).join("\n")}
        }
      `
      try {
        return dot`${source}`;
      } catch (error) {
        return this;
      }
    }
  </script>
  <script id="1080" type="application/vnd.observable.javascript">
    map = {
      return {
        king: [{
          label: "👴🏼", // Emoji's are good for young children who cannot read
          next: "old_man"
        }, {
          label: "🏛",
          next: "locked_prison"
        }],
        old_man: [{
          label: "👑",
          next: "king"
        }, {
          label: "🏛",
          next: "locked_prison"
        }],
        locked_prison: [{
          label: "👑",
          next: "locked_king"
        }, {
          label: "👴🏼",
          next: "locked_old_man"
        }],
        locked_king: [{
          label: "👴",
          next: "locked_old_man"
        }, {
          label: "🏛",
          next: "locked_prison"
        }],
        locked_old_man: [{
          label: "👑",
          next: "locked_king"
        }, {
          label: "🏛",
          next: "locked_prison"
        }, {
          label: "😄",
          next: "get_key"
        }],
        get_key: [{
          label: "👑",
          next: "key_king"
        }, {
          label: "🏛",
          next: "key_prison"
        }],
        key_king: [{
          label: "👴",
          next: "key_old_man"
        }, {
          label: "🏛",
          next: "key_prison"
        }],
        key_old_man: [{
          label: "👑",
          next: "key_king"
        }, {
          label: "🏛",
          next: "key_prison"
        }],
        key_prison: [{
          label: "👑",
          next: "key_king"
        }, {
          label: "👴",
          next: "key_old_man"
        }, {
          label: "🗝",
          next: "open_prison"
        }],
        open_prison: [{
          label: "👑",
          next: "happy_king"
        }],
        happy_king: [{
          label: "🏆",
          next: "get_wish"
        }],
        get_wish: [{
          label: "🔁",
          next: "king"
        }]
      }}
  </script>
  <script id="554" type="application/vnd.observable.javascript">
    state = {
      try {
        return decodeURIComponent(hash.substring(1)) || "king"
      } catch (err) {
        return "king"
      }
    }
  </script>
  <script id="777" type="application/vnd.observable.javascript">
    video = {
      const videosByState = {
        "king": "GlJNbBkrEQQ",
        "locked_king": "GlJNbBkrEQQ",
        "key_king": "GlJNbBkrEQQ",
        "old_man": "DfFHDEIEDJg",
        "locked_old_man": "DfFHDEIEDJg",
        "key_old_man": "DfFHDEIEDJg",
        "get_wish": "p8-8rxGTKWo",
        "happy_king": "pzU5ijeddd0",
        "open_prison": "AEE5Tbo3Pto",
        "get_key": "3WI-1ycC1QM",
        "locked_prison": "K18MWcJHOY4",
        "key_prison": "K18MWcJHOY4",
        "prison": "K18MWcJHOY4"
      };
      player.cueVideoById({
        'videoId': videosByState[state],
        'startSeconds': 0
      });
      return videosByState[state];
    } 
  </script>
  <script id="669" type="application/vnd.observable.javascript">
    html`<div class="content">
      <h2>About Adventure Tube</h2>
      <p> Choose your own adventure, a STEM activity from <a href="https://www.youtube.com/channel/UCpL1E-yK38HGsNaIfVPdc8w">Pause and Play</a></p>
      <p> This game is designed for young children to play, but older kids can make their own by forking the page. Click the cells to see the code behind the adventure.</p>
    </div>
    `
  </script>
  <script id="742" type="application/vnd.observable.javascript">
    YT = await new Promise(async (resolve, reject) => {
      const YT = await require('https://www.youtube.com/iframe_api').catch(
        () => window['YT']
      );
      YT.ready(() => resolve(YT));
    });
  </script>
  <script id="761" type="application/vnd.observable.javascript">
    player = await new Promise(async (resolve, reject) => {
      var privateHasPlayed = false;
      function onStateChange(event) {
        switch (event.data) {
          case YT.PlayerState.UNSTARTED:
            break;
          case YT.PlayerState.ENDED:
            break;
          case YT.PlayerState.PLAYING:
            console.log("autoplay on")
            privateHasPlayed = true;
            mutable hasPlayed = true
            break;
          case YT.PlayerState.PAUSED:
            break;
          case YT.PlayerState.BUFFERING:
            break;
          case YT.PlayerState.CUED:
            console.log("cued")
            if (privateHasPlayed) {
              console.log("autoplay")
              player.playVideo();
            } 
            break;
          default:
            console.log("unknown (" + event.data + ")");
        }
      }

      var player = new YT.Player('tube', {
        height: '100%',
        width: '640',
        events: {
          'onReady': () => resolve(player),
          'onStateChange': onStateChange
        }
      });
    });
  </script>
  <script id="1052" type="application/vnd.observable.javascript">
    mutable hasPlayed = false // Its good UX not to play a video immediately when visiting a page
  </script>
  <script id="190" type="application/vnd.observable.javascript">
    hash = Generators.observe(notify => {
      const hashchange = () => notify(location.hash);
      hashchange();
      addEventListener("hashchange", hashchange);
      return () => removeEventListener("hashchange", hashchange);
    })
  </script>
  <script id="568" type="application/vnd.observable.javascript">
    stylesheet= html`<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.1/css/bulma.min.css">`
  </script>
  <script id="242" type="application/vnd.observable.javascript">
    import {jsx, render, component, useState, useCallback} from '@j-f1/react'
  </script>
  <script id="1096" type="application/vnd.observable.javascript">
    dot = require("@observablehq/graphviz@0.2")
  </script>
</notebook>
