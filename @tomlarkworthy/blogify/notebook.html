<!doctype html>
<notebook theme="air">
  <title>Blogify</title>
  <script id="240" type="text/markdown">
    # Blogify 
  </script>
  <script id="0" type="text/markdown">
    Creates a link to a pre-rendered static snapshot of any notebook. The goal is to make writing blog posts easier on Observable, by allowing notebooks to be exported as plain HTML. 

    This makes it much easier to syndicate to other sites like [dev.to](https://dev.to) or [Medium](https://medium.com) using their ["import story"](https://medium.com/p/import) feature by passing the link generated here.
  </script>
  <script id="345" type="text/markdown">
    ### Step 1. Fill out the URL of the notebook you wish to Blogify
  </script>
  <script id="11" type="application/vnd.observable.javascript">
    viewof notebookURL = Inputs.bind(
      Inputs.text({ label: "Notebook URL", width: "100%", submit: true }),
      localStorageView("blog", {
        defaultValue: "https://observablehq.com/@tomlarkworthy/notebooks2021"
      })
    )
  </script>
  <script id="332" type="text/markdown">
    ---
    ### Step 2: Here is your statically rendered links!

    These links can be used to syndicate your original notebook
  </script>
  <script id="109" type="application/vnd.observable.javascript">
    html`<h2><a target="_blank" href="${server.href}?notebook=${encodeURIComponent(
      notebookURL
    )}">blogified link</a> (works with <a target="_blank" href="https://medium.com/p/import">Medium import story</a>)`
  </script>
  <script id="254" type="application/vnd.observable.javascript">
    html`<h2><a target="_blank" href="${rss.href}?notebook=${encodeURIComponent(
      notebookURL
    )}">blogified Atom feed</a> (works with <a href="https://dev.to/settings/extensions">dev.to</a> submit your feed in <a href="https://dev.to/settings/extensions">extensions</a>)`
  </script>
  <script id="414" type="text/markdown">
    ## Preview
  </script>
  <script id="417" type="application/vnd.observable.javascript" pinned="">
    html`${(await await getData(notebookURL)).content}`
  </script>
  <script id="335" type="text/markdown">
    ---

    ### Implementation
  </script>
  <script id="139" type="application/vnd.observable.javascript">
    template = (config) => `<html lang="en" prefix="og: http://ogp.me/ns#">
    <head>
    <meta property="og:type" content="article">
    <meta property="og:title" content="${config.title}">
    <meta property="og:description" content="${config.description}">
    <meta property='article:author' content='${config.author}' />
    <link rel="canonical" href="${config.notebookURL}">
    </head>
    <body>
    ${config.content}
    </body>
    </html>`
  </script>
  <script id="17" type="application/vnd.observable.javascript" pinned="">
    generate = async (id) => {
      console.log("generate", id);
      const container = document.createElement("article");
      const [{ Runtime, Inspector }, { default: define }] = await Promise.all([
        import(
          "https://cdn.jsdelivr.net/npm/@observablehq/runtime@4/dist/runtime.js"
        ),
        import(`https://api.observablehq.com/d/${id}.js?v=3`)
      ]);

      let pending = 0;

      new Runtime().module(define, (name) => {
        const node = document.createElement("div");
        container.appendChild(node);
        if (name) node.id = name;
        return {
          pending() {
            pending++;
          },
          fulfilled(value) {
            if (value instanceof HTMLElement) {
              node.replaceWith(value);
            } else {
              console.log("skipping", value);
            }
            pending--;
          },
          rejected(error) {
            pending--;
          }
        };
      });
      let secs = 0;
      do {
        console.log("wait");
        await new Promise((resolve) => setTimeout(resolve, 1000));
        secs++;
      } while (pending > 0 && secs < 2);
      return container;
    }
  </script>
  <script id="271" type="application/vnd.observable.javascript">
    getData = async (notebookURL) => {
      const metadata = db.child(FKEY.encode(notebookURL)).once("value");
      const notebookSuffix = notebookURL
        .replace("https://observablehq.com/d/", "")
        .replace("https://observablehq.com/", "");
      const [content, author] = await getMetadata(
        notebookSuffix
      ).then((notebookData) => [generate(notebookData.id), notebookData.author]);
      return {
        notebookURL,
        ...(await metadata).val(),
        author,
        content: (await content).outerHTML
      };
    }
  </script>
  <script id="53" type="application/vnd.observable.javascript">
    server = deploy(
      "default",
      async (req, res) => {
        const notebookURL = (req.query || {}).notebook;
        const data = await getData(notebookURL);
        res.header("Content-type", "text/html");
        res.send(template(data));
      },
      { region: "europe-west4" }
    )
  </script>
  <script id="256" type="application/vnd.observable.javascript">
    rss = deploy("rss", async (req, res) => {
      const notebookURL = (req.query || {}).notebook;
      const data = await getData(notebookURL);
      res.header("content-type", "application/xml");
      res.send(`<?xml version="1.0" encoding="utf-8"?>
    <feed xmlns = "http://www.w3.org/2005/Atom">
      <title><![CDATA[${data.title}]]></title>
      <id>https://observablehq.com/@tomlarkworthy/blogify?notebook=${notebookURL}</id>
        <updated>${new Date().toISOString()}</updated>
      <entry>
        <id>${notebookURL}</id>
        <updated>${new Date().toISOString()}</updated>
        <author><name>${data.author}</name></author>
        <title><![CDATA[${data.title}]]></title>
        <link href = "https://webcode.run/observablehq.com/@tomlarkworthy/blogify?notebook=${encodeURIComponent(
          notebookURL
        )}"/>
        <content type="html"><![CDATA[${data.content}]]></content>
      </entry>
    </feed>
    `);
    })
  </script>
  <script id="20" type="application/vnd.observable.javascript">
    import { getMetadata } from "@mootari/notebook-data@366"
  </script>
  <script id="50" type="application/vnd.observable.javascript">
    import { deploy } from "@endpointservices/webcode"
  </script>
  <script id="84" type="application/vnd.observable.javascript">
    import { localStorageView } from "@tomlarkworthy/local-storage-view"
  </script>
  <script id="162" type="application/vnd.observable.javascript">
    import { randomId } from "@tomlarkworthy/randomid"
  </script>
  <script id="177" type="application/vnd.observable.javascript">
    db = firebase.database().ref("@tomlarkworthy/blogify")
  </script>
  <script id="170" type="application/vnd.observable.javascript">
    import {
      firebase,
      DocView,
      FKEY
    } with { FIREBASE_CONFIG as firebaseConfig } from "@tomlarkworthy/firebase"
  </script>
  <script id="168" type="application/vnd.observable.javascript">
    FIREBASE_CONFIG = ({
      apiKey: "AIzaSyBN4bxw6d0cM0CGPNzRrkRlBqwFQnPLdN4",
      databaseURL:
        "https://larkworthy-dfb11-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "larkworthy-dfb11",
      appId: "1:786910701676:web:8d7dd002acf3b78c74d049"
    })
  </script>
</notebook>
