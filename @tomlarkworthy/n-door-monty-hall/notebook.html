<!doctype html>
<notebook theme="air">
  <title>N-door Monty Hall</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# N-door Monty Hall

    The Monty Hall Problem:

    A gameshow host asks you to pick a door. It is not opened.
    Next, the gameshow host opens a different door NOT containing a prize.
    You get to pick a door again, should you switch from your original guess?

    This application lets you try different amounts of doors and keeps track of the win ratio and whether you swapped or not for you (using [Plot](https://observablehq.com/@observablehq/plot)).

    `
  </script>
  <script id="94" type="application/vnd.observable.javascript">
    viewof game = {
      const n = Inputs.range([3, 20], {
        value: 3,
        step: 1,
        label: "Number of doors (applies on game cycle)"
      });
      const doors = viewroutine(async function*() {
        const history = new Map();
        while (true) {
          const nChosen = n.value;
          let state = {
            history,
            doors: Array(nChosen).fill("closed")
          };
          let prize = Math.floor(Math.random() * state.doors.length);
          let firstPick = yield* pickDoor(state);
          // Open other doors not the prize and not the one picked
          let otherDoor = prize;
          while (otherDoor === firstPick) {
            otherDoor = Math.floor(Math.random() * state.doors.length);
          }
          state.doors = state.doors.map((s, index) =>
            index === otherDoor || index === firstPick ? "closed" : "openingEmpty"
          );
          let secondPick = yield* pickDoor(state);
          const swapped = secondPick !== firstPick;
          state.doors = state.doors.map(s => (s === "openingEmpty" ? "empty" : s));
          state.doors[secondPick] =
            secondPick === prize ? "openingPrize" : "openingEmpty";
          yield* pickDoor(state);
          const won = secondPick === prize;
          const historyKey = JSON.stringify([swapped, nChosen]);
          if (!history.has(historyKey)) {
            history.set(historyKey, { n: 0, w: 0 });
          }
          console.log(
            history,
            historyKey,
            history.has(historyKey),
            history.get(historyKey)
          );
          if (won) history.get(historyKey).w++;
          history.get(historyKey).n++;
        }
      });
      return view`<div>
        ${n}
        ${doors}
      </div>`;
    }
  </script>
  <script id="70" type="application/vnd.observable.javascript">
    pickDoor = async function*(doors) {
      let notify;
      const result = new Promise(resolve => (notify = resolve));
      yield doorButtons(doors, notify);
      return await result;
    }
  </script>
  <script id="111" type="application/vnd.observable.javascript">
    doorButtons = async ({ doors, history } = {}, notify) => {
      const imgs = await promiseRecursive(
        doors.map(door => {
          if (door === 'closed') return FileAttachment("e0@1.jpg").image();
          if (door === 'empty') return FileAttachment("e3@1.jpg").image();
          if (door === 'prize') return FileAttachment("b3@1.jpg").image();
        })
      );
      const buttons = doors.map((door, i) =>
        door === 'closed'
          ? ((imgs[i].onclick = () => notify(i)), imgs[i])
          : door === 'openingEmpty'
          ? viewroutine(openEmptyDoor.bind(null, invalidation))
          : door === 'openingPrize'
          ? viewroutine(openPrizeDoor.bind(null, invalidation))
          : imgs[i]
      );
      const processed = [...history.keys()].map(key => {
        const [swapped, n] = JSON.parse(key);
        return {
          n,
          swapped,
          win_rate: history.get(key).w / history.get(key).n
        };
      });
      return htl.html`<div>
        <style>
          .game {
            display:flex;
            width: 100%
          }
          .game > img,.game > span {
            width: 1px;
            flex-grow: 1;
            flex-shrink: 1;
          }
          .game > span > img {
            width: 100%;
          }
        </style>
        <div>
          ${Plot.plot({
            y: {
              domain: [0, 1]
            },
            color: {
              domain: [false, true]
            },
            x: {
              domain: [false, true]
            },
            facet: {
              data: processed,
              x: "n"
            },
            height: 200,
            marks: [
              Plot.barY(processed, {
                x: "swapped",
                y: "win_rate",
                fill: 'swapped'
              }),
              Plot.ruleY([0])
            ]
          })}
        </div>
        <div class="game">
          ${buttons}
        </div>
      </div>`;
    }
  </script>
  <script id="14" type="application/vnd.observable.javascript">
    async function* openEmptyDoor(finish) {
      yield FileAttachment("e0@1.jpg").image();
      await Promises.delay(200);
      yield FileAttachment("e1@1.jpg").image();
      await Promises.delay(200);
      yield FileAttachment("e2@1.jpg").image();
      await Promises.delay(200);
      yield FileAttachment("e3@1.jpg").image();
      await finish;
    }
  </script>
  <script id="44" type="application/vnd.observable.javascript">
    async function* openPrizeDoor(finish) {
      yield FileAttachment("b0@1.jpg").image();
      await Promises.delay(200);
      yield FileAttachment("b1@1.jpg").image();
      await Promises.delay(200);
      yield FileAttachment("b2@1.jpg").image();
      await Promises.delay(200);
      yield FileAttachment("b3@1.jpg").image();
      await finish;
    }
  </script>
  <script id="326" type="application/vnd.observable.javascript">
    md`The animations are quicker to load if you run through it once`
  </script>
  <script id="211" type="application/vnd.observable.javascript" pinned="">
    openPrizeDoor()
  </script>
  <script id="213" type="application/vnd.observable.javascript" pinned="">
    openEmptyDoor()
  </script>
  <script id="11" type="application/vnd.observable.javascript">
    import { viewroutine, ask } from '@tomlarkworthy/viewroutine'
  </script>
  <script id="86" type="application/vnd.observable.javascript">
    import { view } from '@tomlarkworthy/view'
  </script>
  <script id="76" type="application/vnd.observable.javascript">
    import { promiseRecursive } from '@tomlarkworthy/utils'
  </script>
  <script id="335" type="application/vnd.observable.javascript" pinned="">
    import { footer } from "@tomlarkworthy/footer"
  </script>
  <script id="353" type="application/vnd.observable.javascript" pinned="">
    footer
  </script>
</notebook>
