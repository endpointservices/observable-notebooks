<!doctype html>
<notebook theme="air">
  <title>Notebook in VR</title>
  <script id="0" type="text/markdown">
    # Notebook in VR

  </script>
  <script id="37" type="application/vnd.observable.javascript">
    aframe = {
      const aframe = (window.aframe = await require("aframe"));
      await require("aframe-environment-component").catch(() => {}); // Adds environment preset:starry
      return aframe;
    }
  </script>
  <script id="202" type="application/vnd.observable.javascript">
    viewof runDemo = Inputs.button("run", {
      reduce: run
    })
  </script>
  <script id="247" type="text/html" pinned="">
    <a-scene
        debug
        embedded
        style="width: ${width}px; height: 400px;"
        environment="preset:starry"
        webxr="requiredFeatures: hit-test,local-floor,dom-overlay;
               overlayElement: #${overlay.id};">
      ${aframe && ''}
      <a-entity id="cameraRig">
        <a-entity camera position="0 1.5 0" look-controls wasd-controlsw>
        </a-entity>
      </a-entity>

      <a-entity id="circles">
      </a-entity>
    </a-scene>
  </script>
  <script id="327" type="application/vnd.observable.javascript" pinned="">
    aframeRig.systems.webxr.sceneEl
  </script>
  <script id="356" type="application/vnd.observable.javascript" pinned="">
    aframeRig.systems.webxr.sceneEl
  </script>
  <script id="315" type="application/vnd.observable.javascript" pinned="">
    overlay = htl.html`<div id="overlay">
    ${Inputs.range()}
    </div>`
  </script>
  <script id="46" type="application/vnd.observable.javascript" pinned="">
    interpolatePositionList =  function(d, i, nodeList) {
      let a = nodeList[i].attributes.position.value
      let [x, y, z] = a.split(/\s+/).map(Number)
      return (t) => `${(1-t) * x + t*d.x} ${(1-t) * y + t*d.y} ${(1-t) * z + t * z}`
    }
  </script>
  <script id="275" type="application/vnd.observable.javascript" pinned="">
    opts = ({
      numCircles: 500,
      size: 10,
      maxRadius: 0.3,
      minRadius: 0.05,
      range: 10
    })
  </script>
  <script id="310" type="application/vnd.observable.javascript" pinned="">
    color = d3
      .scaleSequential()
      .domain([0, 2 * Math.PI])
      .interpolator(d3.interpolateRainbow)
  </script>
  <script id="49" type="application/vnd.observable.javascript" pinned="">
    run = () => {
      console.log("running packing demo");
      let scene = d3.select(aframeRig).select("a-scene");

      var circles = d3
        .packSiblings(
          d3
            .range(opts.numCircles)
            .map(d3.randomUniform(opts.minRadius, opts.maxRadius))
            .map(function (r) {
              return { r: r };
            })
        )
        .filter(function (d) {
          return (
            -opts.range < d.x &&
            d.x < opts.range &&
            -opts.range < d.y &&
            d.y < opts.range
          );
        });

      let cs = scene.select("a-entity#circles").attr("position", "0 10 -10");

      let circleEls = cs.selectAll("a-circle").data(circles);

      circleEls
        .enter()
        .append("a-circle")
        .merge(circleEls)
        .attr("emissive", function (d) {
          return color((d.angle = Math.atan2(d.y, d.x)));
        })
        .attr(
          "position",
          (d) =>
            `${Math.cos(d.angle) * (opts.size / Math.SQRT2 + 1)} ${
              Math.sin(d.angle) * (opts.size / Math.SQRT2 + 1)
            } 0`
        )
        .attr("radius", function (d) {
          return d.r - 0.005;
        })
        .transition()
        .ease(d3.easeCubicOut)
        .delay(function (d) {
          return Math.sqrt(d.x * d.x + d.y * d.y) * 1000;
        })
        .duration(1000)
        .attrTween("position", interpolatePositionList);
    }
  </script>
</notebook>
