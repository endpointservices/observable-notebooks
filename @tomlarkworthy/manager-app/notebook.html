<!doctype html>
<notebook theme="air">
  <title>Manager's Chore App</title>
  <script id="0" type="text/markdown">
    # Manager's Chore App

    please signing below to access your team data
  </script>
  <script id="31" type="application/vnd.observable.javascript">
    viewof teaminfo = cellstore({
      owner: "tomlarkworthy",
      key: "teaminfo",
      per_user: true,
      writers: "all",
      readers: "all"
    })
  </script>
  <script id="63" type="text/markdown">
    ### Your Team
  </script>
  <script id="50" type="application/vnd.observable.javascript">
    Inputs.table(teaminfo.team)
  </script>
  <script id="143" type="application/vnd.observable.javascript">
    viewof teamMember = Inputs.form({
      name: Inputs.text({
        label: "name"
      }),
      email: Inputs.text({
        label: "email"
      })
    })
  </script>
  <script id="156" type="application/vnd.observable.javascript">
    Inputs.button("add team member", {
      reduce: () => {
        viewof teaminfo.value = {
          ...viewof teaminfo.value,
          team: [...viewof teaminfo.value.team, { ...teamMember, id: randomId() }]
        };
      }
    })
  </script>
  <script id="72" type="text/markdown">
    ### Upcoming events
  </script>
  <script id="74" type="application/vnd.observable.javascript">
    Inputs.table(teaminfo.events)
  </script>
  <script id="80" type="text/markdown">
    ### Tasks
  </script>
  <script id="82" type="application/vnd.observable.javascript">
    Inputs.table(Object.entries(teaminfo.tasks).map(([k, v]) => ({ id: k, ...v })))
  </script>
  <script id="217" type="application/vnd.observable.javascript" pinned="">
    sendTask(teaminfo.team[0], teaminfo.tasks["getQuantity"])
  </script>
  <script id="235" type="application/vnd.observable.javascript" pinned="">
    teaminfo
  </script>
  <script id="197" type="application/vnd.observable.javascript" pinned="">
    function sendTask(user, task) {
      const dbpath = `tasks/${user.id}/${task.id}`;
      // Save the task to the database under the user's id\
      db.ref(dbpath).set(task.html);

      // Create a link to a webpage with a parameter of the database record
      const link = `https://observablehq.com/d/8a1ca79e6b18857c?rtdbtask=${encodeURIComponent(
        dbpath
      )}`;

      // Create the email
      const email = `
        Dear ${user.name},
        Please click the link below to view your task:
        <a href=${link}>your task</a>
        Best regards,
        The Team
      `;

      // Send the email
      sendEmail({
        to: user.email,
        title: "Your Task",
        body: email
      });
    }
  </script>
  <script id="42" type="application/vnd.observable.javascript">
    Inputs.button("update database", {
      reduce: () => {
        viewof teaminfo.value = {
          events: [
            {
              person_id: "lkfahjflkahjflkda",
              date: "2022-09-15T18:56:01",
              template_id: "getQuantity"
            }
          ],
          tasks: {
            getQuantity: {
              id: "getQuantity",
              type: "rtdb",
              html: `<form action="https://observablehq.com/d/8a1ca79e6b18857c"><label for="qty">Qty</label><input type="number" name="qty" id="qty"><input type="hidden" name="respond" value="/responses/lkjasdlkasjkljdsa"><button type="submit">submit</button></form>`
            }
          },
          team: [
            {
              id: "lkfahjflkahjflkda",
              name: "Tom",
              email: "tom.larkworthy@gmail.com"
            }
          ]
        };
      }
    })
  </script>
  <script id="39" type="application/vnd.observable.javascript">
    cellstoreDeps
  </script>
  <script id="6" type="application/vnd.observable.javascript">
    import { cellstore, cellstoreDeps } from "@endpointservices/cellstore"
  </script>
  <script id="92" type="application/vnd.observable.javascript">
    import { createTrigger } from "@endpointservices/zapier"
  </script>
  <script id="114" type="application/vnd.observable.javascript">
    sendEmail = createTrigger({
      name: "sendemail",
      authorized_public_keys: ["SAwh+7heCihCOMYFVfDT3o9Piy2K5V7c8XNzQYVpkGU="],
      checkPayload: () => true, // TODO: we need to check the content validity to avoid spamming
      sample: {
        to: "tom.larkworthy@gmail.com",
        title: "Title of the email",
        body: "This is the email body"
      }
    })
  </script>
  <script id="116" type="application/vnd.observable.javascript" pinned="">
    sendEmail({
      to: "tom.larkworthy@gmail.com",
      title: "Testing email sending",
      body: "Hi this is a test"
    })
  </script>
  <script id="167" type="application/vnd.observable.javascript" pinned="">
    randomId = () => Math.random().toString(16).substring(3)
  </script>
  <script id="203" type="application/vnd.observable.javascript" pinned="">
    import {
      firebase,
      viewof user,
      listen
    } with { firebaseConfig as firebaseConfig } from "@tomlarkworthy/firebase"
  </script>
  <script id="207" type="application/vnd.observable.javascript" pinned="">
    db = firebase.database()
  </script>
  <script id="205" type="application/vnd.observable.javascript" pinned="">
    firebaseConfig = ({
      apiKey: "AIzaSyAy7DrkXtQdHcJ6eLhBuXHAP1EDkJxHDSc",
      authDomain: "choreapp-954bd.firebaseapp.com",
      databaseURL:
        "https://choreapp-954bd-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "choreapp-954bd",
      storageBucket: "choreapp-954bd.appspot.com",
      messagingSenderId: "834144188417",
      appId: "1:834144188417:web:0d8da2a55d89eb1e77e800",
      uiConfig: {
        // https://github.com/firebase/firebaseui-web#configuration
        signInOptions: ["google.com", "password", "phone"]
        // tosUrl: '<your-tos-url>', // Terms of service url.
        // privacyPolicyUrl: '<your-privacy-policy-url>', // Privacy policy url.
      }
    })
  </script>
</notebook>
