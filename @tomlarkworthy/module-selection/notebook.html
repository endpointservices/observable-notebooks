<!doctype html>
<notebook theme="air">
  <title>Explorer: Module Selector</title>
  <script id="0" type="text/markdown">
    # Explorer: Module Selector
  </script>
  <script id="33" type="application/vnd.observable.javascript">
    viewof selected_modules = {
      exportState; // do after URL is set by exported state
      persistedAttachments; // load persisted modules as well
      hash; // recompute if hash changes
      const hashModules = getHashModules();
      const modules = [...currentModules.values()].map((m) => ({
        ...m,
        cell: hashModules.get(m.name)?.cell
      }));
      return Inputs.table(modules, {
        rows: Infinity,
        sort: "name",
        columns: ["name" /*, "cell"*/],
        required: false,
        value: modules.filter((m) => hashModules.get(m.name)),
        format: {
          name: (name) => html`<a href="${linkTo(name)}">${name}</a>`
        }
      });
    }
  </script>
  <script id="531" type="application/vnd.observable.javascript">
    viewof create_module = Inputs.text({
      label: "create module",
      width: "400px",
      submit: "create",
      placeholder: "@user/scratch",
      width: "400px",
      pattern: "^@[A-Za-z0-9]+(?:-[A-Za-z0-9]+)*/[A-Za-z0-9]+(?:-[A-Za-z0-9]+)*$"
    })
  </script>
  <script id="214" type="application/vnd.observable.javascript">
    viewof additional_module = Inputs.text({
      label: "load module",
      placeholder: "@tomlarkworthy/debugger",
      width: "400px",
      pattern: "^@[A-Za-z0-9]+(?:-[A-Za-z0-9]+)*/[A-Za-z0-9]+(?:-[A-Za-z0-9]+)*$",
      submit: "import"
    })
  </script>
  <script id="527" type="application/vnd.observable.javascript">
    viewof remove_module = Inputs.select([null, ...currentModules.values()], {
      label: "remove module",
      width: "400px",
      format: (module) => module?.name
    })
  </script>
  <script id="482" type="application/vnd.observable.javascript">
    visualizeModules()
  </script>
  <script id="744" type="application/vnd.observable.javascript">
    import { cellMap } from "@tomlarkworthy/observablejs-toolchain"
  </script>
  <script id="312" type="application/vnd.observable.javascript">
    import { exporter, exportState } from "@tomlarkworthy/exporter" // Important we boot urlss after exportState has set URL
  </script>
  <script id="314" type="application/vnd.observable.javascript">
    exporter()
  </script>
  <script id="226" type="text/markdown">
    ## Additional Modules

    Extra modules for dynamic loading are named as a JSON list in file attachment `additionalModules.json`
  </script>
  <script id="422" type="application/vnd.observable.javascript">
    viewof notebookModule = thisModule()
  </script>
  <script id="232" type="application/vnd.observable.javascript">
    import { importNotebook } from "@tomlarkworthy/import-notebook"
  </script>
  <script id="255" type="application/vnd.observable.javascript">
    import {
      jsonFileAttachment,
      setFileAttachment,
      removeFileAttachment,
      getFileAttachments
    } from "@tomlarkworthy/fileattachments";
  </script>
  <script id="264" type="application/vnd.observable.javascript">
    persistedAttachments = {
      const attachments = getFileAttachments(notebookModule);
      if (attachments.has("additionalModules.json")) {
        const extras = new Set(
          await attachments.get("additionalModules.json").json()
        );
        await Promise.all(
          [...extras].map(async (notebook) => await importNotebook(notebook, []))
        );
        return extras;
      } else return new Set();
    }
  </script>
  <script id="562" type="application/vnd.observable.javascript">
    additionalModules = persistedAttachments || new Set()
  </script>
  <script id="565" type="application/vnd.observable.javascript">
    function addModuleAndPersist(name) {
      additionalModules.add(name);
      setFileAttachment(
        jsonFileAttachment("additionalModules.json", [...additionalModules]),
        notebookModule
      );
    }
  </script>
  <script id="576" type="application/vnd.observable.javascript">
    removeModuleAndPersist = (name) => {
      additionalModules.delete(name);
      setFileAttachment(
        jsonFileAttachment("additionalModules.json", [...additionalModules]),
        notebookModule
      );
    }
  </script>
  <script id="734" type="application/vnd.observable.javascript" pinned="">
    runtime._compute()
  </script>
  <script id="553" type="application/vnd.observable.javascript" pinned="">
    createModule = {
      const input = viewof create_module.querySelector("input");
      const report = () => viewof create_module.reportValidity();
      input.addEventListener("input", report);
      invalidation.then(() => input.removeEventListener("input", report));

      if (create_module && create_module !== "") {
        const runtime = notebookModule._runtime;
        const moduleSource = `export default function define(runtime, observer) {
          const main = runtime.module();
          main.variable(observer()).define(["md"], (md) => md\`# Untitled\`);
        }`;
        const blob = new Blob([moduleSource], { type: "text/javascript" });
        const url = URL.createObjectURL(blob);
        const variableSource = `async () => "${create_module}" && runtime.module((await import("${url}")).default)`;
        let definition;
        eval("definition = " + variableSource);
        const moduleVariable = notebookModule.define(
          `module ${create_module}`,
          [],
          definition
        );
        addModuleAndPersist(create_module);
        return moduleVariable;
      }
    }
  </script>
  <script id="237" type="application/vnd.observable.javascript">
    addModule = {
      const input = viewof additional_module.querySelector("input");
      const report = () => viewof additional_module.reportValidity();
      input.addEventListener("input", report);
      invalidation.then(() => input.removeEventListener("input", report));
      if (
        additional_module &&
        additional_module !== "" &&
        !additionalModules.has(additional_module)
      ) {
        await importNotebook(additional_module, []);
        addModuleAndPersist(additional_module);
      }
    }
  </script>
  <script id="582" type="application/vnd.observable.javascript">
    removeModule = {
      if (remove_module) {
        removeModuleAndPersist(remove_module);
        const variables = [...remove_module.module._runtime._variables].filter(
          (v) =>
            v._module == remove_module.module ||
            v._name == `module ${remove_module.name}`
        );
        const entry = [...remove_module.module._runtime._modules.entries()].find(
          ([key, value]) => value == remove_module.module
        );

        if (entry) {
          const [define, module] = entry;
          remove_module.module._runtime._modules.delete(define);
        }

        variables.forEach((v) => v.delete());
        return remove_module;
      }
    }
  </script>
  <script id="688" type="application/vnd.observable.javascript">
    moduleMap()
  </script>
  <script id="183" type="text/markdown">
    ## URL encoding
  </script>
  <script id="339" type="application/vnd.observable.javascript">
    import {
      parseGoldenDSL,
      listModules,
      serializeGoldenDSL,
      linkTo,
      updateNotebookImports
    } from "@tomlarkworthy/lopepage-urls"
  </script>
  <script id="377" type="application/vnd.observable.javascript">
    getHashModules = () => {
      const hash = location.hash;
      const hashParams = new URLSearchParams(hash.slice(1));
      try {
        return listModules(hashParams.get("view"));
      } catch (err) {
        console.log(err);
        return [];
      }
    }
  </script>
  <script id="68" type="application/vnd.observable.javascript">
    import { hash } from "@jashkenas/url-querystrings-and-hash-parameters"
  </script>
  <script id="186" type="text/markdown">
    ## Model
  </script>
  <script id="223" type="text/markdown">
    ## Background Tasks
  </script>
  <script id="110" type="application/vnd.observable.javascript">
    navigator_jobs = {
      updateNotebookImports, submit_summary;
    }
  </script>
  <script id="5" type="application/vnd.observable.javascript">
    import {
      moduleMap,
      submit_summary,
      viewof currentModules,
      visualizeModules
    } from "@tomlarkworthy/module-map"
  </script>
  <script id="10" type="application/vnd.observable.javascript">
    import { runtime, main } from "@mootari/access-runtime";
  </script>
  <script id="169" type="application/vnd.observable.javascript">
    import { thisModule } from "@tomlarkworthy/runtime-sdk"
  </script>
</notebook>
