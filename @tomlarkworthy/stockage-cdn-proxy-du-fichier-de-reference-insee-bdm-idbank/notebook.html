<!doctype html>
<notebook theme="air">
  <title>Stockage CDN/proxy du fichier de référence Insee BDM idbanks</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`<div style="color: grey; font: 13px/25.5px var(--sans-serif); text-transform: uppercase;"><h1 style="display: none">Stockage CDN/proxy du fichier de référence Insee BDM idbanks</h1><a href="https://observablehq.com/@ericmauviere/insee-bdm-sommaire">INSEE BDM</a> › 4 - Mise en cache</div>

    # Stockage CDN/proxy du fichier de référence Insee BDM idbanks


    `
  </script>
  <script id="80" type="application/vnd.observable.javascript">
    insee_csv_zipped = "https://www.insee.fr/fr/statistiques/fichier/2862759/2021_correspondance_idbank_dimension.zip"
    //"https://www.insee.fr/fr/statistiques/fichier/2862759/2020_correspondance_idbank_dimension.zip"
  </script>
  <script id="182" type="application/vnd.observable.javascript" pinned="">
    results = fetchp(insee_csv_zipped, {
      headers: {
        'x-requested-with': "observablehq.com" // Upstream blocks us without this, silly
      },
      responseHeaders: {
        'transfer-encoding': null, // Its trying to send them in a chunked reponse which is not working ATM
        'Cache-control': `public, max-age=${24 * 7 * 3600}` // We can cache at the proxy level now too!
      }
    })
  </script>
  <script id="205" type="application/vnd.observable.javascript" pinned="">
    content = results.arrayBuffer()
  </script>
  <script id="200" type="application/vnd.observable.javascript">
    unzip = {
      const buf = await jszip.loadAsync(content);
      const file = Object.keys(buf.files)[0];
      return buf.file(file).async("string");
    }
  </script>
  <script id="114" type="application/vnd.observable.javascript">
    md `Le lien suivant pointe vers la ressource extraite, mise en cache pour 1 semaine`
  </script>
  <script id="29" type="application/vnd.observable.javascript" pinned="">
    // deploy the subset as a csv
    deploy("insee_bdm_idbanks_150521.csv", async (req, res) => {
      res.header("Cache-control", `public, max-age=${24 * 7 * 3600}`); //
      res.header("Content-Type", "text/plain");
      res.send(unzip);
    })
  </script>
  <script id="37" type="application/vnd.observable.javascript">
    md`---
    _libraries_`
  </script>
  <script id="198" type="application/vnd.observable.javascript" pinned="">
    jszip = require("jszip@3/dist/jszip.min.js")
  </script>
  <script id="185" type="application/vnd.observable.javascript">
    import { fetchp } from '@tomlarkworthy/fetchp'
  </script>
  <script id="5" type="application/vnd.observable.javascript">
    import { deploy } from '@endpointservices/serverless-cells'
  </script>
</notebook>
