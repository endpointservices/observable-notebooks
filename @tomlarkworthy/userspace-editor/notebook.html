<!doctype html>
<notebook theme="air">
  <title>Userspace notebook editor</title>
  <script id="0" type="text/markdown">
    # Userspace notebook editor


    Can we write an [Observable Runtime](https://github.com/observablehq/runtime) toolchain within a notebook? (previous [notes](https://observablehq.com/d/56315133960a2175))
  </script>
  <script id="690" type="text/markdown">
    ## Observable Runtime and Inspector
  </script>
  <script id="687" type="application/vnd.observable.javascript">
    rt = import(
      "https://cdn.jsdelivr.net/npm/@observablehq/runtime@5/dist/runtime.js"
    )
  </script>
  <script id="79" type="text/markdown">
    ## Compiling

    The [unofficial compiler provides](https://github.com/asg017/unofficial-observablehq-compiler) a way to go from source code to runtime variables. There is a [Quarto fork](https://github.com/quarto-dev/external-asg017-unofficial-observablehq-compiler/) with some bug fixes
  </script>
  <script id="482" type="application/vnd.observable.javascript">
    quarto = import(
      "https://esm.sh/@quarto/external-alex-garcia-unofficial-observablehq-compiler"
    )
  </script>
  <script id="256" type="text/markdown">
    ## Obtaining Notebook Source from Observable documents API

    The [SVG boinger](https://observablehq.com/@tomlarkworthy/svg-boinger) is just a random notebook I made in 2021
    ```
    curl https://api.observablehq.com/document/@tomlarkworthy/svg-boinger
    ```

    Document endpoint not support CORS so I just pasted the results here:
  </script>
  <script id="276" type="application/vnd.observable.javascript">
    notebook_source = FileAttachment("api_document.json").json()
  </script>
  <script id="706" type="text/markdown">
    ## Source editor (CodeMirror)
  </script>
  <script id="332" type="application/vnd.observable.javascript">
    import {
      CodeMirror,
      esmImport,
      javascriptPlugin,
      myDefaultTheme,
      codemirror
    } from "@tomlarkworthy/codemirror-6"
  </script>
  <script id="348" type="application/vnd.observable.javascript">
    cm_js = await esmImport(`@codemirror/lang-javascript`)

  </script>
  <script id="435" type="text/markdown">
    ## Userspace Notebook Editor

  </script>
  <script id="520" type="text/markdown">
    we will declare a view to hold our source, initialised to the SVG Boinger source to test
  </script>
  <script id="478" type="application/vnd.observable.javascript" pinned="">
    viewof notebook = view`${[
      "source",
      notebook_source.nodes /*.slice(0, 2)*/
        .map((i) =>
          CodeMirror(i.value, {
            extensions: [
              javascriptPlugin.javascript(),
              codemirror.basicSetup,
              myDefaultTheme
            ]
          })
        )
    ]}`
  </script>
  <script id="538" type="application/vnd.observable.javascript" pinned="">
    notebook
  </script>
  <script id="549" type="text/markdown">
    ## Userspace Notebook Viewer
  </script>
  <script id="559" type="application/vnd.observable.javascript" pinned="">
    viewof outputs = view`${[
      "outputs",
      viewof notebook.value.source.map((i) => domView({ className: "cell" }))
    ]}`
  </script>
  <script id="557" type="application/vnd.observable.javascript" pinned="">
    outputs
  </script>
  <script id="730" type="text/markdown">
    ## Linking source to the notebook view
  </script>
  <script id="568" type="text/markdown">
    Finally we bind the source to the output with a oneWayBind that transforms using the compiler
  </script>
  <script id="570" type="application/vnd.observable.javascript" pinned="">
    link = {
      const embedded_runtime = new rt.Runtime().module();
      const interpret = new quarto.Interpreter({
        module: embedded_runtime
      });
      viewof notebook.source.value.forEach((src, i) => {
        let variables = [];
        const inspector = rt.Inspector.into(viewof outputs.outputs[i]);
        const onInput = async (_) => {
          const src = viewof notebook.source[i].value;
          variables.forEach((v) => {
            v.delete();
          });
          viewof outputs.outputs[i].value = null;
          variables = await interpret.cell(src, embedded_runtime, inspector);
        };
        viewof notebook.source[i].addEventListener("input", onInput);
        onInput();

        invalidation.then(() =>
          viewof notebook.source[i].removeEventListener("input", onInput)
        );
      });
      return embedded_runtime;
    }
  </script>
  <script id="311" type="text/markdown">
    ---
  </script>
  <script id="540" type="application/vnd.observable.javascript">
    import { view, bindOneWay } from "@tomlarkworthy/view"
  </script>
  <script id="554" type="application/vnd.observable.javascript">
    import { domView } from "@tomlarkworthy/dom-view"
  </script>
  <script id="743" type="application/vnd.observable.javascript">
    import { footer } from "@tomlarkworthy/footer"
  </script>
  <script id="746" type="application/vnd.observable.javascript">
    footer
  </script>
</notebook>
