<!doctype html>
<notebook theme="air">
  <title>Mutable Form Input</title>
  <script id="0" type="application/vnd.observable.javascript">
    md`# Mutable Form Input

    This notebook defines a *form* function which makes it easier to use complex forms together with [Observable views](/@mbostock/introduction-to-views). To use it in your notebook:

    \`\`\`js
    import {form} from "@tomlarkworthy/mutable-form-input"
    \`\`\`

    Pass the *form* function a form element, and you‚Äôre off to the races! üêé`
  </script>
  <script id="4" type="application/vnd.observable.javascript" pinned="">
    viewof object = form(html`<form>
      <div><label><input name="message" type="text" value="Hello, form!"> <i>message</i></label></div>
      <div><label><input name="hue" type="range" min=0 max=360> <i>hue</i></label></div>
      <div>
        <label><input name="size" type="radio" value="12"> <i>small</i></label>
        <label><input name="size" type="radio" value="24" checked> <i>medium</i></label>
        <label><input name="size" type="radio" value="48"> <i>large</i></label>
      </div>
      <div>
        <label>
          <select name="emojis" multiple size="3">
            <option value="üçé">üçé</option>
            <option value="üî•">üî•</option>
            <option value="üêô">üêô</option>
          </select>
        <i>emojis</i></label>
      </div>
    </form>`)
  </script>
  <script id="19" type="application/vnd.observable.javascript" pinned="">
    object
  </script>
  <script id="135" type="application/vnd.observable.javascript">
    md`Now you have a reactive reference to resulting object!`
  </script>
  <script id="116" type="application/vnd.observable.javascript" pinned="">
    html`<svg
      width="640"
      height="64"
      viewBox="0 0 640 64"
      style="width:100%;max-width:640px;height:auto;display:block;background:#333;"
    >
      ${Object.assign(
        svg`<text
        x="50%"
        y="50%"
        text-anchor="middle" 
        dy="0.35em"
        fill="hsl(${object.hue},100%,50%)"
        font-size="${object.size}"
      >`,
        {
          textContent: `${object.message} ${object.emojis.join(" ")}`
        }
      )}
    </svg>`
  </script>
  <script id="98" type="application/vnd.observable.javascript">
    md`---

    ## Implementation`
  </script>
  <script id="8" type="application/vnd.observable.javascript" pinned="">
    function form(form) {
      const container = html`<div>${form}`;
      form.addEventListener("submit", event => event.preventDefault());
      form.addEventListener("change", () => container.dispatchEvent(new CustomEvent("input")));
      form.addEventListener("input", () => value = formValue(form));
      let value = formValue(form);
      Object.defineProperty(container, 'value', {
        get: () => value,
        set: (newValue) => {
          value = newValue;
          setFormValue(form, newValue)
        }
      })
      return container
    }
  </script>
  <script id="24" type="application/vnd.observable.javascript" pinned="">
    function formValue(form) {
      const object = {};
      for (const input of form.elements) {
        if (input.disabled || !input.hasAttribute("name")) continue;
        let value = input.value;
        switch (input.type) {
          case "range":
          case "number": {
            value = input.valueAsNumber;
            break;
          }
          case "date": {
            value = input.valueAsDate;
            break;
          }
          case "radio": {
            if (!input.checked) continue;
            break;
          }
          case "checkbox": {
            if (input.checked) value = true;
            else if (input.name in object) continue;
            else value = false;
            break;
          }
          case "file": {
            value = input.multiple ? input.files : input.files[0];
            break;
          }
          case "select-multiple": {
            value = Array.from(input.selectedOptions, option => option.value);
            break;
          }
        }
        object[input.name] = value;
      }
      return object;
    }
  </script>
  <script id="163" type="application/vnd.observable.javascript" pinned="">
    function setFormValue(form, newValue) {
      for (const input of form.elements) {
        if (input.disabled || !input.hasAttribute("name")) continue;
        switch (input.type) {
          default:
          case "range":
          case "number":
          case "date":
            input.value = newValue[input.name];
            break;
          case "radio":
            input.checked = newValue[input.name] === input.value;
            break;
          case "select-multiple":
            Array.from(input.options).forEach(option => {
              option.selected = newValue[input.name].includes(option.value)
            });
            break;

          case "file":
            throw new Error("Not implemented")
            break;
        }
      }
    }
  </script>
  <script id="194" type="application/vnd.observable.javascript" pinned="">
    setFormValueTest = {
      viewof object.value = {
        ...viewof object.value,
        message: "hi from setFormValue test",
        size: "12",
        emojis: ["üçé", "üî•"]
      }
      viewof object.dispatchEvent(new CustomEvent('input'))
    }
  </script>
</notebook>
