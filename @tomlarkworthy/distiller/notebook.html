<!doctype html>
<notebook theme="air">
  <title>Notebook distiller v2</title>
  <script id="0" type="text/markdown">
    # Notebook distiller v2

    <figure><img src='https://i.imgur.com/VAsGp5S.gif' /></figure>

    This notebook is a tool that allows you to output some _subset_ of Observable notebooks as _pure ES6 modules_. That means no runtime, with natural-looking JavaScript code, ready to become NPM modules.

    - Emphasis on _pure_: this is really meant for notebooks like [parse-gedcom](/@tmcw/parse-gedcom), that are written with the intent of serving as fodder for NPM distribution.

    This fork adds a webserver so you can access distilled code from outside Observable (e.g. as part of a publish to NPM CI pipeline) and adds a few debugging features.

  </script>
  <script id="552" type="text/markdown">
    ### Open Issues

    If you encouter a bug not on this list please send a comment via the burger menu on the left!

    - Cannot handle imports (but theoretically possible)
    - Cannot handle standard library calls (might be possible)
  </script>
  <script id="353" type="text/markdown">
    ### Change log
    - 2022-04-08 Tom Larkworthy, added support for 'require'
    - 2021-12-22, Tom Larkworthy, acorn parser set to EMCA 12, syntax errors now print source hints. Added link to bundle.js.
    - 2018-11-15, Tom MacWright, created the notebook distiller. 
  </script>
  <script id="401" type="application/vnd.observable.javascript">
    viewof config = view`<div>
    ${[
      "notebookName",
      Inputs.bind(
        Inputs.text({
          minlength: 1,
          width: "50%",
          placeholder: "@tomlarkworthy/redis",
          label: "Notebook path"
        }),
        localStorageView("@tomlarkworthy/distiller/notebook")
      )
    ]}
    ${[
      "entryPoint",
      dynamicSelect([], {
        label: "Entry point"
      })
    ]}
    ${["promisify", Inputs.toggle({ label: "promisify" })]}
    `
  </script>
  <script id="703" type="application/vnd.observable.javascript" pinned="">
    config
  </script>
  <script id="512" type="text/html">
    ${(code, '')}
    <a href="${host.href}?notebook=${config.notebookName}&entryPoint=${config.entryPoint.result}${config.promisify ? '&promisify=true':''}">bundle.js</a>
  </script>
  <script id="501" type="application/vnd.observable.javascript">
    renderedCode = md`\`\`\`js
    ${code}
    \`\`\``
  </script>
  <script id="466" type="application/vnd.observable.javascript">
    viewof code = Inputs.input(undefined)
  </script>
  <script id="500" type="application/vnd.observable.javascript">
    generate = {
      const code = astring.generate(program);
      viewof code.value = code;
      viewof code.dispatchEvent(new Event("input", { bubbles: true }));
    }
  </script>
  <script id="303" type="application/vnd.observable.javascript">
    body = config.notebookName ? getNotebook(config.notebookName) : invalidation
  </script>
  <script id="19" type="application/vnd.observable.javascript">
    program = ({
      type: "Program",
      body: exports.flatMap((exp) => emitExpressions(exp, exp === entry))
    })
  </script>
  <script id="67" type="application/vnd.observable.javascript">
    cells = {
      if (body.length !== 3) throw new Error("no support for imports yet");
      const cells = 
        body[0].declarations[0].init.properties[1].value.elements;
      const cellMap = new Map();
      for (let cell of cells) {
        const name = getProperty(cell, "name");
        if (name) {
          cellMap.set(name.value.value, cell);
        }
      }
      return cellMap;
    }
  </script>
  <script id="450" type="application/vnd.observable.javascript">
    syncEntryPoints = {
      const options = [...cells.keys()];
      if (
        JSON.stringify(options) !==
        JSON.stringify(viewof config.value.entryPoint.options)
      ) {
        viewof config.value.entryPoint.options = [...cells.keys()];
        viewof config.dispatchEvent(new Event("input", { bubbles: true }));
      }
    }
  </script>
  <script id="297" type="application/vnd.observable.javascript" pinned="">
    entry = {
      let entry = cells.get(config.entryPoint.result);
      if (!entry) throw new Error("Entry not found");
      return entry;
    }
  </script>
  <script id="587" type="application/vnd.observable.javascript" pinned="">
    cells
  </script>
  <script id="617" type="application/vnd.observable.javascript" pinned="">
    parse = (src) =>
      acorn.parse(src, {
        ecmaVersion: 12,
        sourceType: "module"
      }).body
  </script>
  <script id="593" type="application/vnd.observable.javascript" pinned="">
    stdlib = ({
      // https://github.com/observablehq/stdlib/blob/main/src/library.js#L23
      require: {
        type: "source",
        value: `import {require as requireDefault_hCx5YD, requireFrom as requireFrom_hCx5YD} from 'https://cdn.skypack.dev/d3-require';
    const require = (resolve) => resolve == null ? requireDefault_hCx5YD : requireFrom_hCx5YD(resolve);
    `
      }
    })
  </script>
  <script id="106" type="application/vnd.observable.javascript" pinned="">
    exports = {
      let exported = new Set();
      let exports = [];

      // A depth-first search that aims to order
      // cells in dependency (topological) order, so that they
      // always have their dependencies defined before them.
      function crawlTree(cell) {
        if (exported.has(cell)) return;
        getInputs(cell).forEach((input) => {
          const cell = cells.get(input);
          if (cell === undefined && stdlib[input]) {
            if (exported.add(input + "_Bucw6S")) exports.push(stdlib[input]);
          } else if (cell === undefined) {
            throw Error(
              `Cannot find cell for input '${input}' with entry ${
                entry.start + ":" + entry.end
              }`
            );
          } else {
            crawlTree(cell);
          }
        });
        if (exported.add(cell)) exports.push(cell);
      }

      crawlTree(entry);

      return exports;
    }
  </script>
  <script id="157" type="application/vnd.observable.javascript" pinned="">
    function emitExpressions(cell, isEntry) {
      if (cell.type === "source") {
        return parse(cell.value);
      }
      const decl = {
        type: "VariableDeclaration",
        kind: "const",
        declarations: [
          {
            type: "VariableDeclarator",
            id: {
              type: "Identifier",
              name: getName(cell)
            },
            init: getValue(cell)
          }
        ]
      };
      if (isEntry) {
        return [
          {
            type: "ExportNamedDeclaration",
            declaration: decl
          }
        ];
      }
      return [decl];
    }
  </script>
  <script id="291" type="application/vnd.observable.javascript" pinned="">
    getValue = config.promisify ? getPromiseValue : getConstantValue
  </script>
  <script id="289" type="application/vnd.observable.javascript" pinned="">
    function getName(cell) {
      return getProperty(cell, "name").value.value;
    }
  </script>
  <script id="287" type="application/vnd.observable.javascript" pinned="">
    function getConstantValue(cell) {
      const value = getProperty(cell, "value").value;
      if (value.body.type === "BlockStatement"
          && value.body.body.length === 1
          && value.body.body[0].type === "ReturnStatement") {
        return value.body.body[0].argument;
      }
      return {
        type: "CallExpression",
        callee: {
          ...value,
          params: []
        }
      };
    }
  </script>
  <script id="285" type="application/vnd.observable.javascript" pinned="">
    function getPromiseValue(cell) {
      const value = getProperty(cell, "value").value;
      const inputs = getInputs(cell).map(name => ({type: "Identifier", name}));
      return {
        type: "CallExpression",
        callee: {
          type: "MemberExpression",
          object: inputs.length === 0
          ? {
              type: "CallExpression",
              callee: {
                type: "MemberExpression",
                object: {
                  type: "Identifier",
                  name: "Promise"
                },
                property: {
                  type: "Identifier",
                  name: "resolve"
                }
              },
              arguments: []
            } 
          : inputs.length === 1 ? inputs[0]
          : {
              type: "CallExpression",
              callee: {
                type: "MemberExpression",
                object: {
                  type: "Identifier",
                  name: "Promise"
                },
                property: {
                  type: "Identifier",
                  name: "all"
                }
              },
              arguments: [
                {
                  type: "ArrayExpression",
                  elements: inputs
                }
              ]
            },
          property: {
            type: "Identifier",
            name: "then"
          }
        },
        arguments: [
          {
            ...value,
            params: inputs.length > 1 
                ? [{type: "ArrayPattern", elements: value.params}] 
                : value.params
          }
        ]
      };
    }
  </script>
  <script id="88" type="application/vnd.observable.javascript" pinned="">
    function getInputs(cell) {
      const inputs = getProperty(cell, "inputs");
      if (!inputs) return [];
      return inputs.value.elements.map((e) => e.value);
    }
  </script>
  <script id="628" type="application/vnd.observable.javascript" pinned="">
    (
      await (
        await fetch(`https://api.observablehq.com/@tomlarkworthy/distiller.js`)
      ).text()
    ).substring(0, 1000)
  </script>
  <script id="74" type="application/vnd.observable.javascript" pinned="">
    async function getNotebook(name) {
      const src = await (
        await fetch(`https://api.observablehq.com/${name}.js`)
      ).text();
      try {
        return parse(src);
      } catch (err) {
        if (err instanceof SyntaxError) {
          const message =
            err.message +
            "\n" +
            src.split("\n")[err.loc.line - 1] +
            "\n" +
            Array.from({ length: err.loc.column - 1 })
              .fill(" ")
              .join("") +
            "^";

          throw new Error(message);
        }
        throw err;
      }
    }
  </script>
  <script id="275" type="application/vnd.observable.javascript" pinned="">
    getProperty = (cell, name) => {
      if (cell === undefined)
        throw new Error("Cannot getProperty for undefined cell");
      return cell.properties.find((p) => p.key.name === name);
    }
  </script>
  <script id="479" type="application/vnd.observable.javascript">
    viewof host = endpoint("default", async (req, res) => {
      const notebook = req.query.notebook;
      if (!notebook)
        return res.status(400).send("Please set notebook in URL params");
      const entryPoint = req.query.entryPoint;
      if (!entryPoint)
        return res.status(400).send("Please set entryPoint in URL params");
      const promisify = req.query.promisify || false;

      viewof config.value.notebookName = notebook;
      viewof config.value.entryPoint.options = [entryPoint];
      viewof config.value.entryPoint.result = entryPoint;
      viewof config.value.promisify = promisify;
      viewof config.dispatchEvent(new Event("input", { bubbles: true }));

      // Listen for code generation and send response
      viewof code.addEventListener("input", () => {
        res.header("content-type", "text/javascript"), res.send(viewof code.value);
      });
    })
  </script>
  <script id="8" type="application/vnd.observable.javascript">
    acorn = require("acorn")
  </script>
  <script id="132" type="application/vnd.observable.javascript">
    astring = import("astring")
  </script>
  <script id="421" type="application/vnd.observable.javascript">
    dynamicSelect = juice(Inputs.select, {
      label: "[1].label",
      options: "[0]", // "options" is first arg (index 0) of Inputs.select
      result: "[1].value" // "result" can be set in the options.value, options being the 2nd arg (index 0)
    })
  </script>
  <script id="399" type="application/vnd.observable.javascript">
    import { view, cautious } from "@tomlarkworthy/view"
  </script>
  <script id="417" type="application/vnd.observable.javascript">
    import { juice } from "@tomlarkworthy/juice"
  </script>
  <script id="476" type="application/vnd.observable.javascript">
    import { endpoint } from "@endpointservices/webcode"
  </script>
  <script id="679" type="application/vnd.observable.javascript" pinned="">
    import { installCopyCode } from "@tomlarkworthy/copy-code"
  </script>
  <script id="684" type="application/vnd.observable.javascript" pinned="">
    {
      renderedCode;
      [...document.querySelectorAll("pre")].forEach((el) =>
        installCopyCode(el, { invalidation })
      );
    }
  </script>
  <script id="692" type="application/vnd.observable.javascript">
    import { localStorageView } from "@tomlarkworthy/local-storage-view"
  </script>
  <script id="705" type="application/vnd.observable.javascript">
    import { footer } from "@endpointservices/footer-with-backups"
  </script>
  <script id="726" type="application/vnd.observable.javascript">
    footer
  </script>
</notebook>
