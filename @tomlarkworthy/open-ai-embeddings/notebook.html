<!doctype html>
<notebook theme="air">
  <title>Vector embeddings</title>
  <script id="0" type="text/markdown">
    # Vector embeddings

    ```js
    import {vectors} from '@tomlarkworthy/open-ai-embeddings'
    ```

    ```js
    vectors(inputs, { model, dimensions, cache })
    ```
    ### `vectors(inputs, { model, dimensions, cache })`

    Embeds an array of strings using OpenAIâ€™s embedding endpoint, automatically batching requests to stay within API limits.

    #### Parameters

    - `inputs` (`string | string[]`): Text(s) to embed. Accepts a single string or an array of strings.
    - `model` (`string`, optional): Embedding model name. Defaults to `viewof model.value`.
    - `dimensions` (`number`, optional): Number of dimensions for the embedding (if supported by the model).
    - `cache` (`Map<string, object>`, optional): Optional cache to store and reuse embeddings. Input strings are used as keys.


    #### Returns

    - `Promise<object[]>`: Resolves to an array of objects, one per input string. Each object includes:
      - `input`: the original input string
      - `object`: always `"embedding"`
      - `index`: position of the input in the request
      - `embedding`: an array of floats representing the vector embedding
  </script>
  <script id="87" type="application/vnd.observable.javascript">
    memoryCache = new Map()
  </script>
  <script id="107" type="text/markdown">
    ## Example
  </script>
  <script id="80" type="application/vnd.observable.javascript" pinned="">
    vectors(["a", "b"])
  </script>
  <script id="5" type="application/vnd.observable.javascript">
    viewof endpoint = Inputs.text({
      label: "embedding endpoint",
      value: "https://api.openai.com/v1/embeddings"
    })
  </script>
  <script id="24" type="application/vnd.observable.javascript">
    viewof model = Inputs.bind(
      Inputs.select(
        [
          "text-embedding-ada-002",
          "text-embedding-3-small",
          "text-embedding-3-large"
        ],
        {
          label: "model"
        }
      ),
      localStorageView("embedding", {
        defaultValue: "text-embedding-3-small"
      })
    )
  </script>
  <script id="12" type="application/vnd.observable.javascript">
    viewof OPENAI_API_KEY = Inputs.bind(
      Inputs.password({
        label: "OPENAI_API_KEY",
        placeholder: "paste openAI key here"
      }),
      localStorageView("OPENAI_API_KEY")
    )
  </script>
  <script id="50" type="application/vnd.observable.javascript">
    async function vectors(
      inputs,
      { dimensions, model = viewof model.value, cache = memoryCache } = {}
    ) {
      if (typeof inputs === "string") inputs = [inputs];

      const maxPerInput = 8192 * 6;
      const maxTotalTokens = 300_000;
      const maxBatchSize = 2048;

      const batches = [];
      let batch = [];
      let batchTokenCount = 0;

      const results = [];

      for (const item of inputs) {
        if (!item || typeof item !== "string") continue;
        if (cache?.has(item)) {
          results.push(cache.get(item));
          continue;
        }

        const tokenEstimate = Math.ceil(item.length / 6);
        if (tokenEstimate > 8192) continue;

        if (
          batch.length >= maxBatchSize ||
          batchTokenCount + tokenEstimate > maxTotalTokens
        ) {
          batches.push(batch);
          batch = [];
          batchTokenCount = 0;
        }

        batch.push(item);
        batchTokenCount += tokenEstimate;
      }

      if (batch.length) batches.push(batch);

      for (const b of batches) {
        const r = await vectorAPI(b, { model, dimensions });
        const arr = Array.isArray(r) ? r : [r];
        for (let i = 0; i < b.length; i++) {
          const item = b[i];
          const result = arr[i];
          if (cache) cache.set(item, result);
          results.push(result);
        }
      }

      return results;
    }
  </script>
  <script id="20" type="application/vnd.observable.javascript">
    async function vectorAPI(input, { model, dimensions} = {}) {
      const data = (
        await (
          await fetch(viewof endpoint.value, {
            method: "post",
            headers: {
              Authorization: `Bearer ${viewof OPENAI_API_KEY.value}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              input,
              model,
              dimensions,
              encoding_format: "float"
            })
          })
        ).json()
      ).data;

      return data.map((d, i) => ({
        input: input[i],
        ...d
      }));
    }
  </script>
  <script id="15" type="application/vnd.observable.javascript">
    import { localStorageView } from "@tomlarkworthy/local-storage-view"
  </script>
</notebook>
